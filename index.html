<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="自动笔记生成器">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="自动笔记生成器">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="0xSky">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>自动笔记生成器</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">自动笔记生成器</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/05/24/bouncycastle%E5%8C%85%E5%AE%9E%E7%8E%B0SM2%E5%AD%A6%E4%B9%A0%E7%AE%80%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/24/bouncycastle%E5%8C%85%E5%AE%9E%E7%8E%B0SM2%E5%AD%A6%E4%B9%A0%E7%AE%80%E8%AE%B0/" class="post-title-link" itemprop="url">bouncycastle包实现SM2学习简记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-24 19:29:11 / 修改时间：19:33:10" itemprop="dateCreated datePublished" datetime="2022-05-24T19:29:11+08:00">2022-05-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>近期有实现SM2加密验签的需要，一般不直接使用非对称加密直接对数据进行加密，效率不高，所以验签、签名是SM2的重要用途。<br>实验环境：jdk8，bouncycastle 1.59 -&gt;1.62（升级）<br>起先使用bouncycastle 1.59进行测试，在网上找了三个方案，其中有两个方案自己实现了SM2椭圆曲线，但是在阅读了文档并查看了bouncycastle源码后发现其实bouncycastle已经实现了SM2曲线，加解密，加签验签也都能直接使用</p>
<p><img src="/images/220524/bouncycastle_sm2/Image.png" alt=""></p>
<p>椭圆曲线已经实现</p>
<p><img src="/images/220524/bouncycastle_sm2/Image%20%5B1%5D.png" alt=""></p>
<p>引擎也已实现，默认C1C3C2模式，需要自行兼容</p>
<p>所以后续我只做了两件事：<br>1.调用bouncycastle实现加解密、加验签<br>2.进行兼容处理，处理头部03、04标记字节、处理C1C3C2密文排练（默认是C1C2C3）、兼容加签验签<br>加解密调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] encrypt(<span class="keyword">byte</span>[] in, BCECPublicKey publicKey, <span class="keyword">int</span> modeType) &#123;</span><br><span class="line">        <span class="comment">//加密模式</span></span><br><span class="line">        SM2Engine.Mode mode;</span><br><span class="line">        <span class="keyword">if</span> (modeType == <span class="number">1</span>) &#123;</span><br><span class="line">            mode = SM2Engine.Mode.C1C3C2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mode = SM2Engine.Mode.C1C2C3;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//通过公钥对象获取公钥的基本域参数。</span></span><br><span class="line">        ECParameterSpec ecParameterSpec = publicKey.getParameters();</span><br><span class="line">        ECDomainParameters ecDomainParameters = <span class="keyword">new</span> ECDomainParameters(ecParameterSpec.getCurve(),ecParameterSpec.getG(), ecParameterSpec.getN());</span><br><span class="line">        <span class="comment">//通过公钥值和公钥基本参数创建公钥参数对象</span></span><br><span class="line">        ECPublicKeyParameters ecPublicKeyParameters = <span class="keyword">new</span> ECPublicKeyParameters(publicKey.getQ(), ecDomainParameters);</span><br><span class="line">        <span class="comment">//根据加密模式实例化SM2公钥加密引擎</span></span><br><span class="line">        SM2Engine sm2Engine = <span class="keyword">new</span> SM2Engine(mode);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//初始化加密引擎</span></span><br><span class="line">            sm2Engine.init(<span class="keyword">true</span>, <span class="keyword">new</span> ParametersWithRandom(ecPublicKeyParameters, <span class="keyword">new</span> SecureRandom()));</span><br><span class="line">            <span class="keyword">byte</span>[] out = sm2Engine.processBlock(in,<span class="number">0</span>,in.length);</span><br><span class="line">            <span class="comment">// 兼容非bouncycastle库实现，头部没有标记</span></span><br><span class="line">            <span class="keyword">return</span> Arrays.copyOfRange(out,<span class="number">1</span>,out.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidCipherTextException e) &#123;</span><br><span class="line"><span class="comment">//            throw、LOG</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line"><span class="comment">//            throw、LOG</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] decrypt(<span class="keyword">byte</span>[] in, BCECPrivateKey privateKey,<span class="keyword">int</span> modeType) &#123;</span><br><span class="line">        <span class="comment">//解密模式</span></span><br><span class="line">        SM2Engine.Mode mode;</span><br><span class="line">        <span class="keyword">if</span> (modeType == <span class="number">1</span>) &#123;</span><br><span class="line">            mode = SM2Engine.Mode.C1C3C2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mode = SM2Engine.Mode.C1C2C3;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        兼容非BouncyCastle生成的密文，头部无04标记字节</span></span><br><span class="line">        <span class="keyword">if</span> (in[<span class="number">0</span>] != (<span class="keyword">byte</span>) <span class="number">0x04</span>) &#123;</span><br><span class="line">            in = insertElement(in,(<span class="keyword">byte</span>) <span class="number">0x04</span>,<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//通过私钥对象获取私钥的基本域参数。</span></span><br><span class="line">        ECParameterSpec ecParameterSpec = privateKey.getParameters();</span><br><span class="line">        ECDomainParameters ecDomainParameters = <span class="keyword">new</span> ECDomainParameters(ecParameterSpec.getCurve(),ecParameterSpec.getG(), ecParameterSpec.getN());</span><br><span class="line">        <span class="comment">//通过私钥值和私钥钥基本参数创建私钥参数对象</span></span><br><span class="line">        ECPrivateKeyParameters ecPrivateKeyParameters = <span class="keyword">new</span> ECPrivateKeyParameters(privateKey.getD(),ecDomainParameters);</span><br><span class="line">        <span class="comment">//通过解密模式创建解密引擎并初始化</span></span><br><span class="line">        SM2Engine sm2Engine = <span class="keyword">new</span> SM2Engine(mode);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sm2Engine.init(<span class="keyword">false</span>, ecPrivateKeyParameters);</span><br><span class="line">            <span class="keyword">return</span> sm2Engine.processBlock(in,<span class="number">0</span>,in.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidCipherTextException  e) &#123;</span><br><span class="line"><span class="comment">//            thorw、LOG</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line"><span class="comment">//            thorw、LOG</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>加签验签的逻辑这里就不放， 直接调用即可，与外部对接则需要做兼容处理。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/05/24/sonar-XML%E8%A7%84%E5%88%99%E5%AE%9E%E7%8E%B0%E5%B0%8F%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/24/sonar-XML%E8%A7%84%E5%88%99%E5%AE%9E%E7%8E%B0%E5%B0%8F%E8%AE%A1/" class="post-title-link" itemprop="url">sonar XML规则实现小计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-24 17:48:39 / 修改时间：17:56:53" itemprop="dateCreated datePublished" datetime="2022-05-24T17:48:39+08:00">2022-05-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>近期有个探测mybatis xml配置文件内不安全的占位符的规则需求，但是在sonar官方文档中看到官方已经放弃从Java直接支持xml规则了。</p>
<p><img src="/images/220524/sonar/Image.png" alt=""></p>
<p>但是，这并不意味着我们无法再编写XML的规则了，只是不能想编写针对Java的规则那样方便地增加规则了。<br>首先，官方任然支持插件，而XML规则本身也是插件，所以可以依葫芦画瓢照搬一个XML插件。这里我没有直接在官方插件上添加规则，虽然理论上这是最快的途径，但是修改官方的内置插件很麻烦也会给升级带来很大的问题，所以添加新插件是最优解。<br>首先访问官方插件示例和官方XML插件源代码：<br><a href="https://github.com/SonarSource/sonar-custom-plugin-example" target="_blank" rel="noopener">https://github.com/SonarSource/sonar-custom-plugin-example</a><br><a href="https://github.com/SonarSource/sonar-xml/tree/2.5.0.3376" target="_blank" rel="noopener">https://github.com/SonarSource/sonar-xml/tree/2.5.0.3376</a><br>有了Java插件的底子，我们知道插件是通过官方的Plugin接口定义的，所以先看官方示例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExamplePlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">define</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// tutorial on hooks</span></span><br><span class="line">    <span class="comment">// http://docs.sonarqube.org/display/DEV/Adding+Hooks</span></span><br><span class="line">    context.addExtensions(PostJobInScanner<span class="class">.<span class="keyword">class</span>, <span class="title">DisplayQualityGateStatus</span>.<span class="title">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tutorial on languages</span></span><br><span class="line">    context.addExtensions(FooLanguage<span class="class">.<span class="keyword">class</span>, <span class="title">FooQualityProfile</span>.<span class="title">class</span>)</span>;</span><br><span class="line">    context.addExtensions(FooLanguageProperties.getProperties());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tutorial on measures</span></span><br><span class="line">    context</span><br><span class="line">      .addExtensions(ExampleMetrics<span class="class">.<span class="keyword">class</span>, <span class="title">SetSizeOnFilesSensor</span>.<span class="title">class</span>, <span class="title">ComputeSizeAverage</span>.<span class="title">class</span>, <span class="title">ComputeSizeRating</span>.<span class="title">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tutorial on rules</span></span><br><span class="line">    context.addExtensions(JavaRulesDefinition<span class="class">.<span class="keyword">class</span>, <span class="title">CreateIssuesOnJavaFilesSensor</span>.<span class="title">class</span>)</span>;</span><br><span class="line">    context.addExtensions(FooLintRulesDefinition<span class="class">.<span class="keyword">class</span>, <span class="title">FooLintIssuesLoaderSensor</span>.<span class="title">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tutorial on settings</span></span><br><span class="line">    context</span><br><span class="line">      .addExtensions(HelloWorldProperties.getProperties())</span><br><span class="line">      .addExtension(SayHelloFromScanner<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tutorial on web extensions</span></span><br><span class="line">    context.addExtension(MyPluginPageDefinition<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到官方插件中有6个部分，首先Web部分我们直接忽略，用不着。<br>剩下五个部分分别是hooks、languages、measures、rules、settings首先setting是指Properties，包括内部配置定义，例如sonar Quality Profiles 中的默认配置，也是可以不添加的。<br>其次是languages，是指对语言的定义，这里我们要扫描的是XML，因为官方插件中已经定义了我们可以不定义，稍后再说。<br>然后hooks用于添加issue等操作，在官方插件没有发现这个定义，暂时略过。<br>接下来就是measures和rules，measures个人认为是用于对文件进行处理的扫描，官方插件中有一个measure是Sensor接口定义，暂略。<br>rules是我们具体的规则和定义类。</p>
<p>接下来我们通过官方XML插件进行比较：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.sonar.plugins.xml;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.sonar.api.Plugin;</span><br><span class="line"><span class="keyword">import</span> org.sonar.api.config.PropertyDefinition;</span><br><span class="line"><span class="keyword">import</span> org.sonar.api.resources.Qualifiers;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FILE_SUFFIXES_KEY = <span class="string">"sonar.xml.file.suffixes"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">define</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    context.addExtensions(</span><br><span class="line">      PropertyDefinition.builder(XmlPlugin.FILE_SUFFIXES_KEY)</span><br><span class="line">        .name(<span class="string">"File suffixes"</span>)</span><br><span class="line">        .description(<span class="string">"List of suffixes for XML files to analyze."</span>)</span><br><span class="line">        .defaultValue(<span class="string">".xml,.xsd,.xsl"</span>)</span><br><span class="line">        .multiValues(<span class="keyword">true</span>)</span><br><span class="line">        .category(<span class="string">"XML"</span>)</span><br><span class="line">        .onQualifiers(Qualifiers.PROJECT)</span><br><span class="line">        .build(),</span><br><span class="line">      Xml<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">      <span class="title">XmlRulesDefinition</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">      <span class="title">XmlSonarWayProfile</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">      <span class="title">XmlSensor</span>.<span class="title">class</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到官方XML插件胡总包含了languages、rules、settings、property定义，measures定义集中在了rules的XmlSensor中。<br>所以综合上述信息，拥有rules、property定义即可实现一个插件，其中rules需要包含规则定义和Sensor扫描器。<br>接下来我的实现思路是，照搬XmlSensor与其他定义，然后实现需要的rules即可，因为我需要的扫描器都是基于SonarXmlCheck基类，和官方插件完全一致，所以就不需要实现扫描器了，这里需要注意，对于搬来的类其注册名必须要和原有的有所区分，否则加载插件会报唯一性错误。</p>
<p>接下来只要实现规则并照搬扫描器即可，依赖也可以直接使用官方插件的依赖，非常便捷。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.sonar.api.utils.log.Logger;</span><br><span class="line"><span class="keyword">import</span> org.sonar.api.utils.log.Loggers;</span><br><span class="line"><span class="keyword">import</span> org.sonar.check.Rule;</span><br><span class="line"><span class="keyword">import</span> org.sonarsource.analyzer.commons.xml.XmlFile;</span><br><span class="line"><span class="keyword">import</span> org.sonarsource.analyzer.commons.xml.checks.SonarXmlCheck;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Rule</span>(key = <span class="string">"ZSecXMLMybatisSQLIRule"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZSecXMLMybatisSQLIRule</span> <span class="keyword">extends</span> <span class="title">SonarXmlCheck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = Loggers.get(ZSecXMLMybatisSQLIRule<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DTD_PUBLIC_ID = <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DTD_SYSTEM_ID = <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; SQL_METHOD_LIST = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        SQL_METHOD_LIST.add(<span class="string">"select"</span>);</span><br><span class="line">        SQL_METHOD_LIST.add(<span class="string">"insert"</span>);</span><br><span class="line">        SQL_METHOD_LIST.add(<span class="string">"update"</span>);</span><br><span class="line">        SQL_METHOD_LIST.add(<span class="string">"delete"</span>);</span><br><span class="line">        SQL_METHOD_LIST.add(<span class="string">"if"</span>);</span><br><span class="line">        SQL_METHOD_LIST.add(<span class="string">"sql"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String MYBATIS_SQL_MATCH = <span class="string">"\\$\\&#123;(\\d|\\w)+&#125;"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Pattern MYBATIS_SQL_MATCHER = Pattern.compile(MYBATIS_SQL_MATCH);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(XmlFile xmlFile)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!xmlFile.getDocument().getDoctype().getPublicId().equalsIgnoreCase(DTD_PUBLIC_ID)</span><br><span class="line">                    || !xmlFile.getDocument().getDoctype().getSystemId().equalsIgnoreCase(DTD_SYSTEM_ID)</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            visitNode(xmlFile.getDocument());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NullPointerException nullPointerException) &#123;</span><br><span class="line">            LOG.info(<span class="string">"Not mybatis xml file &#123;&#125;"</span>,xmlFile.getInputFile().uri(),nullPointerException);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">visitNode</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        List&lt;Node&gt; children = XmlFile.children(node);</span><br><span class="line">        <span class="keyword">if</span> (SQL_METHOD_LIST.contains(node.getNodeName().toLowerCase())) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node childrenNode:</span><br><span class="line">                 children) &#123;</span><br><span class="line">                <span class="keyword">if</span> (childrenNode.getNodeName().equalsIgnoreCase(<span class="string">"#text"</span>)) &#123;</span><br><span class="line">                    Matcher m = MYBATIS_SQL_MATCHER.matcher(childrenNode.getTextContent());</span><br><span class="line">                    <span class="keyword">if</span> (m.find()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (checkIsOrderBy(childrenNode)) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        reportIssue(childrenNode,<span class="string">"found dangerous sql!"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        children.forEach(<span class="keyword">this</span>::visitNode);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//    order by</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">checkIsOrderBy</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        String splitStr = <span class="string">"\\$\\&#123;"</span>;</span><br><span class="line">        String containsStr = <span class="string">"order by"</span>;</span><br><span class="line">        <span class="keyword">return</span> node.getTextContent().split(splitStr)[<span class="number">0</span>].toLowerCase().contains(containsStr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现规则并测试后打包即可完成此插件，本地测试后传入sonar进行扫描测试，可以成功探测到问题</p>
<p><img src="/images/220524/sonar/Image%20%5B1%5D.png" alt=""></p>
<p><img src="/images/220524/sonar/Image%20%5B2%5D.png" alt=""></p>
<p><img src="/images/220524/sonar/Image%20%5B3%5D.png" alt=""></p>
<p><img src="/images/220524/sonar/Image%20%5B4%5D.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/05/24/wifipumpkin3%E6%93%8D%E4%BD%9C%E5%B0%8F%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/24/wifipumpkin3%E6%93%8D%E4%BD%9C%E5%B0%8F%E8%AE%A1/" class="post-title-link" itemprop="url">wifipumpkin3操作小计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-24 17:37:32 / 修改时间：17:43:35" itemprop="dateCreated datePublished" datetime="2022-05-24T17:37:32+08:00">2022-05-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>使用 wifipumpkin3 进行一些wifi钓鱼预演实验<br>首先，因为无线网卡不直接支持Linux，所以根据型号找了个GitHub驱动进行安装</p>
<p><img src="/images/220524/wifipumpkin3/Image.png" alt=""></p>
<p><img src="/images/220524/wifipumpkin3/Image%20%5B1%5D.png" alt=""></p>
<p><a href="https://github.com/McMCCRU/rtl8188gu" target="_blank" rel="noopener">https://github.com/McMCCRU/rtl8188gu</a><br>期间报了几个错误，主要是因为kali中的依赖不完整，补全后安装完成<br>此时再使用ifconfig/iwconfig就可以看到网卡被识别了</p>
<p><img src="/images/220524/wifipumpkin3/Image%20%5B2%5D.png" alt=""></p>
<p>根据无线南瓜3的文档进行安装操作<a href="https://wifipumpkin3.github.io/docs/getting-started#usage" target="_blank" rel="noopener">https://wifipumpkin3.github.io/docs/getting-started#usage</a></p>
<p>由于在kali中进行，所以根据kali分类进行操作安装</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install libssl-dev libffi-dev build-essential</span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/P0cL4bs/wifipumpkin3.git</span><br><span class="line">$ <span class="built_in">cd</span> wifipumpkin3</span><br></pre></td></tr></table></figure>

<p>安装 PyQt5</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo apt install python3-pyqt5</span></span><br></pre></td></tr></table></figure>

<p>依赖安装完成后安装无线南瓜3</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo python3 setup.py install</span></span><br></pre></td></tr></table></figure>

<p>安装完成后控制台输入wifipumpkin3即可启动</p>
<p><img src="/images/220524/wifipumpkin3/Image%20%5B3%5D.png" alt=""></p>
<p>简单设置即可启动一个简单的钓鱼wifi监听</p>
<p><img src="/images/220524/wifipumpkin3/Image%20%5B4%5D.png" alt=""></p>
<p>客户端连接后即可查看日志信息</p>
<p><img src="/images/220524/wifipumpkin3/Image%20%5B5%5D.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/05/24/mysql%E6%97%A5%E6%9C%9F%E6%9F%A5%E8%AF%A2%E8%B8%A9%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/24/mysql%E6%97%A5%E6%9C%9F%E6%9F%A5%E8%AF%A2%E8%B8%A9%E5%9D%91/" class="post-title-link" itemprop="url">mysql日期查询踩坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-24 17:31:45 / 修改时间：17:35:08" itemprop="dateCreated datePublished" datetime="2022-05-24T17:31:45+08:00">2022-05-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>某次在执行一个查询时发现一个现象，当条件限定查询某个日期到某个日期之间的结果，如果存在这样一种记录<br>记录0 日期2022-01-01<br>记录1 日期2022-01-04<br>记录2 日期2022-01-02<br>记录3 日期2022-01-03<br>记录4 日期2022-01-05<br>如果日期条件是大于2022-01-02 小于2022-01-06 会将记录1-5全部查询出来，简单来说就是没有逐条比较，而是将符合的头尾全部取出</p>
<p><img src="/images/220524/mysql/Image.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/15/log4j2%E6%BC%8F%E6%B4%9E%E7%AE%80%E5%8D%95%E5%B0%8F%E8%AE%A1-ZCY%E6%8A%95%E7%A8%BF%E7%89%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/15/log4j2%E6%BC%8F%E6%B4%9E%E7%AE%80%E5%8D%95%E5%B0%8F%E8%AE%A1-ZCY%E6%8A%95%E7%A8%BF%E7%89%88/" class="post-title-link" itemprop="url">log4j2漏洞简单小计_ZCY投稿版</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-15 16:11:04" itemprop="dateCreated datePublished" datetime="2021-12-15T16:11:04+08:00">2021-12-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-24 17:26:39" itemprop="dateModified" datetime="2022-05-24T17:26:39+08:00">2022-05-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>log4j2 核弹级漏洞最近被公开了。log4j2 作为 log4j 的替代者，有着非常广泛的使用。因为几乎没有利用条件的限制，漏洞公开带来的影响极大。甚至于将无线耳机的名字改成漏洞利用代码都能在意想不到的服务中触发漏洞，许许多多技术员也是因此一夜无眠。</p>
<h4 id="影响求证"><a href="#影响求证" class="headerlink" title="影响求证"></a>影响求证</h4><p>在漏洞公开的伊始，许多漏洞通告都提到只要存在 log4j-api、log4j-core 依赖就会被影响。</p>
<p>如果我们新建一个 Spring Boot 项目，在引入 spring-boot-starter 依赖时默认会引入 spring-boot-starter-logging，而其中包含 log4j 的依赖包，那 Spring Boot 不是默认受影响？非也， Spring Boot 实际上默认使用 logback 进行日志实现，slf4j 进行抽象层管理，所以，默认情况下并不受影响。</p>
<p>只看依赖判断是否受影响的做法是有些不严谨的，许多通告方都没有仔细求证，为了验证，我用测试项目来试一下。</p>
<p>写一个会将输入写入日志的接口：</p>
<p><img src="/images/211210/Image%20.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B1%5D.png" alt=""></p>
<p>访问一下，日志写入。</p>
<p><img src="/images/211210/Image%20%5B2%5D.png" alt=""></p>
<p>接下来下断点看是什么日志组件进行了处理，跟踪断点，可以看到是 logback 对日志进行了处理：</p>
<p><img src="/images/211210/Image%20%5B3%5D.png" alt=""></p>
<p>log4j 和 logback 都会被 spring-boot-starter-logging 组件默认引入，但 Spring Boot 默认会使用 logback 进行日志的实际输出。所以，虽然 Spring Boot 默认引入了 log4j 但并不受影响。</p>
<p>因此，网上部分文章说的引入依赖就算被影响实际上是不准确、不严谨的。虽然这样写可以吸引眼球，引起重视，但是也对漏洞影响排查造成了干扰，并不可取。</p>
<p>作为技术从业者，我们不要听风就是雨，对于漏洞应小心求证，细心排查，严谨处理。当然这个漏洞的影响还是极其巨大的，作为一种软件的”基础设施“，有许多的组件都使用了它作为日志实现，例如 es、Struts2、Solr 等等众多组件与服务。</p>
<p>再补上一个受影响的 log4j 进行日志记录，手动使用 log4j 处理日志，这样就由 log4j 进行日志处理了：</p>
<p><img src="/images/211210/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B5%5D.png" alt=""></p>
<h4 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h4><p>网络上流传最广的是使用 JNDI 进行 LDAP DNS 查询来确定是否受漏洞影响的 PoC（${jndi:ldap://dnslog/xxx}），根据这个 PoC 我们可以简单判定是因为 JNDI LDAP 查询远程 class 并进行加载造成了攻击。</p>
<p>这个漏洞实际上是官方支持的一种功能，官方支持在日志设置时使用 ${xxx} 进行动态设置（<a href="https://logging.apache.org/log4j/2.x/manual/lookups.html" target="_blank" rel="noopener">官网描述</a>），并且支持日志输出时使用如 log.info(“${sys:java.version}) 动态获取并输出一些内容。而后面这个功能也支持 JNDI 协议，所以暴露在了 JNDI 注入攻击（JNDI 远程类加载攻击）之中。</p>
<p>这里简单介绍一下这种攻击，JNDI 全称为 Java Naming and Directory Interface，是一种类似于索引中心的API功能，可以用于实现动态配置的功能。当代码中 jndiName 变量可控时，发起查询的客户端就会从服务端加载远程 class 文件，最终导致命令执行。</p>
<p>JNDI LDAP 注入攻击的过程简单来说就是：攻击者发送恶意 JNDI  LDAP 查询——被攻击服务接受并发起查询——从恶意 JNDI 服务上下载 class ——本地加载 class ——触发 class 中预置的恶意代码。</p>
<p>JAVA 官方对这个问题进行过修复，从 JAVA 1.8_191 起默认不信任远程 codebase，即远程 class 文件不会被自动加载，所以在 JAVA 1.8_191 及以后只能从本地 class 文件加载。<br>更多的详情在<a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank" rel="noopener">blackhat议题</a>中有更加详细的描述。</p>
<h4 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h4><p>为了方便测试复现漏洞可以使用低版本 JAVA 环境来测试，这里我使用过低于 JAVA 1.8_191 的版本测试。</p>
<p>最初使用 JNDI-Injection-Exploit 与 marshalsec（这两款测试工具都有 LDAP 服务功能，可以在 GItHub 找到）生成弹出计算器 PoC 进行测试时没有成功。简单跟踪代码断点后，我发现如果直接使用 logger 对象后只引入了 log4j-api 组件，实际日志在 slf4j 处理后实际上被 logback 输出了，并没有使用 log4j 进行输出。</p>
<p>这里也侧面说明了项目中有 log4j-api 依赖就被漏洞影响的说法也是不准确的，必须要有 log4j-core 依赖，因为触发漏洞的代码实际在这个组件包中，在排查受影响服务时也应该以 log4j-core 依赖为准，下文中会有体现。</p>
<p>继续测试，先排除原有的 spring-boot-starter-logging 依赖，测试项目是在 spring-boot-starter-web 组件的 spring-boot-starter 依赖组件中引入了 spring-boot-starter-logging ，所以要此组件引入处的 pom 配置处排除 spring-boot-starter-logging。</p>
<p>之后直接按照 IDE 的提示引入 log4j-api，这时进行测试会报错，提示我们需要引入 log4j-core。</p>
<p><img src="/images/211210/Image%20%5B6%5D.png" alt=""></p>
<p>引入 log4j-core 依赖后再执行日志记录动作，触发了 LDAP 查询动作，弹出计算器。</p>
<p><img src="/images/211210/Image%20%5B7%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B8%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B9%5D.png" alt=""></p>
<h4 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h4><p>按照惯例先贴一下调用栈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">c_lookup:<span class="number">1017</span>, LdapCtx (com.sun.jndi.ldap)</span><br><span class="line">p_lookup:<span class="number">542</span>, ComponentContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">177</span>, PartialCompositeContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">205</span>, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:<span class="number">94</span>, ldapURLContext (com.sun.jndi.url.ldap)</span><br><span class="line">lookup:<span class="number">417</span>, InitialContext (javax.naming)</span><br><span class="line">lookup:<span class="number">172</span>, JndiManager (org.apache.logging.log4j.core.net)</span><br><span class="line">lookup:<span class="number">56</span>, JndiLookup (org.apache.logging.log4j.core.lookup)</span><br><span class="line">lookup:<span class="number">223</span>, Interpolator (org.apache.logging.log4j.core.lookup)</span><br><span class="line">resolveVariable:<span class="number">1116</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">1038</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">912</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">replace:<span class="number">467</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">format:<span class="number">132</span>, MessagePatternConverter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">format:<span class="number">38</span>, PatternFormatter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">toSerializable:<span class="number">345</span>, PatternLayout$PatternSerializer (org.apache.logging.log4j.core.layout)</span><br><span class="line">toText:<span class="number">244</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">encode:<span class="number">229</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">encode:<span class="number">59</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">directEncodeEvent:<span class="number">197</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">tryAppend:<span class="number">190</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">append:<span class="number">181</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">tryCallAppender:<span class="number">156</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppender0:<span class="number">129</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppenderPreventRecursion:<span class="number">120</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppender:<span class="number">84</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppenders:<span class="number">543</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">processLogEvent:<span class="number">502</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">485</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">460</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">82</span>, AwaitCompletionReliabilityStrategy (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">161</span>, Logger (org.apache.logging.log4j.core)</span><br><span class="line">tryLogMessage:<span class="number">2198</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessageTrackRecursion:<span class="number">2152</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessageSafely:<span class="number">2135</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessage:<span class="number">2011</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logIfEnabled:<span class="number">1983</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">error:<span class="number">740</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logTest:<span class="number">13</span>, LogTest (com.examplespring.demo.controller)</span><br><span class="line">LogTest:<span class="number">14</span>, TestController (com.examplespring.demo.controller)</span><br></pre></td></tr></table></figure>

<p>在调用栈里我们可以看到关键的几个动作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lookup:<span class="number">172</span>, JndiManager (org.apache.logging.log4j.core.net)</span><br><span class="line">lookup:<span class="number">56</span>, JndiLookup (org.apache.logging.log4j.core.lookup)</span><br><span class="line">lookup:<span class="number">223</span>, Interpolator (org.apache.logging.log4j.core.lookup)</span><br><span class="line">resolveVariable:<span class="number">1116</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">1038</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">912</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">replace:<span class="number">467</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">format:<span class="number">132</span>, MessagePatternConverter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">format:<span class="number">38</span>, PatternFormatter (org.apache.logging.log4j.core.pattern)</span><br></pre></td></tr></table></figure>

<p>这几个漏洞触发的关键动作都在 log4j-core 依赖中，也印证了前面说的有 log4j-api 依赖就有问题是不准确的，实际上修复漏洞首先需要关注 log4j-core 依赖。</p>
<p>从 toText 这个函数开始跟进，这里开始转化 event 内容进行输出。</p>
<p><img src="/images/211210/Image%20%5B10%5D.png" alt=""></p>
<p> toSerializable 函数遍历使用 PatternFormatter 对 event 进行格式化。</p>
<p><img src="/images/211210/Image%20%5B11%5D.png" alt=""></p>
<p>在第15个 PatternFormatter —— MessagePatternConverter 进行操作时，event 中如果有 ${ 就会进行替换。</p>
<p><img src="/images/211210/Image%20%5B12%5D.png" alt=""></p>
<p>这里打个岔，可以看到进入替换逻辑有 noLookups 为 false 的前提，所以这里就有了临时修复方案——将这个变量设置为 true，而这个变量就是 <em>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</em> 常量，来源于从配置中查找 log4j2.formatMsgNoLookups 的值，如果不配置则其默认值为 false。</p>
<p><img src="/images/211210/Image%20%5B13%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B14%5D.png" alt=""></p>
<p>言归正传，后续调用 substitute 递归解析文本中的变量值，注释中也有说明。</p>
<p><img src="/images/211210/Image%20%5B15%5D.png" alt=""></p>
<p>resolveVariable 进行具体的变量解析，后续就是 lookup 调用，在这里 jndiName 已经被输入完全控制。最终调用了 JAVA 的 lookup，所以也受 JAVA 环境限制。</p>
<p><img src="/images/211210/Image%20%5B16%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B17%5D.png" alt=""></p>
<p>上述的操作在 JAVA 1.8_191 前因为默认信任外部 codebase 是可以进行的，在 JAVA 1.8_191 后不再信任外部 codebase 所以使用外部类不再可行，许多的通告中都提到了这一点。但是本地存在的类还是可以利用的，而 Spring Boot 默认带有 tomcat 依赖，可以通过这种类似的本地类执行代码，还是比较容易利用的，可以参考<a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">Exploiting JNDI Injections in Java</a>和<a href="https://skysliently.github.io/2021/03/23/dubbo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE-2020-1948%EF%BC%89%E5%8F%AF%E7%94%A8%E9%93%BE%E8%B7%AF%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">dubbo反序列化（CVE-2020-1948）可用链路学习</a>中的利用。</p>
<h4 id="临时措施"><a href="#临时措施" class="headerlink" title="临时措施"></a>临时措施</h4><p>根据前文内容我们可以简单得出一些临时解决方式</p>
<ul>
<li>设置 jvm 启动参数 “-Dlog4j2.formatMsgNoLookups=true”（先升级到2.10+）</li>
<li>在添加额外的 log4j2.component.properties 配置文件，增加“log4j2.formatMsgNoLookups=True”配置（同上）</li>
</ul>
<p>使用临时方案后可以在应用启动后打印 org.apache.logging.log4j.core.util.Constants.<em>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</em> 参数，如果是 true 就已经关闭了 Message lookup 功能。</p>
<p>另外，高版本的JAVA环境也能增加利用难度，但不能作为临时修复方案！不能作为临时修复方案！不能作为临时修复方案！重要的事情说三遍。</p>
<p>顺便吐槽一下网上部分的临时修复措施都提到了添加 “log4j2.formatMsgNoLookups=True” 配置的方案，但没说到底在哪里添加。我设置了 application.properties 和 log4j2.properties 都没有效果，最后在代码里面才找到需要设置的是 log4j2.component.properties 配置文件。</p>
<p><img src="/images/211210/Image%20%5B18%5D.png" alt=""></p>
<h4 id="官方修复"><a href="#官方修复" class="headerlink" title="官方修复"></a>官方修复</h4><p>官方在漏洞公开前发布了 <a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc1" target="_blank" rel="noopener">log4j-2.15.0-rc1</a> 预览版对此问题进行了修复，然而很快就爆出可以利用路径空格报错跳过处理流程直接触发 lookup 查询，而后官方又发布了 <a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.0-rc2" target="_blank" rel="noopener">log4j-2.15.0-rc2 </a>修复这个问题，并以 <a href="https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.15.0" target="_blank" rel="noopener">rel/2.15.0</a> 发布正式版。</p>
<p>但此事并未告一段落，在后续几天中官方又发布了 <a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.15.1-rc1" target="_blank" rel="noopener">log4j-2.15.1-rc1</a> 预览版，默认关闭 JNDI。</p>
<p><img src="/images/211210/Image%20%5B19%5D.png" alt=""></p>
<p>接下来在 <a href="https://github.com/apache/logging-log4j2/releases/tag/log4j-2.16.0-rc1" target="_blank" rel="noopener">log4j-2.16.0-rc1</a> 中又直接去掉了 Message 的 lookup 查询功能。</p>
<p><img src="/images/211210/Image%20%5B20%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B21%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B22%5D.png" alt=""></p>
<p>截止到纂稿时，<a href="https://github.com/apache/logging-log4j2/releases/tag/rel%2F2.16.0" target="_blank" rel="noopener">rel/2.16.0</a> 正式版已经发布，Message 的 lookup 功能已经被去除。</p>
<h4 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h4><p>随着 2.16.0 正式版发布，漏洞的官方修复工作应该是告一段落了，但是技术猿们的工作远未结束。自己的项目依赖可以直接修改，但许多组件的依赖更新还需要相应的组件官方团队对其进行更新测试并发布安全版本，漏洞修复之路远未结束，在依赖库中的旧版本没有被完全消灭之前，防御设备的告警依然紧扣技术猿们的心弦，让人宛如惊弓之鸟。</p>
<p>谨以此文祭奠广大技术猿逝去与即将逝去的烦恼丝 :) 。21.12.13</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/10/log4j2%E6%BC%8F%E6%B4%9E%E7%AE%80%E5%8D%95%E5%B0%8F%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/10/log4j2%E6%BC%8F%E6%B4%9E%E7%AE%80%E5%8D%95%E5%B0%8F%E8%AE%A1/" class="post-title-link" itemprop="url">log4j2漏洞简单小计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-12-10 18:39:46 / 修改时间：19:06:24" itemprop="dateCreated datePublished" datetime="2021-12-10T18:39:46+08:00">2021-12-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>log4j核弹级漏洞最近被公开了，看了下spring默认会引入log4j的依赖包，许多提高都说只要存在log4j-api、log4j-core就会被影响，那spring岂不是默认受影响，但是spring实际默认使用logback进行日志实现，slf4j进行抽象层管理，所以只看依赖判断是否受影响有些不严谨，这里用测试项目来试一下。</p>
<p>写一个会将输入写入日志的接口。</p>
<p><img src="/images/211210/Image%20.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B1%5D.png" alt=""></p>
<p>访问一下，日志写入。</p>
<p><img src="/images/211210/Image%20%5B2%5D.png" alt=""></p>
<p>接下来下断点看是什么日志组件进行了处理，可以看到是logback对日志进行了处理。</p>
<p><img src="/images/211210/Image%20%5B3%5D.png" alt=""></p>
<p>所以网上引入依赖就算被影响实际上是不准确的描述，log4j和logback会被spring boot log组件默认引入，但spring默认会使用logback。不要听风就是雨。<br>再补上一个受影响的log4j进行日志记录，这里就由log4j进行日志处理了。</p>
<p><img src="/images/211210/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B5%5D.png" alt=""></p>
<p>只是简单复现问题的话可以使用低版本java环境来测试，我使用JNDI-Injection-Exploit生成POC验证了下没有成功，又尝试用marshalsec生成，也没有成功。<br>简单跟了下代码断点发现我直接使用springboot后只引入了log4j-api组件，实际日志在slf4j抽象后被logback实际输出了，闹了个乌龙。所以先排除原有的spring-boot-starter-logging依赖，测试项目是在spring-boot-starter-web组件的spring-boot-starter依赖组件这种引入了logging，所以要此组件引入处排除spring-boot-starter-logging。<br>之后直接按照IDE的提示引入log4j-api，这时进行测试会报错，提示我们需要引入log4j-core，所以有log4j-api就被影响的说法也是不准确的，必须要有log4j-core因为触发漏洞的代码实际在这个组件包中。</p>
<p><img src="/images/211210/Image%20%5B6%5D.png" alt=""></p>
<p>引入包后再执行日志记录动作，触发了ldap查询动作，弹出计算器。</p>
<p><img src="/images/211210/Image%20%5B7%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B8%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B9%5D.png" alt=""></p>
<h4 id="具体分析"><a href="#具体分析" class="headerlink" title="具体分析"></a>具体分析</h4><p>按照惯例贴一下调用栈</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">c_lookup:<span class="number">1017</span>, LdapCtx (com.sun.jndi.ldap)</span><br><span class="line">p_lookup:<span class="number">542</span>, ComponentContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">177</span>, PartialCompositeContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:<span class="number">205</span>, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:<span class="number">94</span>, ldapURLContext (com.sun.jndi.url.ldap)</span><br><span class="line">lookup:<span class="number">417</span>, InitialContext (javax.naming)</span><br><span class="line">lookup:<span class="number">172</span>, JndiManager (org.apache.logging.log4j.core.net)</span><br><span class="line">lookup:<span class="number">56</span>, JndiLookup (org.apache.logging.log4j.core.lookup)</span><br><span class="line">lookup:<span class="number">223</span>, Interpolator (org.apache.logging.log4j.core.lookup)</span><br><span class="line">resolveVariable:<span class="number">1116</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">1038</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">substitute:<span class="number">912</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">replace:<span class="number">467</span>, StrSubstitutor (org.apache.logging.log4j.core.lookup)</span><br><span class="line">format:<span class="number">132</span>, MessagePatternConverter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">format:<span class="number">38</span>, PatternFormatter (org.apache.logging.log4j.core.pattern)</span><br><span class="line">toSerializable:<span class="number">345</span>, PatternLayout$PatternSerializer (org.apache.logging.log4j.core.layout)</span><br><span class="line">toText:<span class="number">244</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">encode:<span class="number">229</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">encode:<span class="number">59</span>, PatternLayout (org.apache.logging.log4j.core.layout)</span><br><span class="line">directEncodeEvent:<span class="number">197</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">tryAppend:<span class="number">190</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">append:<span class="number">181</span>, AbstractOutputStreamAppender (org.apache.logging.log4j.core.appender)</span><br><span class="line">tryCallAppender:<span class="number">156</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppender0:<span class="number">129</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppenderPreventRecursion:<span class="number">120</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppender:<span class="number">84</span>, AppenderControl (org.apache.logging.log4j.core.config)</span><br><span class="line">callAppenders:<span class="number">543</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">processLogEvent:<span class="number">502</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">485</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">460</span>, LoggerConfig (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">82</span>, AwaitCompletionReliabilityStrategy (org.apache.logging.log4j.core.config)</span><br><span class="line">log:<span class="number">161</span>, Logger (org.apache.logging.log4j.core)</span><br><span class="line">tryLogMessage:<span class="number">2198</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessageTrackRecursion:<span class="number">2152</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessageSafely:<span class="number">2135</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logMessage:<span class="number">2011</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logIfEnabled:<span class="number">1983</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">error:<span class="number">740</span>, AbstractLogger (org.apache.logging.log4j.spi)</span><br><span class="line">logTest:<span class="number">13</span>, LogTest (com.examplespring.demo.controller)</span><br><span class="line">LogTest:<span class="number">14</span>, TestController (com.examplespring.demo.controller)</span><br></pre></td></tr></table></figure>

<p>在调用栈里我们可以看到关键的几个动作：<br>lookup:172, JndiManager (<a href="http://org.apache.logging.log4j.core.net/" target="_blank" rel="noopener">org.apache.logging.log4j.core.net</a>)<br>lookup:56, JndiLookup (org.apache.logging.log4j.core.lookup)<br>lookup:223, Interpolator (org.apache.logging.log4j.core.lookup)<br>resolveVariable:1116, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>substitute:1038, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>substitute:912, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>replace:467, StrSubstitutor (org.apache.logging.log4j.core.lookup)<br>format:132, MessagePatternConverter (org.apache.logging.log4j.core.pattern)<br>format:38, PatternFormatter (org.apache.logging.log4j.core.pattern)<br>这几个动作都在log4j-core组件包中，也印证了前面说的有log4j-api就有问题，实际上修复漏洞首要需要关注log4j-core包。</p>
<p>从toText这个函数开始跟进，这里开始转化event内容进行输出。</p>
<p><img src="/images/211210/Image%20%5B10%5D.png" alt=""></p>
<p> toSerializable函数遍历使用PatternFormatter对event进行格式化。</p>
<p><img src="/images/211210/Image%20%5B11%5D.png" alt=""></p>
<p>在第15个PatternFormatter——MessagePatternConverter进行操作时，event中如果有${就会进行替换。</p>
<p><img src="/images/211210/Image%20%5B12%5D.png" alt=""></p>
<p>这里打个岔，可以看到进入替换逻辑有noLookups为false的前提，所以这里就有了临时修复方案将这个变量设置为true，而这个变量就是<em>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</em>常量，来源于从配置中查找log4j2.formatMsgNoLookups的值，默认为false。</p>
<p><img src="/images/211210/Image%20%5B13%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B14%5D.png" alt=""></p>
<p>言归正传，后续调用substitute递归解析文本中的变量值，注释中也有说明。</p>
<p><img src="/images/211210/Image%20%5B15%5D.png" alt=""></p>
<p>resolveVariable进行具体的变量解析，后续就是lookup调用，最终调用java的lookup，所以也受java环境限制。</p>
<p><img src="/images/211210/Image%20%5B16%5D.png" alt=""></p>
<p><img src="/images/211210/Image%20%5B17%5D.png" alt=""></p>
<p>在高版本的java环境中可以参考采用tomcat-embed执行代码，是比较容易利用的，后续会尝试将POC改造进行尝试，也可以参考<a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">Exploiting JNDI Injections in Java</a>和<a href="https://skysliently.github.io/2021/03/23/dubbo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE-2020-1948%EF%BC%89%E5%8F%AF%E7%94%A8%E9%93%BE%E8%B7%AF%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">dubbo反序列化（CVE-2020-1948）可用链路学习</a>一文。</p>
<h4 id="临时修补措施"><a href="#临时修补措施" class="headerlink" title="临时修补措施"></a>临时修补措施</h4><p>根据前文内容我们可以简单得出一些临时解决方式，当然这是牺牲了原本的功能</p>
<p>设置 jvm 启动参数 “-Dlog4j2.formatMsgNoLookups=true”（先升级到2.10+）<br>在添加额外的log4j2.component.properties配置文件，增加“log4j2.formatMsgNoLookups=True”配置（同上）<br>高版本的java环境也能增加利用难度</p>
<p>使用临时方案后可以在应用启动后打印org.apache.logging.log4j.core.util.Constants.<em>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</em>参数，是true就关闭了lookup功能。</p>
<p>顺便吐槽一下网上的修复方案一开始都没说到底在哪里加“log4j2.formatMsgNoLookups=True”配置，我设置了application.properties和log4j2.properties都没有效果，最后在代码里面找到是log4j2.component.properties配置文件。</p>
<p><img src="/images/211210/Image%20%5B18%5D.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/03/sonar%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E5%85%A5%E9%97%A8%E9%9A%8F%E8%AE%B0-XML/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/03/sonar%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E5%85%A5%E9%97%A8%E9%9A%8F%E8%AE%B0-XML/" class="post-title-link" itemprop="url">sonar自定义规则入门随记-XML</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-12-03 16:51:07 / 修改时间：16:57:17" itemprop="dateCreated datePublished" datetime="2021-12-03T16:51:07+08:00">2021-12-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上篇简叙述了sonar 自定义Java规则，但是在Java项目中不只有Java代码，XML也很常见，这片就来讨论有关XML扫描的入门学习，目标是检测mybatis的配置文件。</p>
<p>首先和Java应用需要实现一个扫描器类，Java是JavaFileScanner而XML则是SonarXmlCheck，这里我选择sonar其他的开源项目中的sonar-xml，通过这个项目中已经实现的规则来学习，这也是一个Java实现的规则项目。首先克隆代码导入IDE，注意项目版本根据sonar安装的插件版本来选择，在sonar规则库中 找一条有关XML的规则，通过描述信息在源代码中找到这条规则。</p>
<p><img src="/images/211203/Image%20.png" alt=""></p>
<p><img src="/images/211203/Image%20%5B1%5D.png" alt=""></p>
<p>我选择了LineLengthCheck和TodoCommentCheck两个规则来学习，先看TodoCommentCheck，这个规则用来检测XML中的TODO内容，我们看一下它的测试文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!--todo--&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">foo</span>&gt;</span> todo <span class="tag">&lt;/<span class="name">foo</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!----&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 &#123;&#123;Complete the task associated to this "TODO" comment.&#125;&#125; --&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- TODO --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  ^^^^^^^^^^^^^ --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- todo --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- myTodo --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- toDo explanation --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- [TODO] --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- Noncompliant@+1 --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- todo.txt false positive --&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- TodoNot --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试文件指出了需要被检测的TODO标记位置，再看规则本身</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span>(key = TodoCommentCheck.RULE_KEY)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TodoCommentCheck</span> <span class="keyword">extends</span> <span class="title">CommentContainsPatternChecker</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RULE_KEY = <span class="string">"S1135"</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATTERN = <span class="string">"TODO"</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MESSAGE = <span class="string">"Complete the task associated to this \"TODO\" comment."</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TodoCommentCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(PATTERN, MESSAGE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到只是直接调用了父类的构造方法，检测功能实际上由父类CommentContainsPatternChecker实现，其代码如下，是一个抽象类。主要的检测函数是checkIfCommentContainsPattern</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CommentContainsPatternChecker</span> <span class="keyword">extends</span> <span class="title">SimpleXPathBasedCheck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String pattern;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String message;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> XPathExpression xPathExpression = getXPathExpression(<span class="string">"//comment()"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">CommentContainsPatternChecker</span><span class="params">(String pattern, String message)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.pattern = pattern.toLowerCase(Locale.ENGLISH);</span><br><span class="line">    <span class="keyword">this</span>.message = message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(XmlFile file)</span> </span>&#123;</span><br><span class="line">    checkIfCommentContainsPattern(file);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLetterAround</span><span class="params">(String line, String pattern)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> start = line.indexOf(pattern);</span><br><span class="line">    <span class="keyword">int</span> end = start + pattern.length();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> pre = start &gt; <span class="number">0</span> &amp;&amp; Character.isLetter(line.charAt(start - <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">boolean</span> post = end &lt; line.length() - <span class="number">1</span> &amp;&amp; Character.isLetter(line.charAt(end));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pre || post;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkIfCommentContainsPattern</span><span class="params">(XmlFile file)</span> </span>&#123;</span><br><span class="line">    evaluateAsList(xPathExpression, file.getDocument()).forEach(node -&gt; &#123;</span><br><span class="line">      String comment = node.getNodeValue().toLowerCase(Locale.ENGLISH);</span><br><span class="line">      <span class="keyword">if</span> (comment.contains(pattern) &amp;&amp; !isLetterAround(comment, pattern)) &#123;</span><br><span class="line">        reportIssue(node, message);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数会将文件以Xpath解析后形成ArrayList</p>
<p><img src="/images/211203/Image%20%5B2%5D.png" alt=""></p>
<p>然后再循环遍历列表中的元素执行检测逻辑</p>
<p>这里仿照此逻辑读取一个XML文件尝试一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XMLMybatisSQLIRule</span> <span class="keyword">extends</span> <span class="title">SimpleXPathBasedCheck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> XPathExpression xPathExpression = getXPathExpression(<span class="string">"//comment()"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(XmlFile xmlFile)</span> </span>&#123;</span><br><span class="line">        evaluateAsList(xPathExpression, xmlFile.getDocument()).forEach(node -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="number">0</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写个测试，运行报错</p>
<p><img src="/images/211203/Image%20%5B3%5D.png" alt=""></p>
<p>在sonar-xml-plugin中找到对应依赖，注意补齐版本，和sonar-analyzer-commons版本一致即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.sonarsource.analyzer-commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sonar-analyzer-test-commons<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>依然报错，发现是不同版本的，其中的包路径不一致，手动在pom里加上保证版本一致</p>
<p><img src="/images/211203/Image%20%5B4%5D.png" alt=""></p>
<p>运行后成功将文件中标注了<em>Noncompliant</em>的位置标记了出来，有关XPath表达式可以参考<a href="https://www.apiref.com/java11-zh/java.xml/javax/xml/xpath/package-summary.html" target="_blank" rel="noopener">https://www.apiref.com/java11-zh/java.xml/javax/xml/xpath/package-summary.html</a></p>
<p>在我们的检测逻辑中，首先得确认这个文件是mybatis的配置文件，所以要校验”-//<a href="http://mybatis.org//DTD" target="_blank" rel="noopener">mybatis.org//DTD</a> Mapper 3.0//EN” “<a href="http://mybatis.org/dtd/mybatis-3-mapper.dtd”两个DOCTYPE值" target="_blank" rel="noopener">http://mybatis.org/dtd/mybatis-3-mapper.dtd”两个DOCTYPE值</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String DTD_PUBLIC_ID = <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String DTD_SYSTEM_ID = <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(XmlFile xmlFile)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!xmlFile.getDocument().getDoctype().getPublicId().equalsIgnoreCase(DTD_PUBLIC_ID)</span><br><span class="line">            || !xmlFile.getDocument().getDoctype().getSystemId().equalsIgnoreCase(DTD_SYSTEM_ID)</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来可以将目标定得简单一些，例如找到SQL语句中存在使用$符号的位置。要达到这个目的，需要的步骤是在满足之前条件的前提下，在有SQL语句的标签中找到有使用$拼接符的位置<br>依照上述的步骤得到以下检测逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span>(key = <span class="string">"XMLMybatisSQLIRule"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XMLMybatisSQLIRule</span> <span class="keyword">extends</span> <span class="title">SonarXmlCheck</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DTD_PUBLIC_ID = <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String DTD_SYSTEM_ID = <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; SQL_METHOD_LIST = <span class="keyword">new</span> ArrayList(Arrays.asList(</span><br><span class="line">            <span class="string">"select"</span></span><br><span class="line">            ,<span class="string">"insert"</span></span><br><span class="line">            ,<span class="string">"update"</span></span><br><span class="line">            ,<span class="string">"delete"</span></span><br><span class="line">            ,<span class="string">"if"</span></span><br><span class="line">            ,<span class="string">"sql"</span></span><br><span class="line">    ));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String MYBATIS_SQL_MATCH = <span class="string">"\\$\\&#123;(\\d|\\w)+\\&#125;"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Pattern MYBATIS_SQL_MATCHER = Pattern.compile(MYBATIS_SQL_MATCH);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(XmlFile xmlFile)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!xmlFile.getDocument().getDoctype().getPublicId().equalsIgnoreCase(DTD_PUBLIC_ID)</span><br><span class="line">                || !xmlFile.getDocument().getDoctype().getSystemId().equalsIgnoreCase(DTD_SYSTEM_ID)</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        visitNode(xmlFile.getDocument());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">visitNode</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        List&lt;Node&gt; children = XmlFile.children(node);</span><br><span class="line">        <span class="keyword">if</span> (SQL_METHOD_LIST.contains(node.getNodeName().toLowerCase())) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Node childrenNode:</span><br><span class="line">                 children) &#123;</span><br><span class="line">                <span class="keyword">if</span> (childrenNode.getNodeName().equalsIgnoreCase(<span class="string">"#text"</span>)) &#123;</span><br><span class="line">                    Matcher m = MYBATIS_SQL_MATCHER.matcher(childrenNode.getTextContent());</span><br><span class="line">                    <span class="keyword">if</span> (m.find()) &#123;</span><br><span class="line">                        reportIssue(childrenNode,<span class="string">"found sql!"</span>);</span><br><span class="line">                        System.out.println(<span class="string">"found sql!"</span>);</span><br><span class="line">                        System.out.println(childrenNode.getNodeName());</span><br><span class="line">                        System.out.println(childrenNode.getTextContent());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        children.forEach(<span class="keyword">this</span>::visitNode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于不需要用到SimpleXPathBasedCheck中的方法，我将父类直接换成了SonarXmlCheck。在确认了当前文件是mybatis配置文件后，获取当前文件的节点并获取所有子节点，检测select、insert、update、delete、if、sql标签中的子节点，如果子节点是#text字符类型且子节点中的语句包含${…}则认为这个语句书写不规范，最后对子节点进行递归处理。<br>随后在测试中可以确定，此规则可以探测配置文件中使用$拼接的语句。</p>
<p><img src="/images/211203/Image%20%5B5%5D.png" alt=""></p>
<p><img src="/images/211203/Image%20%5B6%5D.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/11/08/sonar%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E5%85%A5%E9%97%A8%E9%9A%8F%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/08/sonar%E8%87%AA%E5%AE%9A%E4%B9%89%E8%A7%84%E5%88%99%E5%85%A5%E9%97%A8%E9%9A%8F%E8%AE%B0/" class="post-title-link" itemprop="url">sonar自定义规则入门随记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-11-08 17:22:40 / 修改时间：18:07:57" itemprop="dateCreated datePublished" datetime="2021-11-08T17:22:40+08:00">2021-11-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文记录有关sonar自定义规则的入门。</p>
<p>sonar自定义功能是以插件的形式进行集成附加的，其自定义功能非常丰富，包括前后端功能都能实现自定义，这里只讨论有关代码扫描规则的自定义（Java）。</p>
<p>这里我根据官方指引进行入门（<a href="https://docs.sonarqube.org/latest/extend/adding-coding-rules/）" target="_blank" rel="noopener">https://docs.sonarqube.org/latest/extend/adding-coding-rules/）</a></p>
<p><img src="/images/211108/Image%20.png" alt=""></p>
<p>在官方文档的 for Java链接中，有custom rules一栏，其中指明可以在<a href="https://redirect.sonarsource.com/doc/java-custom-rules-guide.html" target="_blank" rel="noopener">Writing Custom Java Rules 101</a>了解自定义Java规则，后续我们依照这个文档指引一步一步进行自定义规则的入门。</p>
<p>按照文档提示克隆sonar-java项目，并将其中的<a href="https://github.com/SonarSource/sonar-java/tree/master/docs/java-custom-rules-example" target="_blank" rel="noopener">java-custom-rules-examples</a>模块导入IDE中，随后对项目进行初始化。</p>
<p>我使用使用7.9版本的sonar测试，所以使用pom_SQ_7_9_LTS.xml替换pom.xml中的内容并执行 mvn clean install 初始化项目，这里推荐使用JDK11运行maven，因为这是sonar7.9默认的运行环境，我们需要确保开发环境与运行环境一致以免遇到问题。</p>
<p><img src="/images/211108/Image%20%5B1%5D.png" alt=""></p>
<p>然后我们需要将sonar7.9 的 Java Analyzer 插件更新到6.3.2.22818版本，这是pom.xml中依赖的版本，sonar7.9默认版本低于此版本。</p>
<p><img src="/images/211108/Image%20%5B2%5D.png" alt=""></p>
<p>随后我们根据文档指引编写自定义规则，这里不再和文档一样一步步展示，直接贴出完成后的结果，若需要可以在文档中查看作者的详细叙述。</p>
<p>在 /test/file/ 中创建一个待测试文件，注意// Noncompliant注释，这个注释标记了被探测代码的行位置，不加此标记将会导致测试抛出异常（也代表规则检测成功）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    MyClass(MyClass mc) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span>     <span class="title">foo1</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span>    <span class="title">foo2</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span>     <span class="title">foo3</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125; <span class="comment">// Noncompliant</span></span><br><span class="line">    <span class="function">Object  <span class="title">foo4</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">null</span>; &#125;</span><br><span class="line">    <span class="function">MyClass <span class="title">foo5</span><span class="params">(MyClass value)</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">null</span>; &#125; <span class="comment">// Noncompliant</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span>     <span class="title">foo6</span><span class="params">(<span class="keyword">int</span> value, String name)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span>     <span class="title">foo7</span><span class="params">(<span class="keyword">int</span> ... values)</span> </span>&#123; <span class="keyword">return</span> <span class="number">0</span>;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完成待检测文件后，编写规则，这个练习规则代表找到只有一个入参且参数与返回的类型相同的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span>(key = <span class="string">"MyFirstCustomRule"</span>) <span class="comment">// 规则关键字，唯一标示</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFirstCustomCheck</span> <span class="keyword">extends</span> <span class="title">IssuableSubscriptionVisitor</span> </span>&#123; <span class="comment">// 规则需要实现或继承sonar扫描器类</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Kind&gt; <span class="title">nodesToVisit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Collections.singletonList(Kind.METHOD); <span class="comment">// 指定要检测的节点，此处指定检测所有方法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitNode</span><span class="params">(Tree tree)</span> </span>&#123;</span><br><span class="line">        MethodTree method = (MethodTree) tree; <span class="comment">// 将节点树转型为方法</span></span><br><span class="line">        <span class="keyword">if</span> (method.parameters().size() == <span class="number">1</span>) &#123; <span class="comment">// 如果方法传入一个参数</span></span><br><span class="line">            Symbol.MethodSymbol symbol = method.symbol(); <span class="comment">// 获取方法表示</span></span><br><span class="line">            Type firstParameterType = symbol.parameterTypes().get(<span class="number">0</span>); <span class="comment">// 获取方法第一个参数（实际上只有一个）的类型</span></span><br><span class="line">            Type returnType = symbol.returnType().type(); <span class="comment">// 获取方法返回类型</span></span><br><span class="line">            <span class="keyword">if</span> (returnType.is(firstParameterType.fullyQualifiedName())) &#123; <span class="comment">// 判断两者是否相同</span></span><br><span class="line">                reportIssue(method.simpleName(), <span class="string">"Never do that!"</span>); <span class="comment">// 报出issue</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后编写单元测试文件测试这个规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFirstCustomCheckTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JavaCheckVerifier.newVerifier()</span><br><span class="line">                .onFile(<span class="string">"src/test/files/MyFirstCustomCheck.java"</span>)</span><br><span class="line">                .verifyIssues();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试执行通过后代表规则已经能达到预期的检测效果了，这时候只要将规则注册到插件中并将插件安装到sonar上即可。</p>
<p>根据官方示例文档 Registering the rule in the custom plugin 章节步骤，我们首先编写一个MyJavaRulesDefinition（示例中已经存在）定义规则配置JSON的位置，然后在RulesList（示例中已经存在）中将我们编写的rule的class添加进来，最后定义规则配置JSON，JSON的命名要和@Rule中声明的关键字相同，JSON配置中主要配置了这个规则的标题、类型（bug、漏洞等）、状态、标签、默认等级等属性。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"Return type and parameter of a method should not be the same"</span>,</span><br><span class="line">  <span class="attr">"type"</span>: <span class="string">"Bug"</span>,</span><br><span class="line">  <span class="attr">"status"</span>: <span class="string">"ready"</span>,</span><br><span class="line">  <span class="attr">"tags"</span>: [</span><br><span class="line">    <span class="string">"bugs"</span>,</span><br><span class="line">    <span class="string">"gandalf"</span>,</span><br><span class="line">    <span class="string">"magic"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"defaultSeverity"</span>: <span class="string">"Critical"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此外还可以编写和配置文件同名的HTML文件作为规则详情页，例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>This rule detects usage of java.util.Random and scala.util.Random<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Noncompliant Code Example<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">public class Vuln &#123;</span><br><span class="line">    public void foo() &#123;</span><br><span class="line">        Random random = new Random();</span><br><span class="line">        random.nextInt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Compliant Solution<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pre</span>&gt;</span></span><br><span class="line">public class NoVuln &#123;</span><br><span class="line">    public void foo() &#123;</span><br><span class="line">        SecureRandom random = new SecureRandom();</span><br><span class="line">        byte bytes[] = new byte[20];</span><br><span class="line">        random.nextBytes(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>效果如下</p>
<p><img src="/images/211108/Image%20%5B3%5D.png" alt=""></p>
<p>在这个页面上可以自有定义和规则相关的描述说明等内容。</p>
<p>再用一个其他例子讲一下规则编写，假设我们想检测以下几种执行命令的情况</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecTest</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runtime runtime = Runtime.getRuntime();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            runtime.exec(<span class="keyword">new</span> String[]&#123;<span class="string">"cmd"</span>, <span class="string">"/c"</span>, <span class="string">"calc"</span>, <span class="string">"&amp;"</span>, <span class="string">"notepad"</span>&#125;); <span class="comment">// Noncompliant</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">"asd"</span>); <span class="comment">// Noncompliant</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processBuilderTest</span><span class="params">()</span></span>&#123;</span><br><span class="line">        ProcessBuilder processBuilder = <span class="keyword">new</span> ProcessBuilder(<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>, <span class="string">"calc"</span>, <span class="string">"&amp;"</span>, <span class="string">"notepad"</span>); <span class="comment">// Noncompliant</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process start = processBuilder.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scriptEngineManagerTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object result = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result = <span class="keyword">new</span> ScriptEngineManager().getEngineByExtension(<span class="string">"js"</span>).eval(<span class="string">"java.lang.Runtime.getRuntime().exec(\"calc\")"</span>); <span class="comment">// Noncompliant</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ScriptException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们编写以下规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span>(key = <span class="string">"CommendInjectExecRule"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommendInjectExecRule</span> <span class="keyword">extends</span> <span class="title">BaseTreeVisitor</span> <span class="keyword">implements</span> <span class="title">JavaFileScanner</span> </span>&#123; <span class="comment">// 继承BaseTreeVisitor实现遍历Java AST 树结构，实现JavaFileScanner实现扫描Java功能</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RUNTIME = <span class="string">"java.lang.Runtime"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MethodMatchers RUNTIME_METHOD_MATCHERS = MethodMatchers.create() <span class="comment">// 方法匹配器</span></span><br><span class="line">            .ofTypes(RUNTIME)                                                             <span class="comment">// 定义方法匹配器类型</span></span><br><span class="line"><span class="comment">//            .names("getRuntime","exec")</span></span><br><span class="line">            .names(<span class="string">"exec"</span>)                                                                <span class="comment">// 定义方法匹配器方法名</span></span><br><span class="line">            .withAnyParameters()                                                          <span class="comment">// 定义方法匹配器参数</span></span><br><span class="line">            .build();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SCRIPT_ENGINE = <span class="string">"javax.script.ScriptEngine"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MethodMatchers SCRIPT_ENGINE_METHOD_MATCHERS = MethodMatchers.create()</span><br><span class="line">            .ofTypes(SCRIPT_ENGINE)</span><br><span class="line">            .names(<span class="string">"eval"</span>)</span><br><span class="line">            .withAnyParameters()</span><br><span class="line">            .build();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROCESS_BUILDER = <span class="string">"java.lang.ProcessBuilder"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MethodMatchers PROCESS_BUILDER_METHOD_MATCHERS = MethodMatchers.create()</span><br><span class="line">            .ofTypes(PROCESS_BUILDER)</span><br><span class="line">            .constructor()</span><br><span class="line">            .withAnyParameters()</span><br><span class="line">            .build();</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;MethodMatchers&gt; METHOD_INVOCATION_LIST = <span class="keyword">new</span> ArrayList(Arrays.asList(</span><br><span class="line">            RUNTIME_METHOD_MATCHERS</span><br><span class="line">            ,SCRIPT_ENGINE_METHOD_MATCHERS</span><br><span class="line">    ));</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;MethodMatchers&gt; NEW_CLASS_LIST = <span class="keyword">new</span> ArrayList(Arrays.asList(</span><br><span class="line">            PROCESS_BUILDER_METHOD_MATCHERS</span><br><span class="line">    ));</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> JavaFileScannerContext context;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scanFile</span><span class="params">(JavaFileScannerContext context)</span> </span>&#123; <span class="comment">// 重写实现Java文件扫描，扫描树结构</span></span><br><span class="line">        <span class="keyword">this</span>.context = context;</span><br><span class="line">        scan(context.getTree());</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitMethodInvocation</span><span class="params">(MethodInvocationTree tree)</span> </span>&#123; <span class="comment">// 重写实现对方法调用的扫描</span></span><br><span class="line">        <span class="keyword">for</span> (MethodMatchers methodMatchers :</span><br><span class="line">                METHOD_INVOCATION_LIST) &#123;</span><br><span class="line">            <span class="keyword">if</span> (methodMatchers.matches(tree.symbol())) &#123; <span class="comment">// 检测每个方法是否被匹配器命中</span></span><br><span class="line">                context.reportIssue(<span class="keyword">this</span>,tree,<span class="string">"Don`t execute system commend in Java code"</span>); <span class="comment">// 报告issue</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.visitMethodInvocation(tree);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitNewClass</span><span class="params">(NewClassTree tree)</span> </span>&#123; <span class="comment">// 重写实现NewClass扫描</span></span><br><span class="line">        <span class="keyword">for</span> (MethodMatchers methodMatchers :</span><br><span class="line">                NEW_CLASS_LIST) &#123;</span><br><span class="line">            <span class="keyword">if</span> (methodMatchers.matches(tree)) &#123;</span><br><span class="line">                context.reportIssue(<span class="keyword">this</span>,tree,<span class="string">"Don`t execute system commend in Java code"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.visitNewClass(tree);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个方法通过定义三个方法匹配器，重写方法调用以及new class的检测实现了对三种命令执行的检测。其他的规则也可以通过各种方法实现，可以参考sonar-java规则中的实现，在sonar后台搜索想了解的规则并使用title在代码中搜索对应的配置文件即可。</p>
<p>最后要注意一点 ，在自定义规则中只能使用<a href="https://github.com/SonarSource/sonar-java/tree/6.13.0.25138/java-frontend/src/main/java/org/sonar/plugins/java/api" target="_blank" rel="noopener">org.sonar.plugins.java.api</a>包中的类，已经实现的官方插件无法调用，在开发时可能会测试通过，但在sonar上运行时会报ClassNotFound，所以无法通过直接引入现有插件包来获得现有插件的能力，详见<a href="https://github.com/SonarSource/sonar-java/blob/master/docs/CUSTOM_RULES_101.md#what-you-can-use-and-what-you-cant。" target="_blank" rel="noopener">https://github.com/SonarSource/sonar-java/blob/master/docs/CUSTOM_RULES_101.md#what-you-can-use-and-what-you-cant。</a></p>
<p><img src="/images/211108/Image%20%5B4%5D.png" alt=""></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/12/%E7%81%AB%E7%BA%BF%E6%B4%9E%E6%80%81IAST%E7%AE%80%E5%8D%95%E8%AF%95%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/12/%E7%81%AB%E7%BA%BF%E6%B4%9E%E6%80%81IAST%E7%AE%80%E5%8D%95%E8%AF%95%E7%94%A8/" class="post-title-link" itemprop="url">火线洞态IAST简单试用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-10-12 16:44:17 / 修改时间：16:49:42" itemprop="dateCreated datePublished" datetime="2021-10-12T16:44:17+08:00">2021-10-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>试用了洞态的开源IAST，有些坑，记录记录。</p>
<p>首先在21年中，火线就开源了Java agent探针，可配合在线平台使用，企业也可申请获取源码本地使用，在完全开源后文档存在许多的不一致，导致我看一会楞是没看懂。官方文档中的最佳实践也是那时候的，有些许区别，这里我就记个流水账。</p>
<p>出于学习平台功能的目的首先推荐直接用官方写好的docker脚本进行安装，简单快捷又傻瓜，GitHub上deploy项目就是，我由于机器端口冲突改了个web端口。</p>
<p><img src="/images/211012/iast/Image.png" alt=""></p>
<p>接下来默认密码进入web应用，配置API，注意不要使用回环地址！我第一次使用了回环地址，发生了应用卡死agent生成错误等情况，不信可以看agent生成的命令，看了马上就懂为什么不能用回环地址。</p>
<p><img src="/images/211012/iast/Image%20%5B1%5D.png" alt=""></p>
<p>随便创建一个应用，建议用英文名，在插桩时可选择应用名，个人感觉中文名可能会带来编码问题，所以我在启动时没有带应用名参数，参数可以参考官方文档</p>
<p><img src="/images/211012/iast/Image%20%5B2%5D.png" alt=""></p>
<p>由于我没有设置项目名称所以我为项目手动设置了探针</p>
<p><img src="/images/211012/iast/Image%20%5B3%5D.png" alt=""></p>
<p>接下来从后台下载agent，并验证一下，这里我使用IDEA运行项目，这样比较方便，添加完启动参数后就能在输出中看到相关的信息了</p>
<p><img src="/images/211012/iast/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B5%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B6%5D.png" alt=""></p>
<p>运行项目后我们回到管理后台给项目添加这个agent，写了项目名的话就不用配置了，这里推荐写项目名，否则agent的名字会一样，不易于区分</p>
<p>在引擎管理中我们就能看到这个agent了，项目中SCA功能可以看到相关的组件信息</p>
<p><img src="/images/211012/iast/Image%20%5B7%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B8%5D.png" alt=""></p>
<p>为了方便测试，我直接在项目中写了个注入</p>
<p><img src="/images/211012/iast/Image%20%5B9%5D.png" alt=""></p>
<p>测试了一下失败了，愣住，又试了几次还是不行，看了下日志个人感觉和一个第三方类覆盖失败有关系，于是我又搞了个demo同样写了个order by 拼接注入，成功检测到了</p>
<p><img src="/images/211012/iast/Image%20%5B10%5D.png" alt=""></p>
<p>关于运行时attach，我这报错了，因为我的双Java环境使用的是jre而不是jdk，改成JDK环境就行，注意这种方式目前还不能添加项目名，需要手动给项目配置agent</p>
<p><img src="/images/211012/iast/Image%20%5B11%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B12%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B13%5D.png" alt=""></p>
<p><img src="/images/211012/iast/Image%20%5B14%5D.png" alt=""></p>
<p>先记到这儿其他后续再记录</p>
<p>再记个遇到的问题，打算用webgoat测试一下，但是我下载的8.1.0需要JDK11而OpenJDK11（MacOS）中我没有找到tools.jar，根据代码没有这个jar是无法启动的；在Stack Overflow上看到说9开始这个包就没有了，</p>
<p><a href="https://stackoverflow.com/questions/53707666/how-to-get-tools-jar-for-openjdk-11-on-windows" target="_blank" rel="noopener">https://stackoverflow.com/questions/53707666/how-to-get-tools-jar-for-openjdk-11-on-windows</a></p>
<p><img src="/images/211012/iast/Image%20%5B15%5D.png" alt=""></p>
<p>补充一下，还是启动成功了retransform失败的类有不少，在xml测试报错后agent掉线了</p>
<p>再就是我测试一个springboot项目遇到retransform netty失败并且过一会agent就下线了，原因未知；</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/12/Gitlab-CI-CD%E9%9A%8F%E6%89%8B%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/12/Gitlab-CI-CD%E9%9A%8F%E6%89%8B%E8%AE%B0/" class="post-title-link" itemprop="url">Gitlab CI/CD随手记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-10-12 16:38:36 / 修改时间：16:43:12" itemprop="dateCreated datePublished" datetime="2021-10-12T16:38:36+08:00">2021-10-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>想用Gitlab 自动触发sonar，这就涉及到Gitlab CI/CD，随手记录一下。</p>
<p>安装runner</p>
<p>Gitlab使用runner来运行流水线事务，这种可拓展的事务模式可以让Gitlab不会受其所在服务器资源性能的限制。这里我使用docker安装一个runner，在CI/CD设置中有链接，跟着走就可以，在安装后还有注册过程，注册用到的地址与token在设置页面中有，注意，这样注册以后这个runner是这个project的特有runner，再注意，请仔细阅读文档。</p>
<p><img src="/images/211012/gitlab_ci_cd/Image.png" alt=""></p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B1%5D.png" alt=""></p>
<p>在安装、注册完成后，可以设置一下允许运行没有标签的job，或者在编写事务时要使用runner设置的tag，lock to current project也可以去掉，这样这个runner就可以被其他project使用了</p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B2%5D.png" alt=""></p>
<p>根据sonar文档，在项目中要设置变量记录sonar的token与地址，设置位于settings-CI/CD-variables，可参考<a href="https://docs.sonarqube.org/8.5/analysis/gitlab-cicd/" target="_blank" rel="noopener">sonar doc</a> 我参考的是8.5的doc可以根据版本需要参考对应doc</p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B3%5D.png" alt=""></p>
<p>后续直接在sonar抄一个.gitlab-ci.yml就可以咯，我们也可以设置更多脚本比如运行py脚本等来丰富任务。这里要注意社区版的Gitlab只能支持一个分支的事务可以新建也可以在主分支上执行事务，而且创建者必须是project的所有者。等事务运行完成我们就可以在sonar上查看了，注意要运行自定义规则需要在项目第一次运行后在sonar上进行设置，目前我没有找到可以初次运行指定规则的方法。</p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B5%5D.png" alt=""></p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B6%5D.png" alt=""></p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B7%5D.png" alt=""></p>
<p>maven遇到的问题</p>
<p>因为sonar扫描maven项目时需要用maven进行编译，所以脚本中指定了一个maven镜像可以根据需要在docker hub中选择，配置文件中是默认的镜像在脚本中可以进行复写，但是有些依赖是在私有环境中才有的，那就需要修改settings.xml文件。这里可以修改config.toml，我将settings上传到docker的宿主机（注意，是docker宿主机，因为我在安装runner时使用的是docker volume 挂载了一个空间到容器中，所以这里/workspace对应docker宿主机的空间，/root/workspace代表脚本中拉取maven镜像的空间，详情见<a href="https://docs.gitlab.com/runner/install/docker.html#option-2-use-docker-volumes-to-start-the-runner-container）中的workspace文件夹下，并进行设置。" target="_blank" rel="noopener">https://docs.gitlab.com/runner/install/docker.html#option-2-use-docker-volumes-to-start-the-runner-container）中的workspace文件夹下，并进行设置。</a></p>
<p><img src="/images/211012/gitlab_ci_cd/Image%20%5B8%5D.png" alt=""></p>
<p>然后重启容器使配置生效，在事务上加上指定settings文件，运行job即可。</p>
<p>参考：</p>
<p><a href="https://www.cnblogs.com/kanyun/p/14700624.html" target="_blank" rel="noopener">https://www.cnblogs.com/kanyun/p/14700624.html</a></p>
<p><a href="https://docs.gitlab.com/runner/install/docker.html" target="_blank" rel="noopener">https://docs.gitlab.com/runner/install/docker.html</a></p>
<p><a href="https://docs.gitlab.com/runner/register/index.html#docker" target="_blank" rel="noopener">https://docs.gitlab.com/runner/register/index.html#docker</a></p>
<p><a href="https://docs.sonarqube.org/8.5/analysis/gitlab-cicd/" target="_blank" rel="noopener">https://docs.sonarqube.org/8.5/analysis/gitlab-cicd/</a></p>
<p><a href="https://docs.sonarqube.org/latest/analysis/gitlab-integration/" target="_blank" rel="noopener">https://docs.sonarqube.org/latest/analysis/gitlab-integration/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">0xSky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">0xSky</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
